(this["webpackJsonpdl-model"]=this["webpackJsonpdl-model"]||[]).push([[33,41],{163:function(e,t,n){"use strict";n.r(t);var a=n(13),r=n(64),i=n(43),o=n(148),c=n.n(o),s=n(149),u=n(3),d=n(7),l=n(4),p=n(5),f=n(10),m=n(0),h=n(1),v=n(179),b=n(9),x=n(22),w=n(42),O=function(e){Object(l.a)(o,e);var t=Object(p.a)(o);function o(){var e;Object(u.a)(this,o);for(var d=arguments.length,l=new Array(d),p=0;p<d;p++)l[p]=arguments[p];return(e=t.call.apply(t,[this].concat(l))).disableInput=function(){return e.props.setIsLoading(!0)},e.enableInput=function(){return e.props.setIsLoading(!1)},e.initialize=Object(s.a)(c.a.mark((function t(){var n,a;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.disableInput(),e.initScene(),e.materials=[],e.outlines={},e.models={},e.modelInfo={},t.next=8,e.loadMainModel();case 8:return t.next=10,null===(n=(a=e).afterMainModelLoad)||void 0===n?void 0:n.call(a);case 10:e.enableInput();case 11:case"end":return t.stop()}}),t)}))),e.initScene=function(){var t,n;e.viewport=e.props.viewport||{width:window.innerWidth,height:window.innerHeight},e.clock=new h.Clock,e.scene=new h.Scene,e.bgColor=e.props.bgColor,e.floor=Object(w.l)(),e.scene.add(e.floor),e.camera=new h.PerspectiveCamera(b.a.angle,e.viewport.width/e.viewport.height,b.a.near,b.a.far),e.cameraPosition=e.props.cameraPosition||[2,0,10],(t=e.camera.position).set.apply(t,Object(i.a)(e.cameraPosition)),e.camera.updateProjectionMatrix(),e.controls=new v.a(e.camera,e.mount),e.controlsPosition=e.props.controlsPosition||[0,0,0],(n=e.controls.target).set.apply(n,Object(i.a)(e.controlsPosition)),e.controls.update();var a=e.props.lights;e.addLights(a),e.loadedFX=new Map,e.rendererAA=new h.WebGLRenderer({antialias:!0,alpha:!0}),e.rendererAA.outputEncoding=h.sRGBEncoding,e.rendererNoAA=new h.WebGLRenderer({antialias:!1,alpha:!0}),e.rendererNoAA.outputEncoding=h.sRGBEncoding;var r=e.props.antiAliasing;e._AA=r,e.renderer=r?e.rendererAA:e.rendererNoAA,e.finalRenderer=e.renderer;var o=e.props.viewport,c=o.width,s=o.height;e.finalRenderer.setSize(c,s);var u=e.finalRenderer.domElement;e.canvas=u,e.animate()},e.loadMainModel=Object(s.a)(c.a.mark((function t(){var n,a,r;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.props.model.id,e.modelInfo.main=n,a=Object(w.t)(n),t.next=5,Object(w.w)(a);case 5:return r=t.sent,e.models.main=r,e.basicMainProcessing(r),t.abrupt("return");case 9:case"end":return t.stop()}}),t)}))),e.addLights=function(t){e.lights=[],t.forEach((function(t){var n,o=t.enable,c=t.type,s=t.color,u=t.intensity,d=Object(r.a)(t,["enable","type","color","intensity"]);if(o){for(var l="".concat(c,"Light"),p=new h[l](s,u),f=0,m=Object.entries(d);f<m.length;f++){var v=Object(a.a)(m[f],2),b=v[0],x=v[1];switch(b){case"position":var w=x.map((function(e){return e||0}));(n=p.position).set.apply(n,Object(i.a)(w));break;default:p[b]=x}}e.scene.add(p),e.lights.push(p)}}))},e.removeLights=function(){return e.lights.forEach((function(t){return e.scene.remove(t)}))},e.addToScene=function(t){return e.floor.add(t)},e.basicMainProcessing=function(){var t=e.models.main;Object(w.x)(t);var n=e.props.model.materialType,a=e.props.model.id;if(Object(x.o)(a)){var r=Object(w.b)("".concat(a,"n")).texturePath;Object(w.k)(t,{materialType:n,texturePath:r})}else Object(w.k)(t,{materialType:n,forced:!0});e.applyNewModelMat(t);var i=e.props.outline;e.outlines.main=Object(w.m)(t,i),e.addToScene(t)},e.updateViewer=function(t,n){var a,r;e.updateEnvironment(t,n),e.updateModel(t,n),null===(a=(r=e).otherUpdate)||void 0===a||a.call(r,t,n)},e.updateEnvironment=function(t,n){e.updateViewport(t.viewport,n.viewport),e.updateOutline(t.outline,n.outline),e.updateMaterial(t,n),e.updateLights(t.lights,n.lights),e.updateAscii(t.ascii,n.ascii),t.bgColor!==n.bgColor&&(e.bgColor=n.bgColor),e.AA=n.antiAliasing},e.updateModel=function(t,n){e.updateMainModel(t.model,n.model)},e.updateViewport=function(t,n){var a=n.width,r=n.height;t.width===a&&t.height===r||(e.viewport.width=a,e.viewport.height=r,e.finalRenderer.setSize(a,r),e.camera.aspect=a/r,e.camera.updateProjectionMatrix())},e.disposeMainModel=function(){var t=e.models.main;e.floor.remove(t),Object(w.n)(t)},e.replaceMainModel=Object(s.a)(c.a.mark((function t(){return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.disableInput(),e.disposeMainModel(),t.next=4,e.loadMainModel();case 4:e.applyNewModelMat(e.models.main),e.enableInput();case 6:case"end":return t.stop()}}),t)}))),e.updateMainModel=function(){var t=Object(s.a)(c.a.mark((function t(n,a){var r,i,o,s,u;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(u=a.id,n.id!==u){t.next=4;break}return t.abrupt("return");case 4:return null===(r=(i=e).beforeMainModelUpdate)||void 0===r||r.call(i),t.next=7,e.replaceMainModel();case 7:null===(o=(s=e).afterMainModelUpdate)||void 0===o||o.call(s);case 8:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),e.updateOutlineParams=function(t){Object.values(e.outlines).flat().forEach((function(e){Object(w.g)(e,t)}))},e.updateOutline=function(t,n){if(t!==n){var a=Object.keys(n).filter((function(e){return t[e]!==n[e]}));if(0!==a.length){var r=new Map(a.map((function(e){return[e,n[e]]})));e.updateOutlineParams(r)}}},e.saveMaterialReference=function(){var t=e.models.main;e.materials=Object(w.s)(t)},e.applyNewModelMat=function(t){var n=e.matParams;Object(w.y)(t,{prevParams:{useTexture:!0},params:n})},e.updateMaterial=function(t,n){if(t!==n){var a=n.model.materialType,r=e.models.main,i=t.materialParams;t.model.materialType!==a&&Object(w.k)(e.models.main,{materialType:a});var o=e.matParams;Object(w.y)(r,{prevParams:i,params:o})}},e.updateLights=function(t,n){t!==n&&(e.removeLights(),e.addLights(n))},e.updateAscii=function(){var t=Object(s.a)(c.a.mark((function t(a,r){var i,o,s;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Object.keys(a).some((function(e){return a[e]!==r[e]}))){t.next=3;break}return t.abrupt("return");case 3:if(r.enable){t.next=9;break}return e.finalRenderer=e.renderer,i=e.renderer.domElement,e.canvas=i,t.abrupt("return");case 9:if(e.loadedFX.has("ascii")){t.next=18;break}return t.next=12,n.e(48).then(n.bind(null,186));case 12:o=t.sent,s=o.AsciiEffect,e.loadedFX.set("ascii",s),e.showAscii(),t.next=19;break;case 18:e.showAscii();case 19:e.finalRenderer.setSize(e.viewport.width,e.viewport.height);case 20:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),e.showAscii=function(){var t=e.props.ascii,n=t.charSet,a=t.color,r=t.bgColor,i=t.invert,o=e.loadedFX.get("ascii");e.effect=new o(e.renderer,n,{invert:i});var c=e.viewport,s=c.width,u=c.height;e.effect.setSize(s,u);var d=e.effect.domElement;d.style.color=a,d.style.background=r,e.canvas=d,e.finalRenderer=e.effect},e.rotateFloor=function(t){var n=e.props.rotateSpeed;if(n){var a=n*t*Math.PI/2;e.floor.rotateY(a)}},e.everyAnimate=function(){var t=e.clock.getDelta();e.rotateFloor(t)},e.animate=function(){e.frameId=requestAnimationFrame(e.animate),e.everyAnimate(),e.finalRenderer.render(e.scene,e.camera)},e}return Object(d.a)(o,[{key:"componentDidMount",value:function(){var e=Object(s.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return window.app=this,e.next=3,this.initialize();case 3:this.finishedInit=!0;case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"componentDidUpdate",value:function(e){if(this.finishedInit){var t=this.props;console.log("Updated"),Object(w.v)(e,t).forEach((function(t){var n=Object(a.a)(t,2),r=n[0],i=n[1],o=e[r],c=Object.keys(i);0===c.length||"string"===typeof i?console.log("".concat(r,": ").concat(JSON.stringify(o)," to ").concat(JSON.stringify(i))):c.forEach((function(e){o[e]!==i[e]&&console.log("".concat(r,".").concat(e,": ").concat(JSON.stringify(o[e])," to ").concat(JSON.stringify(i[e])))}))})),this.updateViewer(e,t)}}},{key:"componentWillUnmount",value:function(){cancelAnimationFrame(this.frameId),Object(w.n)(this.scene),this.mixer=null,this.clock=null,this.camera=null,this.controls=null,this.scene=null,this.renderer=null,this.rendererAA.renderLists.dispose(),this.rendererAA.dispose(),this.rendererAA=null,this.rendererNoAA.renderLists.dispose(),this.rendererNoAA.dispose(),this.rendererNoAA=null}},{key:"render",value:function(){var e=this;return Object(f.jsx)("div",{ref:function(t){e.mount=t}})}},{key:"AA",set:function(e){if(e!==this._AA){this._AA=e,this.renderer=e?this.rendererAA:this.rendererNoAA;var t=this.viewport,n=t.width,a=t.height;if(this.renderer.setSize(n,a),!this.props.ascii.enable){this.finalRenderer=this.renderer;var r=this.renderer.domElement;this.canvas=r}}}},{key:"matParams",get:function(){var e=this.props.materialParams,t=this.props.model.materialType,n=Object(w.u)(t);return Object(w.o)(e,n)}},{key:"bgColor",set:function(e){this.scene.background="transparent"!==e?new h.Color(e):null}},{key:"canvas",set:function(e){var t=this._canvas;t&&this.mount.removeChild(t),this.mount.appendChild(e),this._canvas=e},get:function(){return this._canvas}}]),o}(m.PureComponent);t.default=O},180:function(e,t,n){"use strict";var a=n(13),r=n(148),i=n.n(r),o=n(149),c=n(3),s=n(7),u=n(30),d=n(4),l=n(5),p=n(163),f=n(1),m=n(35),h=n(42),v=function(e){Object(d.a)(n,e);var t=Object(l.a)(n);function n(){var e;return Object(c.a)(this,n),(e=t.call(this)).afterMainModelLoad=function(){e.saveMainModelInitState(),e.addAnimation()},e.afterMainModelUpdate=function(){e.saveMainModelInitState(),e.addAnimation()},e.updateModel=function(){var t=Object(o.a)(i.a.mark((function t(n,a){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.updateMainModel(n.model,a.model);case 2:e.updateAnimation(n.animation,a.animation);case 3:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),e.otherUpdate=function(t,n){n.capture.enable&&!t.capture.enable&&e.captureAnimation()},e.saveMainModelInitState=function(){var t=e.models.main;t.initPos=t.position.clone(),t.initRot=t.rotation.clone()},e.resetFace=function(){var t=e.props.model,n=t.eyeIdx,a=t.mouthIdx;e.eyeIdx=n,e.mouthIdx=a},e.beforeAddAni=function(){e.resetFace()},e.addAnimation=Object(o.a)(i.a.mark((function t(){var n,r,o,c,s,u,d,l,p,m,v,b;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===(n=(r=e).beforeAddAni)||void 0===n||n.call(r),o=e.props.animation,c=o.code,s=o.timeScale,c){t.next=4;break}return t.abrupt("return");case 4:return e.disableInput(),u=e.models.main,d=Object(h.a)(c),l=Object(a.a)(d,2),p=l[0],m=l[1],e.nAni=m.length,u.mixer=new f.AnimationMixer(u),e.mixer=u.mixer,e._aniIdx=0,u.mixer.timeScale=s,u.mixer.addEventListener("finished",e.playNextAni),e.aniSettings=m.map((function(e){return{timeScale:e.timeScale,repetitions:e.repetitions,faceChanges:e.faceChanges}})),v=p.map((function(t){var n="".concat(e.aniSource,"/").concat(t,".fbx");return Object(h.w)(n)})),t.next=17,Promise.all(v);case 17:b=t.sent,e.animations=[],m.forEach((function(t){var n=t.fileIdx,a=t.aniName,r=a?b[n].animations.find((function(e){return e.name===a})):b[n].animations[0];e.animations.push(r)})),e.aniIdx=0,e.enableInput();case 22:case"end":return t.stop()}}),t)}))),e.removeAnimation=function(){var t,n,a=e.models.main;null===(t=a.mixer)||void 0===t||null===(n=t.stopAllAction)||void 0===n||n.call(t);var r=a.initPos,i=a.initRot;a.position.copy(r),a.rotation.copy(i),e.mixer=null,e.animations=[],e.aniSettings=[]},e.playNextAni=function(){var t=Object(u.a)(e).nAni;e.props.capture.enable&&e._aniIdx===t-1&&(e.mediaRecorder.stop(),e.props.toggleCapture());var n=(e._aniIdx+1)%t;e.aniIdx=n},e.updateAnimation=function(t,n){var a=n.code,r=n.timeScale;if(t.code!==a)return e.removeAnimation(),void e.addAnimation();t.timeScale!==r&&(e.mixer.timeScale=r)},e.captureAnimation=function(){var t,n;if(e.chunks=[],e.videoStream=e.canvas.captureStream(30),!e.mediaRecorder){var a=e.props.capture.codec;e.mediaRecorder=new MediaRecorder(e.videoStream,{mimeType:a}),e.mediaRecorder.ondataavailable=function(t){return e.chunks.push(t.data)},e.mediaRecorder.onstop=function(){e.enableInput();var t=new Blob(e.chunks,{type:"video/webm"}),n=URL.createObjectURL(t),a=document.createElement("a");a.style="display: none",a.href=n,a.download="animation.webm",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(n),document.body.removeChild(a)}}e.disableInput(),null===(t=(n=e).beforeCaptureAnimation)||void 0===t||t.call(n),e.aniIdx=0,e.mediaRecorder.start()},e.everyAnimate=function(){var t,n=e.clock.getDelta();if((e.rotateFloor(n),null===(t=e.mixer)||void 0===t||t.update(n),e.faceChanges&&e.faceChanges.length)&&e.mixer.time>=e.faceChangeTime[0]){e.faceChangeTime.shift();var a=e.faceChanges.shift(),r=a.eyeIdx,i=a.mouthIdx;e.eyeIdx=r,e.mouthIdx=i}},e.aniSource="".concat(m.b,"/fbx"),e}return Object(s.a)(n,[{key:"aniIdx",set:function(e){var t=this;this._aniIdx=e;var n=this.mixer;n.stopAllAction();var a=this.animations[e],r=n.clipAction(a),i=this.aniSettings[e],o=i.timeScale,c=i.repetitions,s=i.faceChanges;r.setLoop(f.LoopRepeat,c),r.clampWhenFinished=!0,r.timeScale=o,r.time=0,this.faceChanges=Object(h.r)(s,c),this.faceChangeTime=this.faceChanges.map((function(e){return t.currentClipDuration*e.time/100})),n.setTime(0),this.currentClipDuration=a.duration,r.play()}}]),n}(p.default);t.a=v},450:function(e,t,n){"use strict";n.r(t),n.d(t,"CharaViewer",(function(){return v}));var a=n(13),r=n(148),i=n.n(r),o=n(149),c=n(3),s=n(7),u=n(4),d=n(5),l=n(180),p=n(35),f=n(9),m=n(42),h=["Right","Left"],v=function(e){Object(u.a)(n,e);var t=Object(d.a)(n);function n(){var e;return Object(c.a)(this,n),(e=t.call(this)).afterMainModelLoad=function(){e.saveMainModelInitState(),e.initFace(),e.addWeapons(),e.addAnimation()},e.beforeMainModelUpdate=function(){e.detachAllWeapons()},e.afterMainModelUpdate=function(){e.saveMainModelInitState(),e.initFace(),e.attachAllWeapons(),e.addAnimation()},e.updateModel=function(){var t=Object(o.a)(i.a.mark((function t(n,a){var r,o;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==a){t.next=2;break}return t.abrupt("return");case 2:if(r=n.model,o=a.model,r.id===o.id){t.next=9;break}return t.next=7,e.updateMainModel(r,o);case 7:t.next=10;break;case 9:e.updateFace(r,o);case 10:e.updateWeapons(r,o),e.updateAnimation(n.animation,a.animation);case 12:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),e.initFace=function(){var t=e.props.model.id,n={mouthTexture:t,mouthIdx:f.d,eyeTexture:t,eyeIdx:f.d};e.updateFace(n,e.props.model)},e.addWeapons=Object(o.a)(i.a.mark((function t(){var n,r,o,c;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.getWeaponInfo(),t.next=3,e.initWeaponLoad();case 3:return n=t.sent,r=Object(a.a)(n,2),o=r[0],c=r[1],e.models=Object.assign(e.models,{weaponRight:o,weaponLeft:c}),t.next=10,e.initAllWeapons();case 10:e.attachAllWeapons();case 11:case"end":return t.stop()}}),t)}))),e.getWeaponInfo=function(){var t=e.props.model,n=t.weaponRight,a=t.weaponLeft,r={weaponRight:Object(m.b)(n),weaponLeft:Object(m.b)(a)};e.modelInfo=Object.assign(e.modelInfo,r)},e.initWeaponLoad=function(){var t,n,a=null===(t=e.modelInfo.weaponRight)||void 0===t?void 0:t.modelPath,r=Object(m.w)(a),i=null===(n=e.modelInfo.weaponLeft)||void 0===n?void 0:n.modelPath,o=Object(m.w)(i);return Promise.all([r,o])},e.initAllWeapons=Object(o.a)(i.a.mark((function t(){var n;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e.props.model.materialType,h.forEach((function(t){var a="weapon".concat(t),r=e.models[a];if(r){var i=e.modelInfo[a],o=i.texturePath,c=i.flipped;Object(m.k)(r,{materialType:n,texturePath:o}),c&&(r.rotation.y+=Math.PI);var s=e.props.outline;e.outlines[a]=Object(m.m)(r,s)}}));case 2:case"end":return t.stop()}}),t)}))),e.attachWeapon=function(t,n){var a="jWeapon".concat(n[0]);e.models.main.traverse((function(e){e.name.includes(a)&&0===e.children.length&&e.add(t)}))},e.attachAllWeapons=function(){h.forEach((function(t){var n="weapon".concat(t),a=e.models[n];a&&e.attachWeapon(a,t)}))},e.detachWeapon=function(t){var n="weapon".concat(t),a=e.models[n];a&&a.parent.remove(a)},e.detachAllWeapons=function(){return h.forEach((function(t){return e.detachWeapon(t)}))},e.updateEyeTexture=function(t,n){var a=n.eyeTexture,r=t.eyeTexture;if(a===r)return!1;var i=n.materialType;Object(m.d)(e.models.main,{materialType:i,textureId:a});var o=Object(m.i)(a,r);return Object(m.c)(e.models.main,o),!0},e.updateMouthTexture=function(t,n){var a=n.mouthTexture,r=t.mouthTexture;if(a===r)return!1;var i=n.materialType;Object(m.f)(e.models.main,{materialType:i,textureId:a});var o=Object(m.i)(a,r);return Object(m.e)(e.models.main,o),!0},e.updateFaceTexture=function(t,n){var a=e.updateEyeTexture(t,n),r=e.updateMouthTexture(t,n);if(a||r){var i=e.models.main;e.applyNewModelMat(i)}},e.updateFaceOffset=function(t){var n=t.eyeIdx,a=t.mouthIdx;e.eyeIdx=n,e.mouthIdx=a},e.updateFace=function(t,n){e.updateFaceTexture(t,n),e.updateFaceOffset(n)},e.updateWeapons=function(){var t=Object(o.a)(i.a.mark((function t(n,a){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.disableInput(),h.forEach(function(){var t=Object(o.a)(i.a.mark((function t(r){var o,c,s,u,d,l,p,f;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o="weapon".concat(r),n[o]!==a[o]){t.next=3;break}return t.abrupt("return");case 3:if(e.detachWeapon(r),Object(m.n)(e.models[o]),a[o]){t.next=10;break}return e.models[o]=null,e.modelInfo[o]="",e.outlines[o]=null,t.abrupt("return");case 10:return e.modelInfo[o]=Object(m.b)(a[o]),c=e.modelInfo[o],s=c.modelPath,u=c.texturePath,d=c.flipped,t.next=14,Object(m.w)(s);case 14:l=t.sent,e.models[o]=l,p=a.materialType,Object(m.k)(l,{materialType:p,texturePath:u}),d&&(l.rotation.y+=Math.PI),f=e.props.outline,e.outlines[o]=Object(m.m)(l,f),e.attachWeapon(l,r);case 22:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),e.enableInput();case 3:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),e.aniSource="".concat(p.b,"/fbx"),e._eyeIdx=e._mouthIdx=f.d,e}return Object(s.a)(n,[{key:"eyeIdx",set:function(e){if(e){var t=this._eyeIdx;if(e!==t){var n=Object(m.h)(e,t);Object(m.c)(this.models.main,n),this._eyeIdx=e}}}},{key:"mouthIdx",set:function(e){if(e){var t=this._mouthIdx;if(e!==t){var n=Object(m.h)(e,t);Object(m.e)(this.models.main,n),this._mouthIdx=e}}}}]),n}(l.a);t.default=v}}]);
//# sourceMappingURL=33.2492a035.chunk.js.map