{"version":3,"sources":["../node_modules/three/examples/jsm/exporters/USDZExporter.js"],"names":["USDZExporter","scene","a","files","modelFileName","output","materials","textures","traverseVisible","object","isMesh","material","isMeshStandardMaterial","geometry","geometryFileName","id","meshObject","buildMeshObject","buildUSDFileAsString","uuid","buildXform","buildMaterials","fflate","texture","color","split","isRGBA","format","canvas","imageToCanvas","image","Promise","resolve","toBlob","blob","Uint8Array","arrayBuffer","filename","offset","file","headerSize","length","offsetMod64","padding","extra","level","HTMLImageElement","HTMLCanvasElement","OffscreenCanvas","ImageBitmap","scale","Math","max","width","height","document","createElement","min","context","getContext","drawImage","undefined","hex","parseInt","r","g","b","imagedata","getImageData","data","i","putImageData","dataToInsert","name","transform","matrix","array","elements","buildMatrixRow","buildMatrix","matrixWorld","determinant","console","warn","mesh","attributes","count","position","index","Array","fill","join","buildMeshVertexCount","push","buildMeshVertexIndices","buildVector3Array","normal","attribute","toPrecision","buildVector2Array","uv","buildMesh","buildMaterial","pad","inputs","samplers","buildTexture","mapType","getHexString","buildVector2","repeat","map","buildColor","emissiveMap","emissive","getHex","normalMap","aoMap","roughnessMap","roughness","metalnessMap","metalness","opacity","isMeshPhysicalMaterial","clearcoat","clearcoatRoughness","ior","vector","x","y"],"mappings":"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","file":"static/js/77.840fe2ec.chunk.js","sourcesContent":["import * as fflate from '../libs/fflate.module.js';\n\nclass USDZExporter {\n\n\tasync parse( scene ) {\n\n\t\tconst files = {};\n\t\tconst modelFileName = 'model.usda';\n\n\t\t// model file should be first in USDZ archive so we init it here\n\t\tfiles[ modelFileName ] = null;\n\n\t\tlet output = buildHeader();\n\n\t\tconst materials = {};\n\t\tconst textures = {};\n\n\t\tscene.traverseVisible( ( object ) => {\n\n\t\t\tif ( object.isMesh && object.material.isMeshStandardMaterial ) {\n\n\t\t\t\tconst geometry = object.geometry;\n\t\t\t\tconst material = object.material;\n\n\t\t\t\tconst geometryFileName = 'geometries/Geometry_' + geometry.id + '.usd';\n\n\t\t\t\tif ( ! ( geometryFileName in files ) ) {\n\n\t\t\t\t\tconst meshObject = buildMeshObject( geometry );\n\t\t\t\t\tfiles[ geometryFileName ] = buildUSDFileAsString( meshObject );\n\n\t\t\t\t}\n\n\t\t\t\tif ( ! ( material.uuid in materials ) ) {\n\n\t\t\t\t\tmaterials[ material.uuid ] = material;\n\n\t\t\t\t}\n\n\t\t\t\toutput += buildXform( object, geometry, material );\n\n\t\t\t}\n\n\t\t} );\n\n\t\toutput += buildMaterials( materials, textures );\n\n\t\tfiles[ modelFileName ] = fflate.strToU8( output );\n\t\toutput = null;\n\n\t\tfor ( const id in textures ) {\n\n\t\t\tconst texture = textures[ id ];\n\t\t\tconst color = id.split( '_' )[ 1 ];\n\t\t\tconst isRGBA = texture.format === 1023;\n\n\t\t\tconst canvas = imageToCanvas( texture.image, color );\n\t\t\tconst blob = await new Promise( resolve => canvas.toBlob( resolve, isRGBA ? 'image/png' : 'image/jpeg', 1 ) );\n\n\t\t\tfiles[ `textures/Texture_${ id }.${ isRGBA ? 'png' : 'jpg' }` ] = new Uint8Array( await blob.arrayBuffer() );\n\n\t\t}\n\n\t\t// 64 byte alignment\n\t\t// https://github.com/101arrowz/fflate/issues/39#issuecomment-777263109\n\n\t\tlet offset = 0;\n\n\t\tfor ( const filename in files ) {\n\n\t\t\tconst file = files[ filename ];\n\t\t\tconst headerSize = 34 + filename.length;\n\n\t\t\toffset += headerSize;\n\n\t\t\tconst offsetMod64 = offset & 63;\n\n\t\t\tif ( offsetMod64 !== 4 ) {\n\n\t\t\t\tconst padLength = 64 - offsetMod64;\n\t\t\t\tconst padding = new Uint8Array( padLength );\n\n\t\t\t\tfiles[ filename ] = [ file, { extra: { 12345: padding } } ];\n\n\t\t\t}\n\n\t\t\toffset = file.length;\n\n\t\t}\n\n\t\treturn fflate.zipSync( files, { level: 0 } );\n\n\t}\n\n}\n\nfunction imageToCanvas( image, color ) {\n\n\tif ( ( typeof HTMLImageElement !== 'undefined' && image instanceof HTMLImageElement ) ||\n\t\t( typeof HTMLCanvasElement !== 'undefined' && image instanceof HTMLCanvasElement ) ||\n\t\t( typeof OffscreenCanvas !== 'undefined' && image instanceof OffscreenCanvas ) ||\n\t\t( typeof ImageBitmap !== 'undefined' && image instanceof ImageBitmap ) ) {\n\n\t\tconst scale = 1024 / Math.max( image.width, image.height );\n\n\t\tconst canvas = document.createElement( 'canvas' );\n\t\tcanvas.width = image.width * Math.min( 1, scale );\n\t\tcanvas.height = image.height * Math.min( 1, scale );\n\n\t\tconst context = canvas.getContext( '2d' );\n\t\tcontext.drawImage( image, 0, 0, canvas.width, canvas.height );\n\n\t\tif ( color !== undefined ) {\n\n\t\t\tconst hex = parseInt( color, 16 );\n\n\t\t\tconst r = ( hex >> 16 & 255 ) / 255;\n\t\t\tconst g = ( hex >> 8 & 255 ) / 255;\n\t\t\tconst b = ( hex & 255 ) / 255;\n\n\t\t\tconst imagedata = context.getImageData( 0, 0, canvas.width, canvas.height );\n\t\t\tconst data = imagedata.data;\n\n\t\t\tfor ( let i = 0; i < data.length; i += 4 ) {\n\n\t\t\t\tdata[ i + 0 ] = data[ i + 0 ] * r;\n\t\t\t\tdata[ i + 1 ] = data[ i + 1 ] * g;\n\t\t\t\tdata[ i + 2 ] = data[ i + 2 ] * b;\n\n\t\t\t}\n\n\t\t\tcontext.putImageData( imagedata, 0, 0 );\n\n\t\t}\n\n\t\treturn canvas;\n\n\t}\n\n}\n\n//\n\nconst PRECISION = 7;\n\nfunction buildHeader() {\n\n\treturn `#usda 1.0\n(\n    customLayerData = {\n        string creator = \"Three.js USDZExporter\"\n    }\n    metersPerUnit = 1\n    upAxis = \"Y\"\n)\n\n`;\n\n}\n\nfunction buildUSDFileAsString( dataToInsert ) {\n\n\tlet output = buildHeader();\n\toutput += dataToInsert;\n\treturn fflate.strToU8( output );\n\n}\n\n// Xform\n\nfunction buildXform( object, geometry, material ) {\n\n\tconst name = 'Object_' + object.id;\n\tconst transform = buildMatrix( object.matrixWorld );\n\n\tif ( object.matrixWorld.determinant() < 0 ) {\n\n\t\tconsole.warn( 'THREE.USDZExporter: USDZ does not support negative scales', object );\n\n\t}\n\n\treturn `def Xform \"${ name }\" (\n    prepend references = @./geometries/Geometry_${ geometry.id }.usd@</Geometry>\n)\n{\n    matrix4d xformOp:transform = ${ transform }\n    uniform token[] xformOpOrder = [\"xformOp:transform\"]\n\n    rel material:binding = </Materials/Material_${ material.id }>\n}\n\n`;\n\n}\n\nfunction buildMatrix( matrix ) {\n\n\tconst array = matrix.elements;\n\n\treturn `( ${ buildMatrixRow( array, 0 ) }, ${ buildMatrixRow( array, 4 ) }, ${ buildMatrixRow( array, 8 ) }, ${ buildMatrixRow( array, 12 ) } )`;\n\n}\n\nfunction buildMatrixRow( array, offset ) {\n\n\treturn `(${ array[ offset + 0 ] }, ${ array[ offset + 1 ] }, ${ array[ offset + 2 ] }, ${ array[ offset + 3 ] })`;\n\n}\n\n// Mesh\n\nfunction buildMeshObject( geometry ) {\n\n\tconst mesh = buildMesh( geometry );\n\treturn `\ndef \"Geometry\"\n{\n  ${mesh}\n}\n`;\n\n}\n\nfunction buildMesh( geometry ) {\n\n\tconst name = 'Geometry';\n\tconst attributes = geometry.attributes;\n\tconst count = attributes.position.count;\n\n\treturn `\n    def Mesh \"${ name }\"\n    {\n        int[] faceVertexCounts = [${ buildMeshVertexCount( geometry ) }]\n        int[] faceVertexIndices = [${ buildMeshVertexIndices( geometry ) }]\n        normal3f[] normals = [${ buildVector3Array( attributes.normal, count )}] (\n            interpolation = \"vertex\"\n        )\n        point3f[] points = [${ buildVector3Array( attributes.position, count )}]\n        float2[] primvars:st = [${ buildVector2Array( attributes.uv, count )}] (\n            interpolation = \"vertex\"\n        )\n        uniform token subdivisionScheme = \"none\"\n    }\n`;\n\n}\n\nfunction buildMeshVertexCount( geometry ) {\n\n\tconst count = geometry.index !== null ? geometry.index.array.length : geometry.attributes.position.count;\n\n\treturn Array( count / 3 ).fill( 3 ).join( ', ' );\n\n}\n\nfunction buildMeshVertexIndices( geometry ) {\n\n\tif ( geometry.index !== null ) {\n\n\t\treturn geometry.index.array.join( ', ' );\n\n\t}\n\n\tconst array = [];\n\tconst length = geometry.attributes.position.count;\n\n\tfor ( let i = 0; i < length; i ++ ) {\n\n\t\tarray.push( i );\n\n\t}\n\n\treturn array.join( ', ' );\n\n}\n\nfunction buildVector3Array( attribute, count ) {\n\n\tif ( attribute === undefined ) {\n\n\t\tconsole.warn( 'USDZExporter: Normals missing.' );\n\t\treturn Array( count ).fill( '(0, 0, 0)' ).join( ', ' );\n\n\t}\n\n\tconst array = [];\n\tconst data = attribute.array;\n\n\tfor ( let i = 0; i < data.length; i += 3 ) {\n\n\t\tarray.push( `(${ data[ i + 0 ].toPrecision( PRECISION ) }, ${ data[ i + 1 ].toPrecision( PRECISION ) }, ${ data[ i + 2 ].toPrecision( PRECISION ) })` );\n\n\t}\n\n\treturn array.join( ', ' );\n\n}\n\nfunction buildVector2Array( attribute, count ) {\n\n\tif ( attribute === undefined ) {\n\n\t\tconsole.warn( 'USDZExporter: UVs missing.' );\n\t\treturn Array( count ).fill( '(0, 0)' ).join( ', ' );\n\n\t}\n\n\tconst array = [];\n\tconst data = attribute.array;\n\n\tfor ( let i = 0; i < data.length; i += 2 ) {\n\n\t\tarray.push( `(${ data[ i + 0 ].toPrecision( PRECISION ) }, ${ 1 - data[ i + 1 ].toPrecision( PRECISION ) })` );\n\n\t}\n\n\treturn array.join( ', ' );\n\n}\n\n// Materials\n\nfunction buildMaterials( materials, textures ) {\n\n\tconst array = [];\n\n\tfor ( const uuid in materials ) {\n\n\t\tconst material = materials[ uuid ];\n\n\t\tarray.push( buildMaterial( material, textures ) );\n\n\t}\n\n\treturn `def \"Materials\"\n{\n${ array.join( '' ) }\n}\n\n`;\n\n}\n\nfunction buildMaterial( material, textures ) {\n\n\t// https://graphics.pixar.com/usd/docs/UsdPreviewSurface-Proposal.html\n\n\tconst pad = '            ';\n\tconst inputs = [];\n\tconst samplers = [];\n\n\tfunction buildTexture( texture, mapType, color ) {\n\n\t\tconst id = texture.id + ( color ? '_' + color.getHexString() : '' );\n\t\tconst isRGBA = texture.format === 1023;\n\n\t\ttextures[ id ] = texture;\n\n\t\treturn `\n        def Shader \"Transform2d_${ mapType }\" (\n            sdrMetadata = {\n                string role = \"math\"\n            }\n        )\n        {\n            uniform token info:id = \"UsdTransform2d\"\n            float2 inputs:in.connect = </Materials/Material_${ material.id }/uvReader_st.outputs:result>\n            float2 inputs:scale = ${ buildVector2( texture.repeat ) }\n            float2 inputs:translation = ${ buildVector2( texture.offset ) }\n            float2 outputs:result\n        }\n\n        def Shader \"Texture_${ texture.id }_${ mapType }\"\n        {\n            uniform token info:id = \"UsdUVTexture\"\n            asset inputs:file = @textures/Texture_${ id }.${ isRGBA ? 'png' : 'jpg' }@\n            float2 inputs:st.connect = </Materials/Material_${ material.id }/Transform2d_${ mapType }.outputs:result>\n            token inputs:wrapS = \"repeat\"\n            token inputs:wrapT = \"repeat\"\n            float outputs:r\n            float outputs:g\n            float outputs:b\n            float3 outputs:rgb\n        }`;\n\n\t}\n\n\tif ( material.map !== null ) {\n\n\t\tinputs.push( `${ pad }color3f inputs:diffuseColor.connect = </Materials/Material_${ material.id }/Texture_${ material.map.id }_diffuse.outputs:rgb>` );\n\n\t\tsamplers.push( buildTexture( material.map, 'diffuse', material.color ) );\n\n\t} else {\n\n\t\tinputs.push( `${ pad }color3f inputs:diffuseColor = ${ buildColor( material.color ) }` );\n\n\t}\n\n\tif ( material.emissiveMap !== null ) {\n\n\t\tinputs.push( `${ pad }color3f inputs:emissiveColor.connect = </Materials/Material_${ material.id }/Texture_${ material.emissiveMap.id }_emissive.outputs:rgb>` );\n\n\t\tsamplers.push( buildTexture( material.emissiveMap, 'emissive' ) );\n\n\t} else if ( material.emissive.getHex() > 0 ) {\n\n\t\tinputs.push( `${ pad }color3f inputs:emissiveColor = ${ buildColor( material.emissive ) }` );\n\n\t}\n\n\tif ( material.normalMap !== null ) {\n\n\t\tinputs.push( `${ pad }normal3f inputs:normal.connect = </Materials/Material_${ material.id }/Texture_${ material.normalMap.id }_normal.outputs:rgb>` );\n\n\t\tsamplers.push( buildTexture( material.normalMap, 'normal' ) );\n\n\t}\n\n\tif ( material.aoMap !== null ) {\n\n\t\tinputs.push( `${ pad }float inputs:occlusion.connect = </Materials/Material_${ material.id }/Texture_${ material.aoMap.id }_occlusion.outputs:r>` );\n\n\t\tsamplers.push( buildTexture( material.aoMap, 'occlusion' ) );\n\n\t}\n\n\tif ( material.roughnessMap !== null && material.roughness === 1 ) {\n\n\t\tinputs.push( `${ pad }float inputs:roughness.connect = </Materials/Material_${ material.id }/Texture_${ material.roughnessMap.id }_roughness.outputs:g>` );\n\n\t\tsamplers.push( buildTexture( material.roughnessMap, 'roughness' ) );\n\n\t} else {\n\n\t\tinputs.push( `${ pad }float inputs:roughness = ${ material.roughness }` );\n\n\t}\n\n\tif ( material.metalnessMap !== null && material.metalness === 1 ) {\n\n\t\tinputs.push( `${ pad }float inputs:metallic.connect = </Materials/Material_${ material.id }/Texture_${ material.metalnessMap.id }_metallic.outputs:b>` );\n\n\t\tsamplers.push( buildTexture( material.metalnessMap, 'metallic' ) );\n\n\t} else {\n\n\t\tinputs.push( `${ pad }float inputs:metallic = ${ material.metalness }` );\n\n\t}\n\n\tinputs.push( `${ pad }float inputs:opacity = ${ material.opacity }` );\n\n\tif ( material.isMeshPhysicalMaterial ) {\n\n\t\tinputs.push( `${ pad }float inputs:clearcoat = ${ material.clearcoat }` );\n\t\tinputs.push( `${ pad }float inputs:clearcoatRoughness = ${ material.clearcoatRoughness }` );\n\t\tinputs.push( `${ pad }float inputs:ior = ${ material.ior }` );\n\n\t}\n\n\treturn `\n    def Material \"Material_${ material.id }\"\n    {\n        def Shader \"PreviewSurface\"\n        {\n            uniform token info:id = \"UsdPreviewSurface\"\n${ inputs.join( '\\n' ) }\n            int inputs:useSpecularWorkflow = 0\n            token outputs:surface\n        }\n\n        token outputs:surface.connect = </Materials/Material_${ material.id }/PreviewSurface.outputs:surface>\n        token inputs:frame:stPrimvarName = \"st\"\n\n        def Shader \"uvReader_st\"\n        {\n            uniform token info:id = \"UsdPrimvarReader_float2\"\n            token inputs:varname.connect = </Materials/Material_${ material.id }.inputs:frame:stPrimvarName>\n            float2 inputs:fallback = (0.0, 0.0)\n            float2 outputs:result\n        }\n\n${ samplers.join( '\\n' ) }\n\n    }\n`;\n\n}\n\nfunction buildColor( color ) {\n\n\treturn `(${ color.r }, ${ color.g }, ${ color.b })`;\n\n}\n\nfunction buildVector2( vector ) {\n\n\treturn `(${ vector.x }, ${ vector.y })`;\n\n}\n\nexport { USDZExporter };\n"],"sourceRoot":""}