var sn=Object.defineProperty,rn=Object.defineProperties;var an=Object.getOwnPropertyDescriptors;var se=Object.getOwnPropertySymbols;var We=Object.prototype.hasOwnProperty,Ge=Object.prototype.propertyIsEnumerable;var we=(r,e,t)=>e in r?sn(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,b=(r,e)=>{for(var t in e||(e={}))We.call(e,t)&&we(r,t,e[t]);if(se)for(var t of se(e))Ge.call(e,t)&&we(r,t,e[t]);return r},V=(r,e)=>rn(r,an(e));var z=(r,e)=>{var t={};for(var n in r)We.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&se)for(var n of se(r))e.indexOf(n)<0&&Ge.call(r,n)&&(t[n]=r[n]);return t};var _=(r,e,t)=>(we(r,typeof e!="symbol"?e+"":e,t),t);import{L as on,a as be,F as cn,T as W,R as Xe,C as He,b as qe,M as xe,c as ln,d as I,s as O,E as un,e as P,G as Ke,B as Ye,P as re,O as Me,f as pn,g as Ze,h as Pe,i as R,S as dn,D as Je,j as fn,k as hn,l as mn,m as gn,V as q,n as yn,A as Qe,o as ae,p as G,U as vn,q as wn,N as et,r as bn,t as tt,Q as ie,u as K,v as xn,w as Mn,x as Pn,y as An,z as Tn,H as En,W as Sn,I as Ae,J as nt,K as Ln,X as st,Y as oe,Z as In,_ as Cn,$ as Dn,a0 as On,a1 as kn,a2 as _n,a3 as Rn,a4 as Fn,a5 as Bn,a6 as jn,a7 as $n,a8 as Vn,a9 as Un,aa as Nn,ab as zn,ac as Wn,ad as Gn,ae as Xn,af as Hn,ag as Te,ah as rt,ai as qn,aj as Kn,ak as Yn,al as Zn,am as Jn,an as Y,ao as Qn,ap as es,aq as ts,ar as ns,as as ss,at as rs,au as ce,av as F,aw as k,ax as at,ay as as,az as Ee,aA as Se,aB as it,aC as is,aD as os}from"./vendor.fe894b4a.js";const cs=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}};cs();const ls="modulepreload",ot={},us="/dl-model/",A=function(e,t){return!t||t.length===0?e():Promise.all(t.map(n=>{if(n=`${us}${n}`,n in ot)return;ot[n]=!0;const s=n.endsWith(".css"),a=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${n}"]${a}`))return;const i=document.createElement("link");if(i.rel=s?"stylesheet":ls,s||(i.as="script",i.crossOrigin=""),i.href=n,document.head.appendChild(i),s)return new Promise((l,o)=>{i.addEventListener("load",l),i.addEventListener("error",o)})})).then(()=>e())};function ps(){return new Worker("/dl-model/assets/fetchWorker.6ff9ca49.js",{type:"module"})}const ds=r=>{const e=new ps;return new Promise(t=>{e.addEventListener("message",n=>{e.terminate(),t(n.data)}),e.postMessage(r)})};function ct(){return new Worker("/dl-model/assets/dbWorker.b98a6301.js",{type:"module"})}const lt=(r,e)=>{const t=new ct;return new Promise(n=>{t.addEventListener("message",()=>{n(),t.terminate()}),t.postMessage({type:"put",store:e,value:r})})};function fs(){return new Worker("/dl-model/assets/searchWorker.d631f240.js",{type:"module"})}async function hs(r,e="",t=["name"]){if(!e||!t.length)return r;const n=new fs;return new Promise(s=>{n.addEventListener("message",a=>{n.terminate(),s(a.data)}),n.postMessage({fullList:r,query:e,keys:t})})}const fi=async r=>{const e=Object.values(r).flat();await lt(e,"model"),console.log("Model DB Initialized")},hi=r=>le({type:"get",store:"model",value:r}),mi=r=>le({type:"search",store:"model",index:"name",value:r}),gi=async r=>{const t=(await le({type:"getByKeyRange",store:"model",value:"c100000_00-c199999_99"})).filter(({id:n})=>!n.endsWith("h"));return hs(t,r)},ms=()=>le({type:"getMap",store:"model",index:"name"}),le=r=>{const e=new ct;return new Promise(t=>{e.addEventListener("message",n=>{e.terminate(),t(n.data)}),e.postMessage(r)})},Z={},gs=async()=>{if(Object.keys(Z).length)return;const r="ani-personal",e=(await ds([r]))[r];Object.assign(Z,e)},yi=r=>Z[r],ys=r=>{var e,t;return(t=(e=Z[r])==null?void 0:e[0])!=null?t:r.startsWith("c")?{name:"Bob",code:"CMN_MWM_03"}:null},vi=async()=>{const r=await ms(),e=Object.entries(Z).map(([t,n])=>{const s=r.get(t);return n.map(a=>V(b({},a),{user:t,fullName:`${s} ${a.name}`}))}).flat();await lt(e,"animation")},ut=r=>r==="true",pt={"<":">","(":")","[":"]","{":"}"},vs=r=>{let e="";const t=[],n=[];for(const s of r){if(t.length){e+=s;const a=t.at(-1);s===pt[a]&&t.pop();continue}if(s==="/"){e&&n.push(e),e="";continue}e+=s,s in pt&&t.push(s)}return e&&n.push(e),n},dt=r=>vs(r).reduce((t,n)=>{const[s,...a]=n.split("="),i=a==null?void 0:a.join("=");return s&&i&&t.push([s,i]),t},[]),ft=r=>({indices:[0,0],_indicesCache:{},setIndex:(e,t)=>{r(n=>{var p,d;const{indices:s,_indicesCache:a}=n;s[e]=t;const i=s.slice(0,e+1).join(),l=(p=a[i])!=null?p:[],{length:o}=s;for(let f=0;e+1+f<o;f++)s[e+1+f]=(d=l[f])!=null?d:0;const c=s.slice(e),u=s.slice(0,e).join();u&&(a[u]=c)})},showFilter:!1,toggleFilter:()=>r(e=>{e.showFilter=!e.showFilter}),searchAll:!1,toggleSearchAll:()=>r(e=>{e.searchAll=!e.searchAll})}),ws=r=>({category:"Adventurer",setCategory:e=>r(t=>{t.category=e}),advAni:{category:"home",setCategory:e=>r(t=>{t.advAni.category=e}),home:{gender:"Male",setGender:e=>r(t=>{t.advAni.home.gender=e})},weapon:{type:"Sword",setType:e=>r(t=>{t.advAni.weapon.type=e}),gunMode:"Long",setGunMode:e=>r(t=>{t.advAni.weapon.gunMode=e})},genericSkill:{type:"Sword",setType:e=>r(t=>{t.advAni.genericSkill.type=e})},groupByWeapon:{setGroupWeaponType:(e,t)=>r(n=>{n.advAni.groupByWeapon[e]=t})},uniqueOther:{type:"Sword",setType:e=>r(t=>{t.advAni.uniqueOther.type=e}),selected:"",setSelected:e=>r(t=>{t.advAni.uniqueOther.selected=e})}},extraAni:{category:"Dance",setCategory:e=>r(t=>{t.extraAni.category=e})},personalAni:{source:"",setSource:e=>r(t=>{t.personalAni.source=e}),sourceName:"",setSourceName:e=>r(t=>{t.personalAni.sourceName=e})}}),ht="fbx",mt="animations",bs="img/textures/matcap",ue="data";let g,T,S;class xs extends on{constructor(e){super(e)}load(e,t,n,s){const a=this,i=a.path===""?be.extractUrlBase(e):a.path,l=new cn(this.manager);l.setPath(a.path),l.setResponseType("arraybuffer"),l.setRequestHeader(a.requestHeader),l.setWithCredentials(a.withCredentials),l.load(e,function(o){try{t(a.parse(o,i))}catch(c){s?s(c):console.error(c),a.manager.itemError(e)}},n,s)}parse(e,t){if(Ss(e))g=new Es().parse(e);else{const s=xt(e);if(!Ls(s))throw new Error("THREE.FBXLoader: Unknown format.");if(vt(s)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+vt(s));g=new Ts().parse(s)}const n=new W(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Ms(n,this.manager).parse(g)}}class Ms{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){T=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),s=this.parseDeformers(),a=new Ps().parse(s);return this.parseScene(s,a,n),S}parseConnections(){const e=new Map;return"Connections"in g&&g.Connections.connections.forEach(function(n){const s=n[0],a=n[1],i=n[2];e.has(s)||e.set(s,{parents:[],children:[]});const l={ID:a,relationship:i};e.get(s).parents.push(l),e.has(a)||e.set(a,{parents:[],children:[]});const o={ID:s,relationship:i};e.get(a).children.push(o)}),e}parseImages(){const e={},t={};if("Video"in g.Objects){const n=g.Objects.Video;for(const s in n){const a=n[s],i=parseInt(s);if(e[i]=a.RelativeFilename||a.Filename,"Content"in a){const l=a.Content instanceof ArrayBuffer&&a.Content.byteLength>0,o=typeof a.Content=="string"&&a.Content!=="";if(l||o){const c=this.parseImage(n[s]);t[a.RelativeFilename||a.Filename]=c}}}}for(const n in e){const s=e[n];t[s]!==void 0?e[n]=t[s]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,s=n.slice(n.lastIndexOf(".")+1).toLowerCase();let a;switch(s){case"bmp":a="image/bmp";break;case"jpg":case"jpeg":a="image/jpeg";break;case"png":a="image/png";break;case"tif":a="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",n),a="image/tga";break;default:console.warn('FBXLoader: Image type "'+s+'" is not supported.');return}if(typeof t=="string")return"data:"+a+";base64,"+t;{const i=new Uint8Array(t);return window.URL.createObjectURL(new Blob([i],{type:a}))}}parseTextures(e){const t=new Map;if("Texture"in g.Objects){const n=g.Objects.Texture;for(const s in n){const a=this.parseTexture(n[s],e);t.set(parseInt(s),a)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const s=e.WrapModeU,a=e.WrapModeV,i=s!==void 0?s.value:0,l=a!==void 0?a.value:0;if(n.wrapS=i===0?Xe:He,n.wrapT=l===0?Xe:He,"Scaling"in e){const o=e.Scaling.value;n.repeat.x=o[0],n.repeat.y=o[1]}return n}loadTexture(e,t){let n;const s=this.textureLoader.path,a=T.get(e.id).children;a!==void 0&&a.length>0&&t[a[0].ID]!==void 0&&(n=t[a[0].ID],(n.indexOf("blob:")===0||n.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let i;const l=e.FileName.slice(-3).toLowerCase();if(l==="tga"){const o=this.manager.getHandler(".tga");o===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),i=new qe):(o.setPath(this.textureLoader.path),i=o.load(n))}else l==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),i=new qe):i=this.textureLoader.load(n);return this.textureLoader.setPath(s),i}parseMaterials(e){const t=new Map;if("Material"in g.Objects){const n=g.Objects.Material;for(const s in n){const a=this.parseMaterial(n[s],e);a!==null&&t.set(parseInt(s),a)}}return t}parseMaterial(e,t){const n=e.id,s=e.attrName;let a=e.ShadingModel;if(typeof a=="object"&&(a=a.value),!T.has(n))return null;const i=this.parseParameters(e,t,n);let l;switch(a.toLowerCase()){case"phong":l=new xe;break;case"lambert":l=new ln;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',a),l=new xe;break}return l.setValues(i),l.name=s,l}parseParameters(e,t,n){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=new I().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(s.color=new I().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=new I().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(s.emissive=new I().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(s.opacity=parseFloat(e.Opacity.value)),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=new I().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(s.specular=new I().fromArray(e.SpecularColor.value));const a=this;return T.get(n).children.forEach(function(i){const l=i.relationship;switch(l){case"Bump":s.bumpMap=a.getTexture(t,i.ID);break;case"Maya|TEX_ao_map":s.aoMap=a.getTexture(t,i.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=a.getTexture(t,i.ID),s.map!==void 0&&(s.map.encoding=O);break;case"DisplacementColor":s.displacementMap=a.getTexture(t,i.ID);break;case"EmissiveColor":s.emissiveMap=a.getTexture(t,i.ID),s.emissiveMap!==void 0&&(s.emissiveMap.encoding=O);break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=a.getTexture(t,i.ID);break;case"ReflectionColor":s.envMap=a.getTexture(t,i.ID),s.envMap!==void 0&&(s.envMap.mapping=un,s.envMap.encoding=O);break;case"SpecularColor":s.specularMap=a.getTexture(t,i.ID),s.specularMap!==void 0&&(s.specularMap.encoding=O);break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=a.getTexture(t,i.ID),s.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",l);break}}),s}getTexture(e,t){return"LayeredTexture"in g.Objects&&t in g.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=T.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in g.Objects){const n=g.Objects.Deformer;for(const s in n){const a=n[s],i=T.get(parseInt(s));if(a.attrType==="Skin"){const l=this.parseSkeleton(i,n);l.ID=s,i.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),l.geometryID=i.parents[0].ID,e[s]=l}else if(a.attrType==="BlendShape"){const l={id:s};l.rawTargets=this.parseMorphTargets(i,n),l.id=s,i.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[s]=l}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach(function(s){const a=t[s.ID];if(a.attrType!=="Cluster")return;const i={ID:s.ID,indices:[],weights:[],transformLink:new P().fromArray(a.TransformLink.a)};"Indexes"in a&&(i.indices=a.Indexes.a,i.weights=a.Weights.a),n.push(i)}),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let s=0;s<e.children.length;s++){const a=e.children[s],i=t[a.ID],l={name:i.attrName,initialWeight:i.DeformPercent,id:i.id,fullWeights:i.FullWeights.a};if(i.attrType!=="BlendShapeChannel")return;l.geoID=T.get(parseInt(a.ID)).children.filter(function(o){return o.relationship===void 0})[0].ID,n.push(l)}return n}parseScene(e,t,n){S=new Ke;const s=this.parseModels(e.skeletons,t,n),a=g.Objects.Model,i=this;s.forEach(function(o){const c=a[o.ID];i.setLookAtProperties(o,c),T.get(o.ID).parents.forEach(function(p){const d=s.get(p.ID);d!==void 0&&d.add(o)}),o.parent===null&&S.add(o)}),this.bindSkeleton(e.skeletons,t,s),this.createAmbientLight(),this.setupMorphMaterials(),S.traverse(function(o){if(o.userData.transformData){o.parent&&(o.userData.transformData.parentMatrix=o.parent.matrix,o.userData.transformData.parentMatrixWorld=o.parent.matrixWorld);const c=wt(o.userData.transformData);o.applyMatrix4(c),o.updateWorldMatrix()}});const l=new As().parse();S.children.length===1&&S.children[0].isGroup&&(S.children[0].animations=l,S=S.children[0]),S.animations=l}parseModels(e,t,n){const s=new Map,a=g.Objects.Model;for(const i in a){const l=parseInt(i),o=a[i],c=T.get(l);let u=this.buildSkeleton(c,e,l,o.attrName);if(!u){switch(o.attrType){case"Camera":u=this.createCamera(c);break;case"Light":u=this.createLight(c);break;case"Mesh":u=this.createMesh(c,t,n);break;case"NurbsCurve":u=this.createCurve(c,t);break;case"LimbNode":case"Root":u=new Ye;break;case"Null":default:u=new Ke;break}u.name=o.attrName?re.sanitizeNodeName(o.attrName):"",u.ID=l}this.getTransformData(u,o),s.set(l,u)}return s}buildSkeleton(e,t,n,s){let a=null;return e.parents.forEach(function(i){for(const l in t){const o=t[l];o.rawBones.forEach(function(c,u){if(c.ID===i.ID){const p=a;a=new Ye,a.matrixWorld.copy(c.transformLink),a.name=s?re.sanitizeNodeName(s):"",a.ID=n,o.bones[u]=a,p!==null&&a.add(p)}})}}),a}createCamera(e){let t,n;if(e.children.forEach(function(s){const a=g.Objects.NodeAttribute[s.ID];a!==void 0&&(n=a)}),n===void 0)t=new Me;else{let s=0;n.CameraProjectionType!==void 0&&n.CameraProjectionType.value===1&&(s=1);let a=1;n.NearPlane!==void 0&&(a=n.NearPlane.value/1e3);let i=1e3;n.FarPlane!==void 0&&(i=n.FarPlane.value/1e3);let l=window.innerWidth,o=window.innerHeight;n.AspectWidth!==void 0&&n.AspectHeight!==void 0&&(l=n.AspectWidth.value,o=n.AspectHeight.value);const c=l/o;let u=45;n.FieldOfView!==void 0&&(u=n.FieldOfView.value);const p=n.FocalLength?n.FocalLength.value:null;switch(s){case 0:t=new Ze(u,c,a,i),p!==null&&t.setFocalLength(p);break;case 1:t=new pn(-l/2,l/2,o/2,-o/2,a,i);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+s+"."),t=new Me;break}}return t}createLight(e){let t,n;if(e.children.forEach(function(s){const a=g.Objects.NodeAttribute[s.ID];a!==void 0&&(n=a)}),n===void 0)t=new Me;else{let s;n.LightType===void 0?s=0:s=n.LightType.value;let a=16777215;n.Color!==void 0&&(a=new I().fromArray(n.Color.value));let i=n.Intensity===void 0?1:n.Intensity.value/100;n.CastLightOnObject!==void 0&&n.CastLightOnObject.value===0&&(i=0);let l=0;n.FarAttenuationEnd!==void 0&&(n.EnableFarAttenuation!==void 0&&n.EnableFarAttenuation.value===0?l=0:l=n.FarAttenuationEnd.value);const o=1;switch(s){case 0:t=new Pe(a,i,l,o);break;case 1:t=new Je(a,i);break;case 2:let c=Math.PI/3;n.InnerAngle!==void 0&&(c=R.degToRad(n.InnerAngle.value));let u=0;n.OuterAngle!==void 0&&(u=R.degToRad(n.OuterAngle.value),u=Math.max(u,1)),t=new dn(a,i,l,c,u,o);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new Pe(a,i);break}n.CastShadows!==void 0&&n.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,n){let s,a=null,i=null;const l=[];return e.children.forEach(function(o){t.has(o.ID)&&(a=t.get(o.ID)),n.has(o.ID)&&l.push(n.get(o.ID))}),l.length>1?i=l:l.length>0?i=l[0]:(i=new xe({color:13421772}),l.push(i)),"color"in a.attributes&&l.forEach(function(o){o.vertexColors=!0}),a.FBX_Deformer?(s=new fn(a,i),s.normalizeSkinWeights()):s=new hn(a,i),s}createCurve(e,t){const n=e.children.reduce(function(a,i){return t.has(i.ID)&&(a=t.get(i.ID)),a},null),s=new mn({color:3342591,linewidth:1});return new gn(n,s)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?n.eulerOrder=bt(t.RotationOrder.value):n.eulerOrder="ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){"LookAtProperty"in t&&T.get(e.ID).children.forEach(function(s){if(s.relationship==="LookAtProperty"){const a=g.Objects.Model[s.ID];if("Lcl_Translation"in a){const i=a.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(i),S.add(e.target)):e.lookAt(new q().fromArray(i))}}})}bindSkeleton(e,t,n){const s=this.parsePoseNodes();for(const a in e){const i=e[a];T.get(parseInt(i.ID)).parents.forEach(function(o){if(t.has(o.ID)){const c=o.ID;T.get(c).parents.forEach(function(p){n.has(p.ID)&&n.get(p.ID).bind(new yn(i.bones),s[p.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in g.Objects){const t=g.Objects.Pose;for(const n in t)if(t[n].attrType==="BindPose"){const s=t[n].PoseNode;Array.isArray(s)?s.forEach(function(a){e[a.Node]=new P().fromArray(a.Matrix.a)}):e[s.Node]=new P().fromArray(s.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in g&&"AmbientColor"in g.GlobalSettings){const e=g.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],s=e[2];if(t!==0||n!==0||s!==0){const a=new I(t,n,s);S.add(new Qe(a,1))}}}setupMorphMaterials(){const e=this;S.traverse(function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach(function(n,s){e.setupMorphMaterial(t,n,s)}):e.setupMorphMaterial(t,t.material))})}setupMorphMaterial(e,t,n){const s=e.uuid,a=t.uuid;let i=!1;if(S.traverse(function(l){l.isMesh&&(Array.isArray(l.material)?l.material.forEach(function(o){o.uuid===a&&l.uuid!==s&&(i=!0)}):l.material.uuid===a&&l.uuid!==s&&(i=!0))}),i===!0){const l=t.clone();l.morphTargets=!0,n===void 0?e.material=l:e.material[n]=l}else t.morphTargets=!0}}class Ps{parse(e){const t=new Map;if("Geometry"in g.Objects){const n=g.Objects.Geometry;for(const s in n){const a=T.get(parseInt(s)),i=this.parseGeometry(a,n[s],e);t.set(parseInt(s),i)}}return t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const s=n.skeletons,a=[],i=e.parents.map(function(p){return g.Objects.Model[p.ID]});if(i.length===0)return;const l=e.children.reduce(function(p,d){return s[d.ID]!==void 0&&(p=s[d.ID]),p},null);e.children.forEach(function(p){n.morphTargets[p.ID]!==void 0&&a.push(n.morphTargets[p.ID])});const o=i[0],c={};"RotationOrder"in o&&(c.eulerOrder=bt(o.RotationOrder.value)),"InheritType"in o&&(c.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(c.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(c.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(c.scale=o.GeometricScaling.value);const u=wt(c);return this.genGeometry(t,l,a,u)}genGeometry(e,t,n,s){const a=new ae;e.attrName&&(a.name=e.attrName);const i=this.parseGeoNode(e,t),l=this.genBuffers(i),o=new G(l.vertex,3);if(o.applyMatrix4(s),a.setAttribute("position",o),l.colors.length>0&&a.setAttribute("color",new G(l.colors,3)),t&&(a.setAttribute("skinIndex",new vn(l.weightsIndices,4)),a.setAttribute("skinWeight",new G(l.vertexWeights,4)),a.FBX_Deformer=t),l.normal.length>0){const c=new wn().getNormalMatrix(s),u=new G(l.normal,3);u.applyNormalMatrix(c),a.setAttribute("normal",u)}if(l.uvs.forEach(function(c,u){let p="uv"+(u+1).toString();u===0&&(p="uv"),a.setAttribute(p,new G(l.uvs[u],2))}),i.material&&i.material.mappingType!=="AllSame"){let c=l.materialIndex[0],u=0;if(l.materialIndex.forEach(function(p,d){p!==c&&(a.addGroup(u,d-u,c),c=p,u=d)}),a.groups.length>0){const p=a.groups[a.groups.length-1],d=p.start+p.count;d!==l.materialIndex.length&&a.addGroup(d,l.materialIndex.length-d,c)}a.groups.length===0&&a.addGroup(0,l.materialIndex.length,l.materialIndex[0])}return this.addMorphTargets(a,e,n,s),a}parseGeoNode(e,t){const n={};if(n.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],n.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let s=0;for(;e.LayerElementUV[s];)e.LayerElementUV[s].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[s])),s++}return n.weightTable={},t!==null&&(n.skeleton=t,t.rawBones.forEach(function(s,a){s.indices.forEach(function(i,l){n.weightTable[i]===void 0&&(n.weightTable[i]=[]),n.weightTable[i].push({id:a,weight:s.weights[l]})})})),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,s=0,a=!1,i=[],l=[],o=[],c=[],u=[],p=[];const d=this;return e.vertexIndices.forEach(function(f,h){let y,M=!1;f<0&&(f=f^-1,M=!0);let x=[],w=[];if(i.push(f*3,f*3+1,f*3+2),e.color){const m=pe(h,n,f,e.color);o.push(m[0],m[1],m[2])}if(e.skeleton){if(e.weightTable[f]!==void 0&&e.weightTable[f].forEach(function(m){w.push(m.weight),x.push(m.id)}),w.length>4){a||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),a=!0);const m=[0,0,0,0],v=[0,0,0,0];w.forEach(function(L,j){let D=L,te=x[j];v.forEach(function(ne,C,ye){if(D>ne){ye[C]=D,D=ne;const ve=m[C];m[C]=te,te=ve}})}),x=m,w=v}for(;w.length<4;)w.push(0),x.push(0);for(let m=0;m<4;++m)u.push(w[m]),p.push(x[m])}if(e.normal){const m=pe(h,n,f,e.normal);l.push(m[0],m[1],m[2])}e.material&&e.material.mappingType!=="AllSame"&&(y=pe(h,n,f,e.material)[0]),e.uv&&e.uv.forEach(function(m,v){const L=pe(h,n,f,m);c[v]===void 0&&(c[v]=[]),c[v].push(L[0]),c[v].push(L[1])}),s++,M&&(d.genFace(t,e,i,y,l,o,c,u,p,s),n++,s=0,i=[],l=[],o=[],c=[],u=[],p=[])}),t}genFace(e,t,n,s,a,i,l,o,c,u){for(let p=2;p<u;p++)e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[(p-1)*3]]),e.vertex.push(t.vertexPositions[n[(p-1)*3+1]]),e.vertex.push(t.vertexPositions[n[(p-1)*3+2]]),e.vertex.push(t.vertexPositions[n[p*3]]),e.vertex.push(t.vertexPositions[n[p*3+1]]),e.vertex.push(t.vertexPositions[n[p*3+2]]),t.skeleton&&(e.vertexWeights.push(o[0]),e.vertexWeights.push(o[1]),e.vertexWeights.push(o[2]),e.vertexWeights.push(o[3]),e.vertexWeights.push(o[(p-1)*4]),e.vertexWeights.push(o[(p-1)*4+1]),e.vertexWeights.push(o[(p-1)*4+2]),e.vertexWeights.push(o[(p-1)*4+3]),e.vertexWeights.push(o[p*4]),e.vertexWeights.push(o[p*4+1]),e.vertexWeights.push(o[p*4+2]),e.vertexWeights.push(o[p*4+3]),e.weightsIndices.push(c[0]),e.weightsIndices.push(c[1]),e.weightsIndices.push(c[2]),e.weightsIndices.push(c[3]),e.weightsIndices.push(c[(p-1)*4]),e.weightsIndices.push(c[(p-1)*4+1]),e.weightsIndices.push(c[(p-1)*4+2]),e.weightsIndices.push(c[(p-1)*4+3]),e.weightsIndices.push(c[p*4]),e.weightsIndices.push(c[p*4+1]),e.weightsIndices.push(c[p*4+2]),e.weightsIndices.push(c[p*4+3])),t.color&&(e.colors.push(i[0]),e.colors.push(i[1]),e.colors.push(i[2]),e.colors.push(i[(p-1)*3]),e.colors.push(i[(p-1)*3+1]),e.colors.push(i[(p-1)*3+2]),e.colors.push(i[p*3]),e.colors.push(i[p*3+1]),e.colors.push(i[p*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),t.normal&&(e.normal.push(a[0]),e.normal.push(a[1]),e.normal.push(a[2]),e.normal.push(a[(p-1)*3]),e.normal.push(a[(p-1)*3+1]),e.normal.push(a[(p-1)*3+2]),e.normal.push(a[p*3]),e.normal.push(a[p*3+1]),e.normal.push(a[p*3+2])),t.uv&&t.uv.forEach(function(d,f){e.uvs[f]===void 0&&(e.uvs[f]=[]),e.uvs[f].push(l[f][0]),e.uvs[f].push(l[f][1]),e.uvs[f].push(l[f][(p-1)*2]),e.uvs[f].push(l[f][(p-1)*2+1]),e.uvs[f].push(l[f][p*2]),e.uvs[f].push(l[f][p*2+1])})}addMorphTargets(e,t,n,s){if(n.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const a=this;n.forEach(function(i){i.rawTargets.forEach(function(l){const o=g.Objects.Geometry[l.geoID];o!==void 0&&a.genMorphGeometry(e,t,o,s,l.name)})})}genMorphGeometry(e,t,n,s,a){const i=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],l=n.Vertices!==void 0?n.Vertices.a:[],o=n.Indexes!==void 0?n.Indexes.a:[],c=e.attributes.position.count*3,u=new Float32Array(c);for(let h=0;h<o.length;h++){const y=o[h]*3;u[y]=l[h*3],u[y+1]=l[h*3+1],u[y+2]=l[h*3+2]}const p={vertexIndices:i,vertexPositions:u},d=this.genBuffers(p),f=new G(d.vertex,3);f.name=a||n.attrName,f.applyMatrix4(s),e.morphAttributes.position.push(f)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Normals.a;let a=[];return n==="IndexToDirect"&&("NormalIndex"in e?a=e.NormalIndex.a:"NormalsIndex"in e&&(a=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:a,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.UV.a;let a=[];return n==="IndexToDirect"&&(a=e.UVIndex.a),{dataSize:2,buffer:s,indices:a,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Colors.a;let a=[];return n==="IndexToDirect"&&(a=e.ColorIndex.a),{dataSize:4,buffer:s,indices:a,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const s=e.Materials.a,a=[];for(let i=0;i<s.length;++i)a.push(i);return{dataSize:1,buffer:s,indices:a,mappingType:t,referenceType:n}}parseNurbsGeometry(e){if(et===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new ae;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new ae;const n=t-1,s=e.KnotVector.a,a=[],i=e.Points.a;for(let p=0,d=i.length;p<d;p+=4)a.push(new bn().fromArray(i,p));let l,o;if(e.Form==="Closed")a.push(a[0]);else if(e.Form==="Periodic"){l=n,o=s.length-1-l;for(let p=0;p<n;++p)a.push(a[p])}const u=new et(n,s,a,l,o).getPoints(a.length*12);return new ae().setFromPoints(u)}}class As{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const n in t){const s=t[n],a=this.addClip(s);e.push(a)}return e}parseClips(){if(g.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=g.Objects.AnimationCurveNode,t=new Map;for(const n in e){const s=e[n];if(s.attrName.match(/S|R|T|DeformPercent/)!==null){const a={id:s.id,attr:s.attrName,curves:{}};t.set(a.id,a)}}return t}parseAnimationCurves(e){const t=g.Objects.AnimationCurve;for(const n in t){const s={id:t[n].id,times:t[n].KeyTime.a.map(Is),values:t[n].KeyValueFloat.a},a=T.get(s.id);if(a!==void 0){const i=a.parents[0].ID,l=a.parents[0].relationship;l.match(/X/)?e.get(i).curves.x=s:l.match(/Y/)?e.get(i).curves.y=s:l.match(/Z/)?e.get(i).curves.z=s:l.match(/d|DeformPercent/)&&e.has(i)&&(e.get(i).curves.morph=s)}}}parseAnimationLayers(e){const t=g.Objects.AnimationLayer,n=new Map;for(const s in t){const a=[],i=T.get(parseInt(s));i!==void 0&&(i.children.forEach(function(o,c){if(e.has(o.ID)){const u=e.get(o.ID);if(u.curves.x!==void 0||u.curves.y!==void 0||u.curves.z!==void 0){if(a[c]===void 0){const p=T.get(o.ID).parents.filter(function(d){return d.relationship!==void 0})[0].ID;if(p!==void 0){const d=g.Objects.Model[p.toString()];if(d===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",o);return}const f={modelName:d.attrName?re.sanitizeNodeName(d.attrName):"",ID:d.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};S.traverse(function(h){h.ID===d.id&&(f.transform=h.matrix,h.userData.transformData&&(f.eulerOrder=h.userData.transformData.eulerOrder))}),f.transform||(f.transform=new P),"PreRotation"in d&&(f.preRotation=d.PreRotation.value),"PostRotation"in d&&(f.postRotation=d.PostRotation.value),a[c]=f}}a[c]&&(a[c][u.attr]=u)}else if(u.curves.morph!==void 0){if(a[c]===void 0){const p=T.get(o.ID).parents.filter(function(x){return x.relationship!==void 0})[0].ID,d=T.get(p).parents[0].ID,f=T.get(d).parents[0].ID,h=T.get(f).parents[0].ID,y=g.Objects.Model[h],M={modelName:y.attrName?re.sanitizeNodeName(y.attrName):"",morphName:g.Objects.Deformer[p].attrName};a[c]=M}a[c][u.attr]=u}}}),n.set(parseInt(s),a))}return n}parseAnimStacks(e){const t=g.Objects.AnimationStack,n={};for(const s in t){const a=T.get(parseInt(s)).children;a.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const i=e.get(a[0].ID);n[s]={name:t[s].attrName,layer:i}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach(function(s){t=t.concat(n.generateTracks(s))}),new tt(e.name,-1,t)}generateTracks(e){const t=[];let n=new q,s=new ie,a=new q;if(e.transform&&e.transform.decompose(n,s,a),n=n.toArray(),s=new K().setFromQuaternion(s,e.eulerOrder).toArray(),a=a.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const i=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");i!==void 0&&t.push(i)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const i=this.generateRotationTrack(e.modelName,e.R.curves,s,e.preRotation,e.postRotation,e.eulerOrder);i!==void 0&&t.push(i)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const i=this.generateVectorTrack(e.modelName,e.S.curves,a,"scale");i!==void 0&&t.push(i)}if(e.DeformPercent!==void 0){const i=this.generateMorphTrack(e);i!==void 0&&t.push(i)}return t}generateVectorTrack(e,t,n,s){const a=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(a,t,n);return new xn(e+"."+s,a,i)}generateRotationTrack(e,t,n,s,a,i){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(R.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(R.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(R.degToRad));const l=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(l,t,n);s!==void 0&&(s=s.map(R.degToRad),s.push(i),s=new K().fromArray(s),s=new ie().setFromEuler(s)),a!==void 0&&(a=a.map(R.degToRad),a.push(i),a=new K().fromArray(a),a=new ie().setFromEuler(a).invert());const c=new ie,u=new K,p=[];for(let d=0;d<o.length;d+=3)u.set(o[d],o[d+1],o[d+2],i),c.setFromEuler(u),s!==void 0&&c.premultiply(s),a!==void 0&&c.multiply(a),c.toArray(p,d/3*4);return new Mn(e+".quaternion",l,p)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map(function(a){return a/100}),s=S.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Pn(e.modelName+".morphTargetInfluences["+s+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(n,s){return n-s}),t.length>1){let n=1,s=t[0];for(let a=1;a<t.length;a++){const i=t[a];i!==s&&(t[n]=i,s=i,n++)}t=t.slice(0,n)}return t}getKeyframeTrackValues(e,t,n){const s=n,a=[];let i=-1,l=-1,o=-1;return e.forEach(function(c){if(t.x&&(i=t.x.times.indexOf(c)),t.y&&(l=t.y.times.indexOf(c)),t.z&&(o=t.z.times.indexOf(c)),i!==-1){const u=t.x.values[i];a.push(u),s[0]=u}else a.push(s[0]);if(l!==-1){const u=t.y.values[l];a.push(u),s[1]=u}else a.push(s[1]);if(o!==-1){const u=t.z.values[o];a.push(u),s[2]=u}else a.push(s[2])}),a}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const n=e.values[t-1],s=e.values[t]-n,a=Math.abs(s);if(a>=180){const i=a/180,l=s/i;let o=n+l;const c=e.times[t-1],p=(e.times[t]-c)/i;let d=c+p;const f=[],h=[];for(;d<e.times[t];)f.push(d),d+=p,h.push(o),o+=l;e.times=Mt(e.times,t,f),e.values=Mt(e.values,t,h)}}}}class Ts{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new yt,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach(function(s,a){const i=s.match(/^[\s\t]*;/),l=s.match(/^[\s\t]*$/);if(i||l)return;const o=s.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),c=s.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),u=s.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(s,o):c?t.parseNodeProperty(s,c,n[++a]):u?t.popStack():s.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(s)}),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map(function(o){return o.trim().replace(/^"/,"").replace(/"$/,"")}),a={name:n},i=this.parseNodeAttr(s),l=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(n,a):n in l?(n==="PoseNode"?l.PoseNode.push(a):l[n].id!==void 0&&(l[n]={},l[n][l[n].id]=l[n]),i.id!==""&&(l[n][i.id]=a)):typeof i.id=="number"?(l[n]={},l[n][i.id]=a):n!=="Properties70"&&(n==="PoseNode"?l[n]=[a]:l[n]=a),typeof i.id=="number"&&(a.id=i.id),i.name!==""&&(a.attrName=i.name),i.type!==""&&(a.attrType=i.type),this.pushStack(a)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",s="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:n,type:s}}parseNodeProperty(e,t,n){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),a=t[2].replace(/^"/,"").replace(/"$/,"").trim();s==="Content"&&a===","&&(a=n.replace(/"/g,"").replace(/,$/,"").trim());const i=this.getCurrentNode();if(i.name==="Properties70"){this.parseNodeSpecialProperty(e,s,a);return}if(s==="C"){const o=a.split(",").slice(1),c=parseInt(o[0]),u=parseInt(o[1]);let p=a.split(",").slice(3);p=p.map(function(d){return d.trim().replace(/^"/,"")}),s="connections",a=[c,u],Ds(a,p),i[s]===void 0&&(i[s]=[])}s==="Node"&&(i.id=a),s in i&&Array.isArray(i[s])?i[s].push(a):s!=="a"?i[s]=a:i.a=a,this.setCurrentProp(i,s),s==="a"&&a.slice(-1)!==","&&(i.a=Ie(a))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=Ie(t.a))}parseNodeSpecialProperty(e,t,n){const s=n.split('",').map(function(u){return u.trim().replace(/^\"/,"").replace(/\s/,"_")}),a=s[0],i=s[1],l=s[2],o=s[3];let c=s[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":c=Ie(c);break}this.getPrevNode()[a]={type:i,type2:l,flag:o,value:c},this.setCurrentProp(this.getPrevNode(),a)}}class Es{parse(e){const t=new gt(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const s=new yt;for(;!this.endOfContent(t);){const a=this.parseNode(t,n);a!==null&&s.add(a.name,a)}return s}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&~15)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},s=t>=7500?e.getUint64():e.getUint32(),a=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const i=e.getUint8(),l=e.getString(i);if(s===0)return null;const o=[];for(let d=0;d<a;d++)o.push(this.parseProperty(e));const c=o.length>0?o[0]:"",u=o.length>1?o[1]:"",p=o.length>2?o[2]:"";for(n.singleProperty=a===1&&e.getOffset()===s;s>e.getOffset();){const d=this.parseNode(e,t);d!==null&&this.parseSubNode(l,n,d)}return n.propertyList=o,typeof c=="number"&&(n.id=c),u!==""&&(n.attrName=u),p!==""&&(n.attrType=p),l!==""&&(n.name=l),n}parseSubNode(e,t,n){if(n.singleProperty===!0){const s=n.propertyList[0];Array.isArray(s)?(t[n.name]=n,n.a=s):t[n.name]=s}else if(e==="Connections"&&n.name==="C"){const s=[];n.propertyList.forEach(function(a,i){i!==0&&s.push(a)}),t.connections===void 0&&(t.connections=[]),t.connections.push(s)}else if(n.name==="Properties70")Object.keys(n).forEach(function(a){t[a]=n[a]});else if(e==="Properties70"&&n.name==="P"){let s=n.propertyList[0],a=n.propertyList[1];const i=n.propertyList[2],l=n.propertyList[3];let o;s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),a.indexOf("Lcl ")===0&&(a=a.replace("Lcl ","Lcl_")),a==="Color"||a==="ColorRGB"||a==="Vector"||a==="Vector3D"||a.indexOf("Lcl_")===0?o=[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:o=n.propertyList[4],t[s]={type:a,type2:i,flag:l,value:o}}else t[n.name]===void 0?typeof n.id=="number"?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:n.name==="PoseNode"?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):t[n.name][n.id]===void 0&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),a=e.getUint32(),i=e.getUint32();if(a===0)switch(t){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}typeof An=="undefined"&&console.error("THREE.FBXLoader: External library fflate.min.js required.");const l=Tn(new Uint8Array(e.getArrayBuffer(i))),o=new gt(l.buffer);switch(t){case"b":case"c":return o.getBooleanArray(s);case"d":return o.getFloat64Array(s);case"f":return o.getFloat32Array(s);case"i":return o.getInt32Array(s);case"l":return o.getInt64Array(s)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class gt{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)==1}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let s=0;s<e;s++)t[s]=this.getUint8();const n=t.indexOf(0);return n>=0&&(t=t.slice(0,n)),be.decodeText(new Uint8Array(t))}}class yt{add(e,t){this[e]=t}}function Ss(r){const e="Kaydara FBX Binary  \0";return r.byteLength>=e.length&&e===xt(r,0,e.length)}function Ls(r){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function n(s){const a=r[s-1];return r=r.slice(t+s),t++,a}for(let s=0;s<e.length;++s)if(n(1)===e[s])return!1;return!0}function vt(r){const e=/FBXVersion: (\d+)/,t=r.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function Is(r){return r/46186158e3}const Cs=[];function pe(r,e,t,n){let s;switch(n.mappingType){case"ByPolygonVertex":s=r;break;case"ByPolygon":s=e;break;case"ByVertice":s=t;break;case"AllSame":s=n.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+n.mappingType)}n.referenceType==="IndexToDirect"&&(s=n.indices[s]);const a=s*n.dataSize,i=a+n.dataSize;return Os(Cs,n.buffer,a,i)}const Le=new K,X=new q;function wt(r){const e=new P,t=new P,n=new P,s=new P,a=new P,i=new P,l=new P,o=new P,c=new P,u=new P,p=new P,d=new P,f=r.inheritType?r.inheritType:0;if(r.translation&&e.setPosition(X.fromArray(r.translation)),r.preRotation){const C=r.preRotation.map(R.degToRad);C.push(r.eulerOrder),t.makeRotationFromEuler(Le.fromArray(C))}if(r.rotation){const C=r.rotation.map(R.degToRad);C.push(r.eulerOrder),n.makeRotationFromEuler(Le.fromArray(C))}if(r.postRotation){const C=r.postRotation.map(R.degToRad);C.push(r.eulerOrder),s.makeRotationFromEuler(Le.fromArray(C)),s.invert()}r.scale&&a.scale(X.fromArray(r.scale)),r.scalingOffset&&l.setPosition(X.fromArray(r.scalingOffset)),r.scalingPivot&&i.setPosition(X.fromArray(r.scalingPivot)),r.rotationOffset&&o.setPosition(X.fromArray(r.rotationOffset)),r.rotationPivot&&c.setPosition(X.fromArray(r.rotationPivot)),r.parentMatrixWorld&&(p.copy(r.parentMatrix),u.copy(r.parentMatrixWorld));const h=t.clone().multiply(n).multiply(s),y=new P;y.extractRotation(u);const M=new P;M.copyPosition(u);const x=M.clone().invert().multiply(u),w=y.clone().invert().multiply(x),m=a,v=new P;if(f===0)v.copy(y).multiply(h).multiply(w).multiply(m);else if(f===1)v.copy(y).multiply(w).multiply(h).multiply(m);else{const ye=new P().scale(new q().setFromMatrixScale(p)).clone().invert(),ve=w.clone().multiply(ye);v.copy(y).multiply(h).multiply(ve).multiply(m)}const L=c.clone().invert(),j=i.clone().invert();let D=e.clone().multiply(o).multiply(c).multiply(t).multiply(n).multiply(s).multiply(L).multiply(l).multiply(i).multiply(a).multiply(j);const te=new P().copyPosition(D),ne=u.clone().multiply(te);return d.copyPosition(ne),D=d.clone().multiply(v),D.premultiply(u.invert()),D}function bt(r){r=r||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return r===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[r]}function Ie(r){return r.split(",").map(function(t){return parseFloat(t)})}function xt(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=r.byteLength),be.decodeText(new Uint8Array(r,e,t))}function Ds(r,e){for(let t=0,n=r.length,s=e.length;t<s;t++,n++)r[n]=e[t]}function Os(r,e,t,n){for(let s=t,a=0;s<n;s++,a++)r[a]=e[s];return r}function Mt(r,e,t){return r.slice(0,e).concat(t).concat(r.slice(e))}const Pt=r=>r&&new Promise(e=>{new xs().load(r,e)}),At=r=>r&&new Promise(e=>{new W().load(r,e)}),ks=["px.png","nx.png","py.png","ny.png","pz.png","nz.png"],_s=r=>r&&new Promise(e=>{new En().setPath(`${r}/`).load(ks,e)}),Rs=["c100007_01","c100007_05","c100007_09","c100034_01","c100035_01","c100036_01","c100037_01","c100041_01"],Fs=async r=>await(await fetch(r)).json(),de=async r=>(await Fs(r)).data,Bs=(...r)=>e=>r.reduce((t,n)=>n(t),e),js=r=>[...new Set(r)],$=r=>r==="false"?!1:!!r,Tt=(r,e,t)=>{if(!e.length)return;const n=e.pop(),s=e.reduce((a,i)=>a==null?void 0:a[i],r);s&&(s[n]=t)};function Ce(r){return!!/[0-9A-Fa-f]{6}/.test(r)}function fe(r){return Ce(r)&&!r.startsWith("#")?new I(`#${r}`):new I(r)}async function $s(r=100){return await new Promise(e=>setTimeout(e,r))}function Et(r,e="="){const[t,...n]=r.split(e),s=n.join(e);return[t,s]}const Vs=r=>r.startsWith("w302"),St=([r,...e])=>`${r.toUpperCase()}${e.join("")}`;function Us(r){var t;return r==="smith"?"dragon":r.endsWith("h")?"story":Rs.includes(r)?"spAdventurer":(t={c:"adventurer",b:"boss",d:"dragon",e:"enemy",h:"high boss",o:"object",r:"raid boss",w:"weapon"}[r[0]])!=null?t:"other"}function Ns(r=or){const e=new Sn(r);return e.outputEncoding=O,e}function zs(r={}){const{fov:e,aspect:t,near:n,far:s}=b(b({},lr),r);return new Ze(e,t,n,s)}async function Ws(r){if(r.startsWith("img:")){const e=r.replace("img:",""),t=await At(e);return t.encoding=O,t.center.set(.5,0),t}if(r.startsWith("sky:")){const e=r.replace("sky:",""),t=await _s(e);return t.encoding=O,t}if(r==="transparent")return null;if(Ce(r)){const e=r.startsWith("#")?r:`#${r}`;return new I(e)}}function Gs(r){var e,t,n,s;(t=(e=r.map)==null?void 0:e.dispose)==null||t.call(e),(s=(n=r.userData.backupMap)==null?void 0:n.dispose)==null||s.call(n),r.dispose()}const Lt=r=>{const e=new W().load(r);return e.encoding=O,e};function Xs(r){const e=[],t=[];return r.traverse(n=>{n.isMesh&&e.push(n),n.isBone&&t.push(n)}),[e,t]}function Hs(r){var t,n;if(!r)return;[r.material].flat().forEach(s=>{var a,i,l,o,c,u;(i=(a=s.map)==null?void 0:a.dispose)==null||i.call(a),(c=(o=(l=s.userData)==null?void 0:l.backupMap)==null?void 0:o.dispose)==null||c.call(o),(u=s.dispose)==null||u.call(s)}),(n=(t=r.geometry)==null?void 0:t.dispose)==null||n.call(t)}const qs=()=>{const r=new Date,e=r.toDateString().replace(/ /g,"_"),t=r.toLocaleTimeString().replace(/:/g,"-").replace(/ /g,"");return`${e}_${t}`},It=r=>r?r.split("/").reduce((t,n)=>{const[s,a]=n.split("=");return s&&a&&(t[s]=a),t},{}):{};class Ct extends Ae{constructor(e){super();this._matcapCombine=nt,this.emissiveIntensity=1,this.normalMapType=Ln,this.combine=st,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.lights=!0,this.vertexShader=oe.vertexShader,this.fragmentShader=oe.fragmentShader,this.defines=Object.assign({},oe.defines),Object.defineProperty(this,"matcapCombine",{get:function(){return this._matcapCombine},set:function(n){switch(this._matcapCombine=n,n){case st:this.defines.MATCAP_BLENDING_MULTIPLY=!0,delete this.defines.MATCAP_BLENDING_ADD;break;default:case nt:this.defines.MATCAP_BLENDING_ADD=!0,delete this.defines.MATCAP_BLENDING_MULTIPLY;break}}}),this.uniforms=In.clone(oe.uniforms);const t=["specular","shininess","opacity","diffuse","map","matcap","gradientMap","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveMap","bumpMap","bumpScale","normalMap","normalScale","displacemantBias","displacemantMap","displacemantScale","specularMap","alphaMap","envMap","reflectivity","refractionRatio"];for(const n of t)Object.defineProperty(this,n,{get:function(){return this.uniforms[n].value},set:function(s){this.uniforms[n].value=s}});Object.defineProperty(this,"color",Object.getOwnPropertyDescriptor(this,"diffuse")),this.setValues(e)}copy(e){return super.copy(e),this.matcapCombine=e.matcapCombine,this.emissiveIntensity=e.emissiveIntensity,this.normalMapType=e.normalMapType,this.combine=e.combine,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}Ct.prototype.isMMDToonMaterial=!0;const Ks=["color","emissive","specular"],Ys=["wireframe","metalness","opacity","roughness","shininess","transparent","emissiveIntensity"],Dt=["type","flatShading","showTexture","gradientMap","matcap"],Zs=[...Ks,...Ys,...Dt],Js=["transparent","opacity","wireframe","showTexture","color"],Qs={Basic:[],Toon:["emissive","emissiveIntensity","gradientMap"],Lambert:["emissive","emissiveIntensity"],Phong:["emissive","emissiveIntensity","specular","shininess","flatShading"],Standard:["emissive","emissiveIntensity","metalness","roughness","flatShading"],Matcap:["flatShading","matcap"],MMDToon:["emissive","emissiveIntensity","specular","shininess","matcap","gradientMap","flatShading"]},B=r=>`${r}`,De=r=>Ce(r)?`${r.startsWith("#")?"":"#"}${r}`:r,er=r=>Array.isArray(r)?r.join(","):r,Oe={wireframe:{name:"Wireframe",type:"boolean",default:!1,valueMap:$,toString:B},showTexture:{name:"Texture",type:"boolean",default:!0,valueMap:$,toString:B},transparent:{name:"Transparent",type:"boolean",default:!1,valueMap:$,toString:B},flatShading:{name:"Flat Shading",type:"boolean",default:!1,valueMap:$,toString:B},color:{name:"Color",type:"color",default:"#ffffff",valueMap:fe,toString:De},emissive:{name:"Emissive",type:"color",default:"#000000",valueMap:fe,toString:De},opacity:{name:"Opacity",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:B},emissiveIntensity:{name:"Emissive Intensity",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:B},specular:{name:"Specular",type:"color",default:"#111111",valueMap:fe,toString:De},metalness:{name:"Metalness",type:"percentage",default:0,min:0,max:1,valueMap:parseFloat,toString:B},roughness:{name:"Roughness",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:B},shininess:{name:"Shininess",type:"number",default:30,min:1,max:100,valueMap:parseFloat,toString:B},gradientMap:{name:"Gradient Map",type:"select",default:"none",valueMap:kt,toString:er},matcap:{name:"Matcap",type:"select",default:"matcap_fresnel.jpg",valueMap:_t,toString:B}},tr=Object.fromEntries(Object.entries(Oe).map(([r,{default:e}])=>[r,e])),U=V(b({},tr),{type:"Basic"}),nr=Object.fromEntries(Object.entries(Oe).map(([r,{valueMap:e}])=>[r,e])),sr=Object.fromEntries(Object.entries(Oe).map(([r,{toString:e}])=>[r,e])),ke=r=>[...Js,...Qs[r]],rr=(r,e={})=>{if(r==="MMDToon")return new Ct(e);const t=`Mesh${r}Material`;return new kn[t](e)},Ot=(r,{matType:e="Basic",texturePath:t="",force:n=!1}={})=>{r.forEach(s=>{const a=[s.material].flat(),i=Array.isArray(s.material);if(!n&&!t){const l=`isMesh${e}Material`;if(!a.some(c=>!c[l]))return}a.forEach((l,o)=>{var p,d,f,h;const c=t?new W().load(t):a[o].map;t&&(c.encoding=O);const u=rr(e);if(u.name=l.name,u.map=c,u.userData.backupMap=l.userData.backupMap,t&&((d=(p=l.map)==null?void 0:p.dispose)==null||d.call(p),(h=(f=l.userData.backupMap)==null?void 0:f.dispose)==null||h.call(f)),l.dispose(),i){s.material[o]=u;return}s.material=u})})},ar=r=>Array.isArray(r)?r:r.split(",").map(e=>parseInt(e));function kt(r){const e=ar(r),t=e.length;if(t<2)return null;const n=Uint8Array.from(e),s=new Cn(n,t,1,Dn);return s.minFilter=s.magFilter=On,s.generateMipmaps=!1,s}const ir=r=>r.includes("/")||r.includes(":")?r:`${bs}/${r}`;function _t(r){const e=ir(r);return e?Lt(e):null}const or={alpha:!0,antialias:!0},cr="#cccccc",lr={type:"Perspective",fov:45,aspect:1,far:100,near:.01},ur="c100001_01",H={enabled:!0,size:5,color:"#000000",opacity:1},pr={noBackground:!0,fileName:"screenshot",frameRate:30},Rt=1,_e=30,dr={directional:{color:"#ffffff",intensity:.8,position:[1,0,2]},ambient:{color:"#444444",intensity:1},point:{color:"#ffffff",intensity:1}},Re={"No Mapping":_n,Linear:Rn,Reinhard:Fn,Cineon:Bn,"ACES Filmic":jn},J={addEventListener(r,e){var s,a;if(!e)return;this._listeners=(s=this._listeners)!=null?s:{};const t=this._listeners,n=r.toLowerCase();return t[n]=(a=t[n])!=null?a:[],!t[n].includes(e)&&t[n].push(e),e},hasEventListener(r,e){var n;return this._listeners===void 0?!1:!!((n=this._listeners[r.toLowerCase()])==null?void 0:n.includes(e))},removeEventListener(r,e){if(this._listeners===void 0)return;const t=r.toLowerCase(),s=this._listeners[t];if(s!==void 0){const a=s.indexOf(e);a!==-1&&s.splice(a,1)}},dispatchEvent(r){if(this._listeners===void 0)return;const e=this._listeners,t=r.type.toLowerCase(),n=e[t];if(n){r.target=this;const s=n.slice(0);for(let a=0,i=s.length;a<i;a++)s[a].call(this,r)}},addCountedEventListener(r,e,t=1){const n=this;let s=t;function a(i){e.call(n,i),s--,s===0&&n.removeEventListener(r,a)}this.addEventListener(r,a)}},fr={face1:[2,1],face2:[0,0],face3:[1,0],face4:[2,0],face5:[3,0],face6:[0,-1],face7:[1,-1],face8:[2,-1],face9:[3,-1]},Ft={},hr=async()=>{const r=await de(`${ue}/face-offset.json`);Object.assign(Ft,r)},Bt=r=>Ft[r]||[0,0],Fe={},mr=async()=>{const r=await de(`${ue}/camera-position.json`);Object.assign(Fe,r)},gr=r=>{var e;return(e=Fe[r])!=null?e:Fe[r[0]]},Be={},yr=async()=>{const r=await de(`${ue}/control-position.json`);Object.assign(Be,r)},vr=r=>{var e;return(e=Be[r])!=null?e:Be[r[0]]},jt=r=>fr[`face${r}`],wr=(r,e)=>{const t={x:0,y:0};if(r!==e){const[n,s]=jt(e),[a,i]=jt(r);t.x=a-n,t.y=i-s}return[t.x,t.y]},br=(r,e)=>{const t={x:0,y:0};if(r!==e){const[n,s]=Bt(e),[a,i]=Bt(r);t.x=a-n,t.y=i-s}return[t.x,t.y]},he=r=>new Proxy(Object.assign(r,J),{get(e,t){return e[t]},set(e,t,n){return e[t]=n,e.dispatchEvent({type:"change",propName:t,value:n}),!0}}),$t=/mEye_[0-9]/m,Vt=/mMouth_[0-9]/m,xr=/[0-9]{2}/,Ut=["eye","mouth"];function Mr(r){const{type:e,meshes:t}=r;return e==="adventurer"?Pr(r):t.some(({name:s})=>s.match(/mEye|mMouth/))?Ar(r):r}function Pr(r){const{meshes:e,id:t}=r,n=c=>`${ht}/${c}/${c}.png`,s=e.find(({name:c})=>c==="mBodyAll"),a={eyeIdx:2,eyeBaseIdx:2,mouthIdx:2,mouthBaseIdx:2,eyeTexture:t,mouthTexture:t},i={type:"uv"},l=c=>([u,p])=>{var w;if(!s)return;const d=`mt${St(c)}CH`,f=(w=s.geometry.groups)==null?void 0:w.find(m=>{var v;return((v=s.material[m.materialIndex])==null?void 0:v.name)===d});if(!f)return;const{start:h,count:y}=f,M=h+y,x=s.geometry.attributes.uv;for(let m=h;m<M;m++){const v=x.getX(m)+.25*u,L=x.getY(m)+.25*p;x.setXY(m,v,L)}x.needsUpdate=!0},o=c=>u=>{var h,y;if(!s)return;const p=`mt${St(c)}CH`,d=(y=(h=s.material).find)==null?void 0:y.call(h,({name:M})=>M===p);if(!d)return;const f=n(u);d.map.dispose(),d.map=Lt(f),d.needsUpdate=!0};return Ut.forEach(c=>{Object.defineProperties(i,{[`${c}Idx`]:{get(){return a[`${c}Idx`]},set(u){const p=parseInt(u),d=this[`${c}Idx`];a[`${c}Idx`]=p;const f=wr(p,d);l(c)(f)}},[`${c}BaseIdx`]:{get(){return a[`${c}BaseIdx`]},set(u){a[`${c}BaseIdx`]=u,this[`${c}Idx`]=u}},[`${c}Texture`]:{get(){return a[`${c}Texture`]},set(u){const p=this[`${c}Texture`];a[`${c}Texture`]=u,o(c)(u);const d=br(u,p);l(c)(d)}}})}),r.face=he(i),r}function Ar(r){const{meshes:e}=r,[t,n]=Tr(e);[...t,...n].forEach(o=>o.frustumCulled=!1);const s={eye:t,mouth:n},a={eyeIdx:"",eyeBaseIdx:"",mouthIdx:"",mouthBaseIdx:""},i={eyeList:t,mouthList:n,type:"meshes"},l=o=>c=>{s[o].forEach(u=>{const{name:p}=u,d=xr.exec(p)[0];u.visible=parseInt(d)===c})};return Ut.forEach(o=>Object.defineProperties(i,{[`${o}Idx`]:{get(){return a[`${o}Idx`]},set(c){const u=parseInt(c);l(o)(u),a[`${o}Idx`]=`${u}`}},[`${o}BaseIdx`]:{get(){return a[`${o}BaseIdx`]},set(c){a[`${o}BaseIdx`]=c,this[`${o}Idx`]=c}}})),i.eyeBaseIdx=Rt,i.mouthBaseIdx=Rt,r.face=he(i),r}function Tr(r){const e=r.filter(({name:n})=>n.match($t)),t=r.filter(({name:n})=>n.match(Vt));return[e,t]}function Er(r){const{model:e,uniqueId:t}=r,[n,s]=Xs(e);return Object.defineProperty(s,"list",{value:js(s.map(({name:a})=>a))}),Object.defineProperty(n,"visible",{get(){return this.filter(({visible:a})=>a)}}),s.forEach(a=>{a.name=`${t}|${a.name}`}),Object.defineProperties(r,{meshes:{get(){return n}},bones:{get(){return s}}})}const Nt={},Sr=async()=>{const r=await de(`${ue}/model-parts.json`);Object.assign(Nt,r)},Lr=r=>Nt[r],Ir=/mParts([A-Z])/,zt=/mParts[A-Z]_([A-Za-z]*)/;function Cr(r){const{meshes:e,id:t}=r,n=[],s=[];if(e.forEach(c=>{const{name:u}=c;if(!!(u==null?void 0:u.match)){if(u.match(/mParts/)){n.push(c);return}!u.match($t)&&!u.match(Vt)&&s.push(c)}}),!n.length&&s.length<2)return r;const a=Object.defineProperties({},{list:{get(){return Object.keys(this)},enumerable:!1},reset:{value:function(){this.list.forEach(c=>this[c].reset())},enumerable:!1},others:{get(){return s},enumerable:!1}});if(r.parts=a,!n.length)return r;const i=Lr(t),l=new Set(n.map(({name:c})=>{var u;return(u=Ir.exec(c))==null?void 0:u[1]})),o=c=>n.filter(({name:u})=>u.includes(`mParts${c}`)).sort((u,p)=>u.name>p.name?1:-1);return l.forEach(c=>{var M,x;const u=i==null?void 0:i[c],p=(M=u==null?void 0:u.name.replace(/ /g,"_"))!=null?M:c,d=u==null?void 0:u.options,f=o(c),h=f.map(({name:w})=>{var v,L,j;const m=(L=(v=zt.exec(w))==null?void 0:v[1])!=null?L:"default";return(j=d==null?void 0:d[m])!=null?j:m}),y=(x=u==null?void 0:u.default)!=null?x:h[0];a[p]={_meshes:f,list:h,default:y},Object.defineProperties(a[p],{current:{get(){var j;const w=f.filter(({visible:D})=>D).length;if(w===0)return"None";if(w!==1)return"custom";const v=(j=f.find(({visible:D})=>D).name.match(zt))==null?void 0:j[1];return(d==null?void 0:d[v!=null?v:"default"])||"default"},set(w){if(w.toLowerCase()==="none"){this._meshes.forEach((v,L)=>{v.visible=!1});return}if(!this.list.includes(w))return;const m=this.list.indexOf(w);this._meshes.forEach((v,L)=>{v.visible=L===m})}},index:{get(){return this.current==="custom"?NaN:this.list.indexOf(this.current)},set(w){this._meshes.forEach((m,v)=>{m.visible=v===Number(w)})}},reset:{value:function(){this.current=this.default}}})}),a.reset(),r.parts=a,r}const Dr=r=>e=>{const t=e.meshes,n=b(b({},U),r),{type:s}=n;Ot(t,{force:!0,matType:s});let a={type:s,showTexture:!0},i=ke(s);const l={get code(){const{type:o,propList:c}=this,u=[];return o!==U.type&&u.push(`type=${o}`),c.forEach(d=>{const f=sr[d],h=f(this[d]),y=f(U[d]);h!==y&&u.push(`${d}=${h}`)}),u.join("/").replace(/#/g,"")},set code(o){const c=Object.keys(U),u=b(b({},U),It(o));c.forEach(p=>{this[p]=u[p]})},toString(){const{code:o}=this;return o?`mat=(${o})`:""},get list(){return t.flatMap(({material:o})=>o)},get propList(){return i},set type(o){if(this.type===o)return;i=ke(o),Ot(t,{matType:o}),a.type=o;const c=b({},a);a={showTexture:c.showTexture},i.forEach(u=>this[u]=c[u]),a=c},set flatShading(o){const c=$(o);c!==this.flatShading&&(a.flatShading=c,!!this.propList.includes("flatShading")&&this.list.forEach(u=>{u.flatShading=c,u.needsUpdate=!0}))},set gradientMap(o){var p,d;if(o===this.gradientMap||(a.gradientMap=o,!this.propList.includes("gradientMap")))return;const c=(p=this.list[0])==null?void 0:p.gradientMap;(d=c==null?void 0:c.dispose)==null||d.call(c);const u=o==="none"?null:kt(o);this.list.forEach(f=>{f.gradientMap=u,f.needsUpdate=!0})},set showTexture(o){const c=$(o);if(this.showTexture===c)return;a.showTexture=c;const u=c?p=>{p.map=p.userData.backupMap,p.userData.backupMap=null,p.needsUpdate=!0}:p=>{p.userData.backupMap=p.map,p.map=null,p.needsUpdate=!0};this.list.forEach(u)},set matcap(o){var p,d;if(a.matcap===o||(a.matcap=o,!this.propList.includes("matcap")))return;const c=(p=this.list[0])==null?void 0:p.matcap;(d=c==null?void 0:c.dispose)==null||d.call(c);const u=_t(o);this.list.forEach(f=>{f.matcap=u,f.needsUpdate=!0})}};return Zs.forEach(o=>Object.defineProperty(l,o,b({get(){return a[o]}},!Dt.includes(o)&&{set(c){c!==this[o]&&(a[o]=c,!!this.propList.includes(o)&&this.list.forEach(u=>u[o]=nr[o](c)))}}))),ke(s).forEach(o=>l[o]=n[o]),a=b(b({},U),a),e.material=he(l),e};var Or=`uniform float opacity;\r
uniform vec3 color;\r
\r
void main() {\r
	gl_FragColor = vec4( color, opacity );\r
}\r
`,kr=`uniform float size;\r
\r
#include <skinning_pars_vertex>\r
\r
void main() {\r
	#include <skinbase_vertex>\r
	\r
    vec3 transformed = position + normal * 0.0005 * size;\r
        \r
	#include <skinning_vertex>\r
	#include <project_vertex>\r
}`;const _r=r=>new Ae({side:$n,transparent:!0,depthFunc:Vn,vertexShader:kr,fragmentShader:Or,uniforms:r});function Rr(r,e){const{material:t}=r,n=Array.isArray(r.material);[t].flat().forEach(Gs),r.material=n?new Array(r.material.length).fill(e):e}function Fr(r,e){const t=_r(e),n=[],s=["Eff","Extension"];return r.forEach(a=>{const{name:i}=a;if(s.some(o=>i.includes(o)))return;const l=a.clone();l.name=`outline-${a.name}`,Rr(l,t),a.isSkinnedMesh&&l.bind(a.skeleton,a.bindMatrix),a.add(l),n.push(l)}),n}const Br={size:parseFloat,opacity:parseFloat,color:fe},jr=r=>e=>{const t=b(b({},H),r),n=e.meshes,s={size:{value:t.size},opacity:{value:t.opacity},color:{value:new I(t.color)}},a=Fr(n,s),i=V(b({},t),{enabled:!0}),l={get propList(){return["enabled","color","size","opacity"]},get enabled(){return i.enabled},set enabled(o){const c=$(o);a.forEach(u=>u.visible=c),i.enabled=c},get code(){if(!this.enabled)return"none";const o=[];return Object.keys(H).forEach(c=>{const u=this[c];u!==H[c]&&o.push(`${c}=${u}`)}),o.join("/").replace(/#/g,"")},set code(o){if(o==="none"){this.enabled=!1;return}const c=Object.keys(H),u=b(b({},H),It(o));c.forEach(p=>{this[p]=u[p]})},toString(){const{code:o}=this;return o?`ol=(${o})`:""}};return["size","opacity","color"].forEach(o=>Object.defineProperty(l,o,{get(){return i[o]},set(c){c!==this[o]&&(i[o]=c,s[o].value=Br[o](c))}})),l.enabled=t.enabled,e.outline=he(l),e};function Wt(r){return r.split(">").map($r)}function $r(r){const[e,...t]=r.split("&"),n=Vr(t);return b({aniName:e},n)}function Vr(r){const e={},t=[],n={r:{name:"reps",map:parseInt},ts:{name:"timeScale",map:parseFloat},dur:{name:"duration",map:Ur}};return r.forEach(s=>{const[a,i]=Et(s);if(a.startsWith("@")){const c=Nr(i.replace(/[()]/g,""));c.time=parseFloat(a.slice(1)),t.push(c);return}if(!n[a])return;const{name:l,map:o}=n[a];e[l]=o(i)}),e.aniAction=t.filter(({time:s})=>s<=100&&s>=0).sort((s,a)=>s.time-a.time),e}function Ur(r){if(!r)return[0,100];const e=r.split("-").slice(0,2).map(parseFloat),t=e.length===2?e:[0,e[0]];return t.some(n=>n>100||n<0)||t[0]>t[1]?[0,100]:t}function Nr(r){return r.split("/").reduce((t,n)=>{const[s,a]=Et(n);return b(b({},t),zr(s,a))},{})}const Gt={ei:{name:"face.eyeIdx",valueMap:parseInt},mi:{name:"face.mouthIdx",valueMap:parseInt},et:{name:"face.eyeTexture"},mt:{name:"face.mouthTexture"}};function zr(r,e){var s;if(r in Gt){const{name:a,valueMap:i}=Gt[r];return{[a]:(s=i==null?void 0:i(e))!=null?s:e}}let t=r,n=e;return r.startsWith("att")&&t.replace("att","attachment"),r.startsWith("parts")&&(t+="index",n=parseInt(e)),{[t]:n}}const Wr=r=>`${mt}/${r}.json`;function Gr(r){if(r.startsWith("fbx:"))return Xr(r);const e=Wr(r);return new Promise(t=>fetch(e).then(n=>n.json()).then(n=>tt.parse(n)).then(t))}async function Xr(r){const e=r.replace("fbx:",""),[t,n]=e.split("+");console.log(t);const{animations:s}=await Pt(t);return n?s.find(({name:a})=>a===n):s[0]}function Hr(r){return Promise.all(r.map(Gr))}function qr(r,e=[]){return r.map((t,n)=>{const s=e[n];if(!s||s[0]===0&&s[1]===100)return t;const a=t.duration*_e,[i,l]=s.map(o=>Math.round(o*a/100));return Un.subclip(t,t.name,i,l,_e)})}async function Kr(r){const e=Wt(r),t=e.map(({aniName:o})=>o),n=e.map(({duration:o})=>o),s=e.map(p=>{var d=p,{aniName:o,duration:c}=d,u=z(d,["aniName","duration"]);return b({},u)}),a=await Hr(t),i=qr(a,n);return{code:r,clips:i,mod:s,get duration(){return s.some(({timeScale:c})=>c===0)?1/0:i.map((c,u)=>{var p,d;return c.duration/Math.abs((p=s[u].timeScale)!=null?p:1)*((d=s[u].reps)!=null?d:1)}).reduce((c,u)=>c+u,0)}}}function Yr(r){const{model:e,uniqueId:t}=r,n=new Nn(e),s=V(b({},J),{mixer:n,chain:{},current:{chainName:"",chainCode:"",chainLength:0,aniIdx:0,clipDuration:0,clipTimeScale:1,action:null,aniAction:[],aniActionPointer:0},toString(){var l;const i=(l=this.chain.default)==null?void 0:l.code;return i?`ani=${i}`:""},async addChain(i,{name:l="default",autoplay:o=!0}={}){var u;if(!i||((u=this.chain[l])==null?void 0:u.code)===i)return;n.stopAllAction();const c=await Kr(i);c.clips.forEach(p=>{p.tracks.forEach(d=>{d.name=`${t}|${d.name}`})}),this.chain[l]=c,n.addEventListener("finished",a),o&&this.play(l)},play(i=this.current.chainName||"default"){const l=this.chain[i];!l||(this.current.chainName=i,this.current.chainCode=l.code,this.current.chainLength=l.clips.length,this.aniIdx=0)},pause(){this.current.action&&(this.current.action.paused=!0)},resume(){this.current.action&&(this.current.action.paused=!1)},stop(){n.stopAllAction()},update(i){var p;n.update(i);const{current:l}=this,{action:o,aniAction:c,clipDuration:u}=l;if(!(!c[l.aniActionPointer]||!o))for(;(o==null?void 0:o.time)>((p=c[l.aniActionPointer])==null?void 0:p.time)*u/100;)this.applyAniAction(c[l.aniActionPointer]),this.current.aniActionPointer++},applyAniAction(i){r.dispatchEvent({type:"aniAction",id:t,aniAction:i});const c=i,{time:l}=c,o=z(c,["time"]);Object.entries(o).forEach(([u,p])=>{const d=u.split(".");Tt(r,d,p)})},nextFrame(i=1,l=_e){if(!this.isPaused)return;const{clipTimeScale:o,clipDuration:c,action:u}=this.current,p=i*o/l;if(u.time+=p,u.time>=c){const d=u.time-c;a(),this.pause(),this.current.action.time+=d*this.current.clipTimeScale}},setTime(i){const{clipDuration:l,action:o}=this.current;!l||i>l||(o.time=i)},get isPaused(){var i;return(i=this.current.action)==null?void 0:i.paused},get aniIdx(){return this.current.aniIdx},set aniIdx(i){if(i>=this.current.chainLength)return;this.current.aniIdx=i,this.current.aniActionPointer=0;const l={type:i===0?"chainStart":"chainMove",index:i,uniqueId:t,chainName:this.current.chainName};this.dispatchEvent(l),n.stopAllAction();const o=this.chain[this.current.chainName],c=o.mod[i],{timeScale:u,reps:p,aniAction:d}=c,f=o.clips[i],h=n.clipAction(f);h.timeScale=u!=null?u:1,h.setLoop(zn,p!=null?p:1),this.current.clipDuration=f.duration,this.current.action=h,this.current.aniAction=d,this.current.aniActionPointer=0,this.current.clipTimeScale=u!=null?u:1,h.play()}});function a(){const{aniIdx:i,chainLength:l}=s.current,o=(i+1)%l;if(o===0){s.dispatchEvent({type:"ChainFinished",chainName:s.current.chainName});const{face:c}=r;c&&(c.eyeIdx=c.eyeBaseIdx,c.mouthIdx=c.mouthBaseIdx)}s.aniIdx=o}return r.animation=s,r.addEventListener("TimeUpdated",({dt:i})=>s.update(i)),r}const Zr=["push","pop","shift","unshift","splice","reverse","sort"];class N extends Array{constructor(...e){super(...e);Object.assign(this,J),Zr.forEach(t=>{Object.defineProperty(this,t,{value:(...n)=>{Array.prototype[t].call(this,...n),this.dispatchEvent({type:"change",method:t,args:n})},enumerable:!1})})}remove(e){const t=this.indexOf(e);t!==-1&&this.splice(t,1)}}function Jr(r){const{model:e,bones:t,uniqueId:n}=r,s={};return Object.defineProperty(s,"list",{get(){return Object.values(this).flat()}}),Object.defineProperty(s,"traverse",{value:function(u){this.list.forEach(p=>{var d,f;u(p),(f=(d=p.attachment)==null?void 0:d.traverse)==null||f.call(d,u)})}}),Object.assign(r,{attachment:s,parent:null,parentBone:"",attach:(u,p="root")=>{var f;s[p]=(f=s[p])!=null?f:new N;const d=p==="root"?e:t.find(({name:h})=>h===`${n}|${p}`);!(d==null?void 0:d.add)||(u.detach(),d.add(u.model),s[p].push(u),u.parent=r,u.parentBone=p,r.dispatchEvent({type:"AttachmentChanged"}))},remove:(u,p="")=>{var f,h,y;const d=p||Object.keys(s).find(M=>s[M].indexOf(u)!==-1);!d||((h=(f=s[d]).remove)==null||h.call(f,u),(y=u.model.parent)==null||y.remove(u.model),r.dispatchEvent({type:"AttachmentChanged"}))},detach:()=>{var d;(d=e.parent)==null||d.remove(e);const{parent:u,parentBone:p}=r;!u||(u.remove(r,p),r.parent=r.parentBone=null)},attachTo:(u,p="root")=>{var d;r.detach(),(d=u==null?void 0:u.attach)==null||d.call(u,r,p)}})}function Qr(r){const{material:e,id:t}=r,n=ge.source.fbx,s=Xt(t);Vs(t)&&async function(){const o=l(s),c=new W().load(o);c.encoding=O,c.name=s,e.list.forEach(u=>{var p;return u.map=(p=u.map)!=null?p:c})}();let a=s;Object.defineProperty(r,"texture",{get(){return a},set(o){if(!o){this.texture=s;return}if(o===a)return;const c=l(o),[,u]=i(o),[,p]=i(this.texture),d=e.list.filter(f=>{var h,y,M,x;return((y=(h=f.map)==null?void 0:h.name)==null?void 0:y.includes(p))||((x=(M=f.userData.backupMap)==null?void 0:M.name)==null?void 0:x.includes(p))});!d.length||(async function(){const f=await At(c);f.name=u,d.forEach(h=>{var y,M,x,w;h.map&&((M=(y=h.map).dispose)==null||M.call(y),h.map=f),h.userData.backupMap&&((w=(x=h.userData.backupMap).dispose)==null||w.call(x),h.userData.backupMap=f)})}(),a=o)}});function i(o){const[c,u]=o.split(">"),p=c||t,d=u||Xt(p);return[p,d]}function l(o){const[c,u]=i(o);return`${n}/${c}/${u}.png`}return r}const Xt=r=>r.match(/_[0-9]{2}/)?r:`${r}_01`;var ea=`uniform float uTime;\r
uniform float uSpread;\r
uniform float uThreshold;\r
uniform float uSpeed;\r
uniform float uParticleSize;\r
uniform float uAuraSize;\r
\r
attribute float aRandom;\r
\r
varying float vIsParticle;\r
varying float vRandom;\r
\r
#include <skinning_pars_vertex>\r
void main() {\r
    #include <skinbase_vertex>\r
\r
    vec3 transformed = position + normal * 0.005 * uSpread;\r
\r
    #include <skinning_vertex>\r
\r
    vec3 objectNormal = normal;\r
\r
	#include <skinnormal_vertex>\r
    \r
    vec4 viewPosition = viewMatrix * modelMatrix * vec4(transformed, 1.0);\r
    float yDisplacement = fract( uTime * uSpeed + aRandom ) * 0.1;\r
    viewPosition.y += yDisplacement;\r
    viewPosition.x += sin( uTime * aRandom * uSpeed + aRandom ) * 0.02;\r
    \r
    gl_Position = projectionMatrix * viewPosition;\r
    \r
    objectNormal.z *= objectNormal.z > 0.7 ? -1.0 : 1.0;\r
    vIsParticle = objectNormal.z - uThreshold;\r
\r
    gl_PointSize = vIsParticle > 0.0 ? uParticleSize : uAuraSize;\r
    gl_PointSize /= -viewPosition.z;\r
\r
    vRandom = aRandom;\r
}\r
`,ta=`uniform sampler2D uTexture;\r
\r
uniform float uTime;\r
uniform float uParticleOpacity;\r
uniform float uAuraOpacity;\r
uniform vec3 uColor;\r
uniform vec3 uColor2;\r
\r
varying float vRandom;\r
varying float vIsParticle;\r
\r
void main(){\r
    vec4 textureColor = texture2D( uTexture, gl_PointCoord );\r
    textureColor.a = length( textureColor.rgb ) ;\r
    textureColor.a *= abs( 1.0 - fract( uTime + vRandom ) ) * 0.5;\r
    textureColor.rgb = mix( uColor, uColor2,  textureColor.a * 2.0 );\r
    textureColor.a *= vIsParticle > 0.0 ? uParticleOpacity * 4.0 : uAuraOpacity;\r
\r
    gl_FragColor = textureColor;\r
    gl_FragColor /= vIsParticle > 0.0 ? 2.0 : 4.0;\r
}\r
`;const me=[{name:"time",uName:"uTime",defaultValue:0,valueMap:Number},{name:"speed",uName:"uSpeed",defaultValue:1,valueMap:Number},{name:"particleOpacity",uName:"uParticleOpacity",defaultValue:.3,valueMap:Number},{name:"auraOpacity",uName:"uAuraOpacity",defaultValue:.3,valueMap:Number},{name:"particleSize",uName:"uParticleSize",defaultValue:10,valueMap:Number},{name:"auraSize",uName:"uAuraSize",defaultValue:100,valueMap:Number},{name:"spread",uName:"uSpread",defaultValue:5,valueMap:Number},{name:"threshold",uName:"uThreshold",defaultValue:.3,valueMap:Number},{name:"texture",uName:"uTexture",defaultValue:"img/textures/particle/cloud.png",valueMap:r=>new W().load(r)},{name:"color",uName:"uColor",defaultValue:"#ffffff",valueMap:r=>new I(r)},{name:"color2",uName:"uColor2",defaultValue:"#33ffff",valueMap:r=>new I(r)}],na={aura:["visible",...me.slice(1).map(({name:r})=>r)]},sa=(r="aura")=>(e,t={})=>{if(!!(e==null?void 0:e.length)&&r==="aura")return aa(e,t)};function ra(r){return new Ae({vertexShader:ea,fragmentShader:ta,uniforms:r,transparent:!0,blending:Xn,depthWrite:!1,side:Hn})}function aa(r,e){const t=me.map(o=>{var f;const{uName:c,defaultValue:u,valueMap:p}=o,d=(f=p==null?void 0:p(u))!=null?f:u;return[c,{value:d}]}),n=Object.fromEntries(t),s=ra(n),a=[];r.forEach(o=>{const{name:c}=o.geometry;if(c.startsWith("mEye")||c.startsWith("mMouth"))return;const u=o.geometry.clone(),p=u.attributes.position.count,d=new Float32Array(p).fill(0).map(()=>Math.random()-.5);u.setAttribute("aRandom",new Wn(d,1)),u.deleteAttribute("color"),u.deleteAttribute("uv");const f=new Gn(u,s);f.name="aura",o.isSkinnedMesh&&(f.type="SkinnedMesh",f.isSkinnedMesh=!0,f.skeleton=o.skeleton,f.bindMatrix=o.bindMatrix,f.bindMatrixInverse=o.bindMatrixInverse,f.bindMode=o.bindMode,f.bind=o.bind,f.clone=o.clone,f.initBones=o.initBones,f.normalizeSkinWeights=o.normalizeSkinWeights,f.pose=o.pose,f.updateMatrixWorld=o.updateMatrixWorld),o.add(f),a.push(f)});const i={visible:!0},l={name:"aura",onDispose:()=>{},get list(){return a},get propList(){return na.aura},get visible(){return i.visible},set visible(o){const c=$(o);this.list.forEach(u=>u.visible=c),i.visible=c},dispose(){this.onDispose(),this.list.forEach(o=>{var c,u,p,d,f;(c=o.parent)==null||c.remove(o),(p=(u=o.material).dispose)==null||p.call(u),(f=(d=o.geometry).dispose)==null||f.call(d)})},set code(o){o.split("/").forEach(u=>{const[p,d]=u.split("=");!me.map(({name:f})=>f).includes(p)||(this[p]=d)})}};return me.forEach(o=>{const{name:c,uName:u,defaultValue:p,valueMap:d}=o;i[c]=p,Object.defineProperty(l,c,{get(){return i[c]},set(f){var h;i[c]=f,n[u].value=(h=d==null?void 0:d(f))!=null?h:f}})}),l.onTimeUpdate=({time:o})=>l.time=o,Object.entries(e).forEach(([o,c])=>l[o]=c),l}function ia(r){const{meshes:e}=r,t={list:new N,dispose(){this.list.forEach(n=>{var s;return(s=n.dispose)==null?void 0:s.call(n)})},add(n="aura",s={}){const a=sa(n)(e,s);return a.onDispose=()=>this.list.remove(a),this.list.push(a),r.addEventListener("TimeUpdated",a.onTimeUpdate),a}};return r.particle=t,r}const oa=r=>{var l,o;if(r.dispatchEvent({type:"dispose"}),!r)return;const{model:e,meshes:t,outline:n,particle:s,viewer:a}=r;s==null||s.list.forEach(c=>c.dispose()),((l=e.parent)==null?void 0:l.isScene)&&(e.parent.remove(e),a.loadedModel.remove(r)),(o=r.detach)==null||o.call(r),[t.reverse(),n==null?void 0:n.all].flat().forEach(Hs)};function ca(r){const{x:e,y:t,z:n}=r;return[e,t,n].map(s=>s||"").join()}const la={position:",,",rotation:",,",scale:"1,1,1"},ua={position:"pos",rotation:"rot",scale:"scl"};function pa(r){return Object.assign(r,V(b({},r.isDLModel&&{toString(){const{id:e,animation:t,outline:n,material:s}=this,a=Object.entries(la).map(([i,l])=>{const o=ca(this[i]);return o===l?"":`${ua[i]}=${o}`});return[`id=${e}`,...a,t,n,s].filter(i=>`${i}`).join("/")}}),{dispose(){const{attachment:e,parent:t,parentBone:n}=this;e.list.forEach(s=>s.dispose()),t==null||t.remove(this,n),oa(this)}}))}function da(r,e){const{id:t,material:n,outline:s,viewer:a}=e,i=[Er,Cr,Jr,jr(s),Dr(n),Qr,Mr,Yr,ia,pa],l=V(b({},J),{isDLModel:!0,model:r,id:t,uniqueId:Te(),type:Us(t),viewer:a,userData:{},_time:0,update(o){var c;this._time+=o,(c=this.attachment)==null||c.list.forEach(u=>{var p;return(p=u.update)==null?void 0:p.call(u,o)}),this.dispatchEvent({type:"TimeUpdated",dt:o,time:this._time})},set scale(o){var u;if((u=o.includes)==null?void 0:u.call(o,",")){const[p,d,f]=o.split(",").map(h=>h?parseFloat(h):1);this.model.scale.set(p,d,f);return}const c=Number(o)||1;this.model.scale.set(c,c,c)},get scale(){const{scale:o}=this.model,{x:c,y:u,z:p}=o;return c===u&&c===p?c:[c,u,p].join(",")},set visible(o){this.model.visible=$(o)}});return["position","rotation","visible"].forEach(o=>Object.defineProperty(l,o,{get(){return this.model[o]},enumerable:!0})),r.userData.container=l,Bs(...i)(l)}function Ht({antialias:r="SMAA",renderer:e,scene:t,camera:n}){const s=fa(r),a=new Kn(e,s),i=new Yn(t,n);return a.addPass(i),a}function fa(r="SMAA"){const e=r==="SMAA"?Zn:Jn;return new e(800,600,{minFilter:rt,magFilter:rt,format:qn,encoding:O})}const je={bloom:ma,pixel:ya,afterimage:Ma,sobel:va,halftone:wa,dotscreen:ba,bokeh:xa,smaa:ga};async function ha(r,e){var n;const t=await((n=je[r.toLowerCase()])==null?void 0:n.call(je,e));return t.type=r,t.name=$e[r].name,t}function Q(r,e){Object.defineProperty(r,"propList",{value:e}),e.forEach(t=>{Object.defineProperty(r,t,{get(){return this.uniforms[t].value},set(n){this.uniforms[t].value=n}})})}async function ma({resolution:r=new Y(800,600),strength:e=.3,radius:t=.5,threshold:n=.8}={}){const{UnrealBloomPass:s}=await A(()=>import("./UnrealBloomPass.2c2feffd.js"),["assets/UnrealBloomPass.2c2feffd.js","assets/vendor.fe894b4a.js"]),a=new s(r,e,t,n);return Object.defineProperty(a,"propList",{value:["radius","strength","threshold"],writable:!1}),a}async function ga({renderer:r}){const{SMAAPass:e}=await A(()=>import("./SMAAPass.5b72b438.js"),["assets/SMAAPass.5b72b438.js","assets/vendor.fe894b4a.js"]),t=new Y;r.getSize(t);const n=new e(t.x,t.y);return Object.defineProperty(n,"propList",{value:[],writable:!1}),n}async function ya({renderer:r}){const{ShaderPass:e}=await A(()=>import("./vendor.fe894b4a.js").then(function(a){return a.b7}),[]),{PixelShader:t}=await A(()=>import("./PixelShader.ee1b9117.js"),[]),n=new e(t),s=new Y;return r.getSize(s),s.multiplyScalar(window.devicePixelRatio),n.uniforms.resolution.value=s,Q(n,["pixelSize"]),n.pixelSize=10,n}async function va({renderer:r}){const{ShaderPass:e}=await A(()=>import("./vendor.fe894b4a.js").then(function(a){return a.b7}),[]),{SobelOperatorShader:t}=await A(()=>import("./SobelOperatorShader.590e6b0a.js"),["assets/SobelOperatorShader.590e6b0a.js","assets/vendor.fe894b4a.js"]),n=new Y;r.getSize(n),n.multiplyScalar(window.devicePixelRatio);const s=new e(t);return s.uniforms.resolution.value.x=n.x,s.uniforms.resolution.value.y=n.y,Object.defineProperty(s,"propList",{value:[],writable:!1}),s}async function wa({renderer:r}){const{HalftonePass:e}=await A(()=>import("./HalftonePass.f4615a10.js"),["assets/HalftonePass.f4615a10.js","assets/vendor.fe894b4a.js"]),t=new Y;r.getSize(t);const n=new e(t.x,t.y,{radius:4});return Q(n,["greyscale","radius","scatter","shape"]),n}async function ba(){const{DotScreenPass:r}=await A(()=>import("./DotScreenPass.e3c2913d.js"),["assets/DotScreenPass.e3c2913d.js","assets/vendor.fe894b4a.js"]),e=new r;return Q(e,["scale","center"]),e}async function xa({scene:r,camera:e}){const{BokehPass:t}=await A(()=>import("./BokehPass.bea2eec6.js"),["assets/BokehPass.bea2eec6.js","assets/vendor.fe894b4a.js"]),n=new t(r,e,{});return Q(n,["focus","aperture","aspect"]),n}async function Ma(){const{AfterimagePass:r}=await A(()=>import("./AfterimagePass.354516b9.js"),["assets/AfterimagePass.354516b9.js","assets/vendor.fe894b4a.js"]),e=new r(.7);return Q(e,["damp"]),e}function Pa(r){var i;const{name:e,type:t}=r,n=(i=$e[t].propList)!=null?i:[],s={};return n.forEach(l=>{Object.defineProperty(s,l,{get(){return r[l]},set(o){r[l]=o},enumerable:!0})}),{target:r,name:e,type:t,params:s,id:Te()}}const $e={bloom:{name:"Bloom",propList:["enabled","radius","strength","threshold"]},pixel:{name:"Pixelate",propList:["enabled","pixelSize"]},afterimage:{name:"Afterimage",propList:["enabled","damp"]},sobel:{name:"Sobel",propList:["enabled"]},halftone:{name:"Halftone",propList:["enabled","greyscale","radius","scatter","shape"]},dotscreen:{name:"Dot Screen",propList:["enabled","scale"]},bokeh:{name:"Bokeh",propList:["enabled","focus","aperture","aspect"]},smaa:{name:"SMAA",propList:["enabled"]}};Object.entries($e).map(([r,{name:e}])=>({value:r,label:e}));function qt(r,e){const t=URL.createObjectURL(r),n=document.createElement("a");n.style.display="none",n.href=t,n.download=e,document.body.appendChild(n),n.click(),window.URL.revokeObjectURL(t),document.body.removeChild(n)}function Aa(r,e){const t=document.createElement("a");t.style.display="none",t.href=r,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}async function Ta(r,e){const t=r.length.toString().length,s=(await A(()=>import("./jszip.min.cd32b309.js").then(function(a){return a.j}),["assets/jszip.min.cd32b309.js","assets/vendor.fe894b4a.js"]).then(a=>a.default))();return r.forEach((a,i)=>{const l=i.toString().padStart(t,"0"),o=`${e||"ss"}_${l}.png`,c="data:image/png;base64,".length;s.file(o,a.slice(c,1/0),{base64:!0})}),s.generateAsync({type:"blob"})}async function Kt(r,e){const t=await Ta(r,e);qt(t,`${e}.zip`)}const Ea=["video/mp4;codecs=h264","video/webm;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"],Ve=Ea.filter(MediaRecorder.isTypeSupported);function Sa(r){if(!Ve.length)return;const e=[],t=Ve[0],n={settings:{frameRate:30,fileName:"ani",mimeType:t,appendDate:!0},get supportedMimeTypes(){return Ve},get mimeType(){return this.settings.mimeType},set mimeType(s){this.supportedMimeTypes.includes(s)&&(this.settings.mimeType=s)},start(){if(this.recorder)return;const{fileName:s,frameRate:a,mimeType:i}=this.settings,l=r.captureStream(a||30),o=l.getTracks()[0],c=new MediaRecorder(l,{mimeType:i});c.onstart=()=>e.length=0,c.ondataavailable=({data:u})=>e.push(u),c.onstop=()=>{o.stop(),this.recorder=void 0;const u=this.settings.mimeType.includes("webm")?"webm":"mp4",p=new Blob(e,{type:`video/${u}`}),d=this.settings.appendDate?`_${qs()}`:"",f=`${s||"ani"}${d}.${u}`;qt(p,f)},c.start(),this.recorder=c},get state(){var s,a;return(a=(s=this.recorder)==null?void 0:s.state)!=null?a:"idle"}};return["pause","resume","stop"].forEach(s=>{Object.defineProperty(n,s,{value:()=>{var a;return(a=n.recorder)==null?void 0:a[s]()}})}),n}function La(r){let e=1,t=!1,n=!1;const s=()=>{r.stats.begin(),r.controls.update();const c=t?-e:e,u=r.clock.getDelta()*c;n||r.update(u),r.render(),r.stats.end()};let a=!1;const i=()=>{a||(r.render(),a=!0,setTimeout(()=>a=!1,50))};let l="";return{start(){l!=="active"&&(r.renderer.setAnimationLoop(s),r.controls.removeEventListener("change",i),l="active")},stop(){l!=="inactive"&&(r.renderer.setAnimationLoop(null),r.controls.addEventListener("change",i),l="inactive")},pause(){n=!0},resume(){n=!1},get state(){return l},get timeScale(){return e},set timeScale(c){const u=parseFloat(c);e=isNaN(u)?1:Math.abs(u)},get reverse(){return t},set reverse(c){t=!!c},get paused(){return n},set paused(c){n=!!c}}}function Ia(r){const{canvas:e,scene:t}=r;return{settings:pr,get(s=1){const{noBackground:a,fileName:i}=this.settings,l=a&&!r.postProcessing.enabled;let o;if(r.loop.state==="inactive"||s===1){l&&([t.background,o]=[null,t.background]),r.render();const d=e.toDataURL();l&&(t.background=o),Aa(d,`${i}.png`),r.render();return}let c=0;const u=[];l&&r.addCountedEventListener("beforeRender",()=>[o,t.background]=[t.background,null]);function p(){const d=e.toDataURL("image/png");u.push(d),++c===s&&(l&&r.addCountedEventListener("beforeRender",()=>[o,t.background]=[null,o]),Kt(u,i))}r.addCountedEventListener("afterRender",p,s)},getAllFrames(s=0){const a=r.loadedModel[s],i=a==null?void 0:a.animation.current.chainName;if(!i||a.animation.chain[i].duration===1/0)return;console.log("main thread locked");const o=r.loop.state;r.loop.stop(),a.animation.stop();const c=[],{frameRate:u,noBackground:p}=this.settings,d=1/(u||30);let f=null,h=!0;for(p&&([t.background,f]=[f,t.background]),a.animation.addCountedEventListener("chainFinished",()=>h=!1),a.animation.play();h;){r.update(d);const y=e.toDataURL();c.push(y)}return console.log("main thread unlocked"),p&&([t.background,f]=[f,t.background]),o==="active"&&r.loop.start(),c},downloadAllFrames(s=0){const{fileName:a}=this.settings,i=this.getAllFrames(s);Kt(i,a)}}}const Ca=()=>Promise.all([hr(),mr(),yr(),Sr()]),Yt={directional:Je,ambient:Qe,point:Pe},Zt={directional:Qn,point:es},Da=r=>{var l,o;if(!Yt[r])return null;const i=dr[r],{color:t,intensity:n}=i,s=z(i,["color","intensity"]),a=new Yt[r](t,n);return a.name=(o=(l=a.type)==null?void 0:l.replace)==null?void 0:o.call(l,"Light",""),Zt[r]&&(a.helper=new Zt[r](a),Object.defineProperty(a,"showHelper",{get(){return a.helper.visible},set(c){a.helper.visible=!!c,a.helper.update()}}),a.showHelper=!1),Object.defineProperty(a,"colorCode",{get(){return"#"+this.color.getHexString()},set(c){var u,p;this.color=new I(c),(p=(u=this.helper)==null?void 0:u.update)==null||p.call(u)}}),Object.entries(s).forEach(([c,u])=>{a[c].isVector3?a[c].set(...u):a[c]=u}),a};function Oa(r){const e={list:new N,add:t=>{const n=Da(t);if(!!n)return r.scene.add(n),n.helper&&(r.scene.add(n.helper),n.helper.update()),e.list.push(n),n.remove=()=>{var s,a,i,l,o;e.list.remove(n),n.helper&&((s=n.parent)==null||s.remove(n.helper),(i=(a=n.helper).dispose)==null||i.call(a)),(l=n.parent)==null||l.remove(n),(o=n.dispose)==null||o.call(n)},n}};return e}const ka={mat:{keys:["material","code"],valueMap:r=>r.slice(1,-1)},ol:{keys:["outline","code"],valueMap:r=>r.slice(1,-1)},ei:{keys:["face","eyeBaseIdx"]},et:{keys:["face","eyeTexture"]},mi:{keys:["face","mouthBaseIdx"]},mt:{keys:["face","mouthTexture"]},tx:{keys:["texture"],valueMap:r=>r.replace(/%3E/g,">")},scl:{keys:["scale"]}};async function _a(r){const e=dt(r),t=Object.fromEntries(e),{id:n}=t,s=await this.loadDLModel(n);return Ra(s,t),s}function Ra(r,e){const s=e,{ani:t}=s,n=z(s,["ani"]);t&&r.animation.addChain(t),Object.entries(n).forEach(([a,i])=>{var p;const l=ka[a];if(!l)return;const{keys:o,valueMap:c}=l,u=(p=c==null?void 0:c(i))!=null?p:i;Tt(r,o,u)})}const ze=class{constructor(){_(this,"dataLoaded",!1);_(this,"initData",async()=>{await Ca(),this.dataLoaded=!0});_(this,"_background","");_(this,"model",new N);_(this,"loadedModel",new N);_(this,"loadModelFromCode",_a);_(this,"settings",{outline:H,material:U});_(this,"viewport",{width:0,height:0,set(e,t){this.width=e,this.height=t}});Object.assign(this,J);const e=new ts;this.scene=e,this.background=cr,this.clock=new ns;const t=zs();this.camera=t;const n=Oa(this);this.light=n,n.add("directional"),n.add("ambient");const s=Ns();this.renderer=s,this.canvas=s.domElement,this.screenshot=Ia(this),this.record=Sa(this.canvas),this.controls=new ss(this.camera,this.canvas);const a=this.renderer.capabilities.isWebGL2?"MSAA":"SMAA";this.postProcessing={enabled:!1,passes:new N,composer:Ht({antialias:a,renderer:s,scene:e,camera:t}),async addPass(i,l={}){const o=await ha(i,V(b({},l),{renderer:s,scene:e,camera:t}));this.composer.addPass(o);const c=Pa(o),{passes:u}=this,p=this;return c.remove=()=>{u.remove(c),p.refresh()},u.push(c),o},async refresh(){this.composer=Ht({antialias:a,renderer:s,scene:e,camera:t});const i=this.passes.map(({type:o,params:c})=>({type:o,params:Object.entries(c)}));this.passes.length=0;const{length:l}=i;for(let o=0;o<l;o++){const{type:c,params:u}=i[o],p=await this.addPass(c);u.forEach(([d,f])=>void(p[d]=f))}},updatePasses(i){this.passes.length=0,this.passes.splice(0,0,...i),this.refresh()}},this.stats=new rs,this.loop=La(this),this.loop.start(),console.log("%cDragalia Lost Model Viewer","color:yellow;background-color:black;font-size:1.5rem;text-shadow: 0 0 0.5rem white")}get background(){return this._background}set background(e){var n,s;if(this._background===e)return;this._background="loading",(s=(n=this.scene.background)==null?void 0:n.dispose)==null||s.call(n);const t=this;(async function(){t.scene.background=await Ws(e),t._background=e,e.startsWith("img:")&&t.updateBgAspectRatio()})()}get toneMapping(){var t,n;const{toneMapping:e}=this.renderer;return(n=(t=Object.entries(Re).find(([,s])=>s===e))==null?void 0:t[0])!=null?n:"Unknown"}set toneMapping(e){const t=Re[e]?e:"No Mapping";this.renderer.toneMapping=Re[t]}get pixelRatio(){return this.renderer.getPixelRatio()}set pixelRatio(e){this.renderer.setPixelRatio(e),this.postProcessing.composer.setPixelRatio(e)}get unusedModel(){return this.loadedModel.filter(e=>!this.model.includes(e))}async loadDLModel(e=ur){this.dataLoaded||await this.initData();const t=ze.getModelPath(e),n=await Pt(t);n.name=e;const s={id:e,outline:this.settings.outline,material:this.settings.material,viewer:this},a=da(n,s);return this.loadedModel.push(a),a.addEventListener("dispose",()=>this.loadedModel.remove(a)),a}add(e){e.detach(),this.model.push(e),this.scene.add(e.model),e.parent=this}remove(e){this.model.remove(e),this.scene.remove(e.model)}disposeAllModels(){this.loadedModel.forEach(e=>{var t;return(t=e.dispose)==null?void 0:t.call(e)}),this.model.length=0}static getModelPath(e){return`${this.source.fbx}/${e}/${e}.fbx`}async setViewport(e,t){var i;await $s(200);const n=e!=null?e:window.innerWidth,s=t!=null?t:window.innerHeight;this.viewport.set(n,s),this.renderer.setSize(n,s);const a=n/s;return this.camera.aspect=a,this.camera.updateProjectionMatrix(),(i=this.postProcessing.composer)==null||i.setSize(n,s),this.background.startsWith("img:")&&this.updateBgAspectRatio(),this}updateBgAspectRatio(){if(!this.background.startsWith("img:"))return;const{width:e,height:t}=this.viewport,n=e/t,{background:s}=this.scene,{naturalWidth:a,naturalHeight:i}=s.image,l=a/i,o=n/l,c=n>l?[1,1/o]:[o,1];s.repeat.set(...c)}update(e){var t;(t=this.animation)==null||t.update(e),this.model.forEach(n=>{var s;return(s=n.update)==null?void 0:s.call(n,e)}),this.loop.state==="inactive"&&this.render()}stopAll(){this.model.forEach(e=>{var t,n;return(n=(t=e.animation)==null?void 0:t.stop)==null?void 0:n.call(t)})}playAll(){this.model.forEach(e=>{var t,n;return(n=(t=e.animation)==null?void 0:t.play)==null?void 0:n.call(t)})}render(){this.dispatchEvent({type:"beforeRender"}),this.postProcessing.enabled?this.postProcessing.composer.render():this.renderer.render(this.scene,this.camera),this.dispatchEvent({type:"afterRender"})}toString(){return"Dragalia Lost Model Viewer"}dispose(){var e,t,n;this.model.forEach(s=>s.dispose()),(t=(e=this.scene.background)==null?void 0:e.dispose)==null||t.call(e),(n=this.renderer.renderLists)==null||n.dispose(),this.renderer.dispose()}};let ge=ze;_(ge,"source",{fbx:ht,ani:mt});const E=new ge;E.initData();E.setViewport();window.addEventListener("resize",()=>E.setViewport());E.canvas.addEventListener("dblclick",Fa);window.viewer=E;window.model=E.model;function Fa(){if(!!ce.fullscreenEnabled){if(!ce.fullscreenElement){ce.requestFullscreen(E.canvas);return}ce.exitFullscreen()}}function Ba(){try{return window.self!==window.top}catch(r){return!0}}let Jt="";const Qt=Ba(),ja=Qt?!1:!window.location.hash.includes("showSettings=false"),$a=Qt?!1:!window.location.hash.includes("showAC=false"),Va=r=>({showSettings:ja,toggleSettings:()=>r(e=>void(e.showSettings=!e.showSettings)),loadingMsg:"",setLoadingMsg:e=>r(t=>void(t.loadingMsg=e)),showTimeControl:$a,toggleTimeControl:()=>r(e=>void(e.showTimeControl=!e.showTimeControl)),sidebar:{open:!0,toggle:()=>r(({sidebar:e})=>void(e.open=!e.open)),chainMaker:!1,toggleChainMaker:()=>r(({sidebar:e})=>void(e.chainMaker=!e.chainMaker)),settings:{tab:"Model",setTab:e=>r(({sidebar:t})=>void(t.settings.tab=e))},modal:{mode:"",handleSelect:void 0,open:(e,t)=>{Jt=E.loop.state,E.loop.stop(),r(({sidebar:n})=>{const{modal:s}=n;s.mode=e,s.handleSelect=t})},close:()=>{Jt==="active"&&E.loop.start(),r(({sidebar:e})=>{const{modal:t}=e;t.mode="",t.handleSelect=void 0})}}},dock:{mode:"",handleSelect:void 0,open:(e="",t)=>r(({dock:n})=>{n.mode=e,n.handleSelect=t}),close:()=>r(({dock:e})=>{e.mode="",e.handleSelect=void 0})}}),Ua=F(()=>A(()=>import("./index.a71339c8.js"),["assets/index.a71339c8.js","assets/vendor.fe894b4a.js","assets/TabBar.e9f630d7.js","assets/ButtonBase.415db68d.js","assets/Popover.81573183.js","assets/ColorPicker.be87e5af.js","assets/ColorPicker.108f083b.css","assets/ColorButton.d73155bf.js","assets/Button.917bbd6b.js","assets/useAppData.977799ba.js","assets/Gallery.e9fc7a5e.js","assets/Box.5574f6c8.js","assets/DialogContext.e1e8d0f9.js","assets/DialogTitle.30aca7f1.js"])),Na=F(()=>A(()=>import("./index.3fdd4d5e.js"),["assets/index.3fdd4d5e.js","assets/vendor.fe894b4a.js","assets/lists.8b7a2f8d.js","assets/ButtonBase.415db68d.js","assets/Popover.81573183.js","assets/useAppData.977799ba.js","assets/LoadSpinner.a05eea0f.js","assets/LoadSpinner.7cf5bf1b.css","assets/filterConfig.45758633.js","assets/filterConfig.b279bade.css","assets/MenuItem.dd1ea573.js","assets/DialogTitle.30aca7f1.js","assets/DialogContext.e1e8d0f9.js","assets/Box.5574f6c8.js","assets/ToggleGroup.7df67400.js","assets/ToggleGroup.92c4548b.css","assets/GlowToggle.82bde0aa.js","assets/GlowToggle.ada43627.css","assets/Gallery.e9fc7a5e.js","assets/styles.9201aeb9.js","assets/styles.a7d845f9.css","assets/index.89b1eb78.js","assets/categories.52451c2b.js"])),za=F(()=>A(()=>import("./index.1f2e6673.js"),["assets/index.1f2e6673.js","assets/index.48b9abd7.css","assets/vendor.fe894b4a.js","assets/lists.8b7a2f8d.js","assets/ButtonBase.415db68d.js","assets/Popover.81573183.js","assets/useAppData.977799ba.js","assets/LoadSpinner.a05eea0f.js","assets/LoadSpinner.7cf5bf1b.css","assets/TabBar.e9f630d7.js","assets/Button.917bbd6b.js","assets/ModelIcon.59ee1480.js","assets/Gallery.e9fc7a5e.js","assets/Box.5574f6c8.js","assets/DialogContext.e1e8d0f9.js","assets/aniFunction.3fa22f4f.js","assets/Selector.0dfdb472.js","assets/Selector.4835a2b1.css","assets/GlowToggle.82bde0aa.js","assets/GlowToggle.ada43627.css","assets/DialogTitle.30aca7f1.js"])),Wa=F(()=>A(()=>import("./index.56478069.js"),["assets/index.56478069.js","assets/index.3a29f120.css","assets/vendor.fe894b4a.js","assets/lists.8b7a2f8d.js","assets/ButtonBase.415db68d.js","assets/Popover.81573183.js","assets/useAppData.977799ba.js","assets/LoadSpinner.a05eea0f.js","assets/LoadSpinner.7cf5bf1b.css","assets/filterConfig.45758633.js","assets/filterConfig.b279bade.css","assets/MenuItem.dd1ea573.js","assets/DialogTitle.30aca7f1.js","assets/DialogContext.e1e8d0f9.js","assets/Box.5574f6c8.js","assets/ToggleGroup.7df67400.js","assets/ToggleGroup.92c4548b.css","assets/GlowToggle.82bde0aa.js","assets/GlowToggle.ada43627.css","assets/index.89b1eb78.js","assets/Gallery.e9fc7a5e.js","assets/useToggleState.f23a187b.js","assets/ModelIcon.59ee1480.js"])),Ga=F(()=>A(()=>import("./ColorSelect.50b199ca.js"),["assets/ColorSelect.50b199ca.js","assets/vendor.fe894b4a.js","assets/ColorPicker.be87e5af.js","assets/ColorPicker.108f083b.css","assets/ColorButton.d73155bf.js","assets/Button.917bbd6b.js","assets/ButtonBase.415db68d.js","assets/DialogTitle.30aca7f1.js","assets/DialogContext.e1e8d0f9.js"])),Xa=F(()=>A(()=>import("./index.ee955b9c.js"),["assets/index.ee955b9c.js","assets/index.be44ea3e.css","assets/vendor.fe894b4a.js","assets/useKey.cbd30048.js","assets/FacePartSelector.43b86640.js","assets/Selector.0dfdb472.js","assets/Selector.4835a2b1.css","assets/GlowToggle.82bde0aa.js","assets/GlowToggle.ada43627.css","assets/getTexturePath.bf27cf14.js","assets/MeshMouthSelect.22898887.js","assets/MeshMouthSelect.cfd3c0f0.css","assets/Box.5574f6c8.js","assets/ButtonBase.415db68d.js","assets/DialogContext.e1e8d0f9.js","assets/Button.917bbd6b.js","assets/DialogTitle.30aca7f1.js"])),Ha=F(()=>A(()=>import("./index.78a7d5e1.js"),["assets/index.78a7d5e1.js","assets/vendor.fe894b4a.js","assets/useToggleState.f23a187b.js","assets/lists.8b7a2f8d.js","assets/ButtonBase.415db68d.js","assets/Popover.81573183.js","assets/useAppData.977799ba.js","assets/LoadSpinner.a05eea0f.js","assets/LoadSpinner.7cf5bf1b.css","assets/FacePartSelector.43b86640.js","assets/Selector.0dfdb472.js","assets/Selector.4835a2b1.css","assets/GlowToggle.82bde0aa.js","assets/GlowToggle.ada43627.css","assets/filterConfig.45758633.js","assets/filterConfig.b279bade.css","assets/MenuItem.dd1ea573.js","assets/DialogTitle.30aca7f1.js","assets/DialogContext.e1e8d0f9.js","assets/Box.5574f6c8.js","assets/ToggleGroup.7df67400.js","assets/ToggleGroup.92c4548b.css","assets/Gallery.e9fc7a5e.js","assets/styles.9201aeb9.js","assets/styles.a7d845f9.css","assets/categories.52451c2b.js"])),en=F(()=>A(()=>import("./index.c061c945.js"),["assets/index.c061c945.js","assets/index.0a4d2222.css","assets/vendor.fe894b4a.js","assets/getTexturePath.bf27cf14.js","assets/MeshMouthSelect.22898887.js","assets/MeshMouthSelect.cfd3c0f0.css","assets/Box.5574f6c8.js","assets/ButtonBase.415db68d.js","assets/DialogContext.e1e8d0f9.js","assets/Button.917bbd6b.js","assets/DialogTitle.30aca7f1.js"])),tn={background:Ua,model:Na,animation:za,weapon:Wa,color:Ga,face:Xa,faceTexture:Ha,eye:({onSelect:r})=>k(en,{part:"eye",onSelect:r}),mouth:({onSelect:r})=>k(en,{part:"mouth",onSelect:r})},qa=(r,e)=>({Component:void 0,props:void 0,openModal:(t,n)=>r(s=>{s.props=n,s.Component=t}),close:()=>r(t=>t.Component=void 0),onClose:void 0,reset:()=>r(t=>{t.Component=t.props=t.onClose=void 0}),getInput:async t=>{if(!tn[t])return null;const{close:n,reset:s}=e(),a=new Promise((i,l)=>{const o=(...c)=>i(c);r(c=>{c.onClose=()=>{l(),n()},c.props={onSelect:o,onAfterSelect:n},c.Component=tn[t]})});try{return await a}catch{return null}finally{s()}},inputModel:()=>e().getInput("model"),inputAni:()=>e().getInput("animation"),inputColor:async()=>{const t=await e().getInput("color");return t==null?void 0:t[0]},inputEye:()=>e().getInput("eye"),inputMouth:()=>e().getInput("mouth")}),Ka=r=>({activeModel:void 0,setActiveModel:e=>r({activeModel:e})}),Ya=r=>(e,t,n)=>r(s=>e(as(s)),t,n),ee=r=>at(Ya(r)),Ue=ee(Va),wi=at(Ka),bi=ee(ft),xi=ee(ft),Mi=ee(ws),Pi=ee(qa),Za="cccccc",Ja="c100001_01",Qa=(r,e="Unknown")=>{const t=Wt(r),{length:n}=t,s=t.map((a,i)=>{const{aniName:l,reps:o=1,timeScale:c=1,duration:u=[0,100],aniAction:p}=a,d=n>1?e+` #${i+1}`:e;return{id:Te(),name:d,aniName:l,reps:o,timeScale:c,duration:u,aniAction:p}});return N.from(s)},nn={ts:{key:"timeScale",defaultValue:1},r:{key:"reps",defaultValue:1}},ei={"face.eyeIdx":"ei","face.mouthIdx":"mi"},Ai=r=>r.map(ti).join(">"),ti=r=>{const{aniName:e}=r,t=ni(r),n=si(r),s=ri(r);return`${e}${t}${n}${s}`},ni=r=>{const e=[];return Object.keys(nn).forEach(t=>{const{key:n,defaultValue:s}=nn[t];r[n]&&r[n]!==s&&e.push(`&${t}=${r[n]}`)}),e.join("")},si=r=>{const{duration:e=[0,100]}=r,[t,n]=e;return t!==0?`&dur=${t}-${n}`:n===100?"":`&dur=${n}`},ri=r=>{const{aniAction:e}=r;if(!e.length)return"";const t=e.map(n=>{const l=n,{time:s}=l,a=z(l,["time"]),i=Object.entries(a).map(([o,c])=>{var u;return`${(u=ei[o])!=null?u:o}=${c}`});return`@${s}=(${i.join("/")})`});return"&"+t.join("&")};function Ne(){const{hash:r}=window.location,e=dt(r),t=Object.fromEntries(e);ai(t),ii(r)}function ai(r){const{bg:e=Za,showAC:t="true",showSettings:n="true"}=r;E.background=e,Ue.setState({showTimeControl:ut(t)}),Ue.setState({showSettings:ut(n)})}async function ii(r){E.disposeAllModels(),setTimeout(async()=>{const e=r.includes("id=")?r:r+`/id=${Ja}`,t=await E.loadModelFromCode(e);E.add(t);const{id:n}=t;if(!r.includes("camPos=")){const a=gr(n);E.camera.position.set(...a)}const s=vr(n);if(E.controls.target.set(...s),!r.includes("ani=")){const a=ys(n);if(a){const{code:i,name:l}=a;t.animation.addChain(i),t.userData.chain=Qa(i,l)}}})}const oi=()=>{const r=Ee(!0);return Se(()=>{r.current=!1},[]),r.current},ci=F(()=>A(()=>import("./index.942e5fe6.js"),["assets/index.942e5fe6.js","assets/index.fac798cb.css","assets/vendor.fe894b4a.js","assets/ButtonBase.415db68d.js","assets/Popover.81573183.js","assets/LoadSpinner.a05eea0f.js","assets/LoadSpinner.7cf5bf1b.css","assets/Box.5574f6c8.js","assets/DialogContext.e1e8d0f9.js","assets/categories.52451c2b.js","assets/useKey.cbd30048.js","assets/ModelIcon.59ee1480.js","assets/useToggleState.f23a187b.js","assets/MenuItem.dd1ea573.js","assets/useAppData.977799ba.js","assets/ColorButton.d73155bf.js","assets/Button.917bbd6b.js","assets/ToggleGroup.7df67400.js","assets/ToggleGroup.92c4548b.css","assets/GlowToggle.82bde0aa.js","assets/GlowToggle.ada43627.css","assets/TabBar.e9f630d7.js","assets/PlayArrow.cc845623.js","assets/getTexturePath.bf27cf14.js","assets/aniFunction.3fa22f4f.js"])),li=F(()=>A(()=>import("./index.30075a7a.js"),["assets/index.30075a7a.js","assets/index.39fe5103.css","assets/vendor.fe894b4a.js","assets/useToggleState.f23a187b.js","assets/GlowToggle.82bde0aa.js","assets/GlowToggle.ada43627.css","assets/Popover.81573183.js","assets/ButtonBase.415db68d.js","assets/MenuItem.dd1ea573.js","assets/Button.917bbd6b.js","assets/PlayArrow.cc845623.js"]));function ui(){const r=oi(),e=Ee(),t=Ee(),{loadingMsg:n,showTimeControl:s,showSettings:a}=Ue();return Se(()=>(r&&(Ne(),gs()),window.addEventListener("hashchange",Ne),()=>window.removeEventListener("hashchange",Ne))),Se(()=>{var i;(i=e.current)==null||i.appendChild(E.canvas)},[]),k(is,null,a&&k(it,{fallback:null},k(ci,null)),k("div",{className:"mount",ref:i=>e.current=i}),k("div",{className:"stats",ref:i=>t.current=i}),n&&k("div",{className:"loading-msg"},n),s&&k(it,{fallback:null},k(li,null)))}os(k(ui,null),document.getElementById("app"));export{N as A,yi as B,xi as C,gi as D,ht as F,A as _,Pi as a,wi as b,Qa as c,tn as d,gr as e,vr as f,ys as g,Mi as h,bi as i,Ta as j,Ai as k,ds as l,gs as m,fi as n,vi as o,$e as p,oi as q,lt as r,le as s,Re as t,Ue as u,E as v,Bt as w,mi as x,hs as y,hi as z};
