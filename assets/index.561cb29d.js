var rn=Object.defineProperty,an=Object.defineProperties;var on=Object.getOwnPropertyDescriptors;var se=Object.getOwnPropertySymbols;var We=Object.prototype.hasOwnProperty,Ge=Object.prototype.propertyIsEnumerable;var we=(r,e,t)=>e in r?rn(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,b=(r,e)=>{for(var t in e||(e={}))We.call(e,t)&&we(r,t,e[t]);if(se)for(var t of se(e))Ge.call(e,t)&&we(r,t,e[t]);return r},U=(r,e)=>an(r,on(e));var W=(r,e)=>{var t={};for(var n in r)We.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&se)for(var n of se(r))e.indexOf(n)<0&&Ge.call(r,n)&&(t[n]=r[n]);return t};var R=(r,e,t)=>(we(r,typeof e!="symbol"?e+"":e,t),t);import{L as cn,a as be,F as ln,T as G,R as Xe,C as He,b as qe,M as xe,c as un,d as I,s as O,E as pn,e as A,G as Ke,B as Ye,P as re,O as Me,f as dn,g as Ze,h as Ae,i as F,S as fn,D as Je,j as hn,k as mn,l as gn,m as yn,V as K,n as vn,A as Qe,o as ae,p as X,U as wn,q as bn,N as et,r as xn,t as tt,Q as ie,u as Y,v as Mn,w as An,x as Pn,y as Tn,z as En,H as Sn,W as Ln,I as Pe,J as nt,K as In,X as st,Y as oe,Z as Cn,_ as Dn,$ as On,a0 as kn,a1 as _n,a2 as Rn,a3 as Fn,a4 as Bn,a5 as jn,a6 as $n,a7 as Vn,a8 as Un,a9 as Nn,aa as zn,ab as Wn,ac as Gn,ad as Xn,ae as Hn,af as qn,ag as Te,ah as rt,ai as Kn,aj as Yn,ak as Zn,al as Jn,am as Qn,an as Z,ao as at,ap as es,aq as ts,ar as ns,as as ss,at as rs,au as as,av as ce,aw as B,ax as k,ay as it,az as is,aA as Ee,aB as Se,aC as ot,aD as os,aE as cs}from"./vendor.ad1e55a4.js";const ls=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}};ls();const us="modulepreload",ct={},ps="/dl-model/",P=function(e,t){return!t||t.length===0?e():Promise.all(t.map(n=>{if(n=`${ps}${n}`,n in ct)return;ct[n]=!0;const s=n.endsWith(".css"),a=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${n}"]${a}`))return;const o=document.createElement("link");if(o.rel=s?"stylesheet":us,s||(o.as="script",o.crossOrigin=""),o.href=n,document.head.appendChild(o),s)return new Promise((u,i)=>{o.addEventListener("load",u),o.addEventListener("error",i)})})).then(()=>e())};function ds(){return new Worker("/dl-model/assets/fetchWorker.6ff9ca49.js",{type:"module"})}const fs=r=>{const e=new ds;return new Promise(t=>{e.addEventListener("message",n=>{e.terminate(),t(n.data)}),e.postMessage(r)})};function lt(){return new Worker("/dl-model/assets/dbWorker.b98a6301.js",{type:"module"})}const ut=(r,e)=>{const t=new lt;return new Promise(n=>{t.addEventListener("message",()=>{n(),t.terminate()}),t.postMessage({type:"put",store:e,value:r})})};function hs(){return new Worker("/dl-model/assets/searchWorker.d631f240.js",{type:"module"})}async function ms(r,e="",t=["name"]){if(!e||!t.length)return r;const n=new hs;return new Promise(s=>{n.addEventListener("message",a=>{n.terminate(),s(a.data)}),n.postMessage({fullList:r,query:e,keys:t})})}const hi=async r=>{const e=Object.values(r).flat();await ut(e,"model"),console.log("Model DB Initialized")},mi=r=>le({type:"get",store:"model",value:r}),gi=r=>le({type:"search",store:"model",index:"name",value:r}),yi=async r=>{const t=(await le({type:"getByKeyRange",store:"model",value:"c100000_00-c199999_99"})).filter(({id:n})=>!n.endsWith("h"));return ms(t,r)},gs=()=>le({type:"getMap",store:"model",index:"name"}),le=r=>{const e=new lt;return new Promise(t=>{e.addEventListener("message",n=>{e.terminate(),t(n.data)}),e.postMessage(r)})},J={},ys=async()=>{if(Object.keys(J).length)return;const r="ani-personal",e=(await fs([r]))[r];Object.assign(J,e)},vi=r=>J[r],vs=r=>{var e,t;return(t=(e=J[r])==null?void 0:e[0])!=null?t:r.startsWith("c")?{name:"Bob",code:"CMN_MWM_03"}:null},wi=async()=>{const r=await gs(),e=Object.entries(J).map(([t,n])=>{const s=r.get(t);return n.map(a=>U(b({},a),{user:t,fullName:`${s} ${a.name}`}))}).flat();await ut(e,"animation")},pt=r=>r==="true",dt={"<":">","(":")","[":"]","{":"}"},ws=r=>{let e="";const t=[],n=[];for(const s of r){if(t.length){e+=s;const a=t.at(-1);s===dt[a]&&t.pop();continue}if(s==="/"){e&&n.push(e),e="";continue}e+=s,s in dt&&t.push(s)}return e&&n.push(e),n},ft=r=>ws(r).reduce((t,n)=>{const[s,...a]=n.split("="),o=a==null?void 0:a.join("=");return s&&o&&t.push([s,o]),t},[]),ht=r=>({indices:[0,0],_indicesCache:{},setIndex:(e,t)=>{r(n=>{var p,d;const{indices:s,_indicesCache:a}=n;s[e]=t;const o=s.slice(0,e+1).join(),u=(p=a[o])!=null?p:[],{length:i}=s;for(let f=0;e+1+f<i;f++)s[e+1+f]=(d=u[f])!=null?d:0;const c=s.slice(e),l=s.slice(0,e).join();l&&(a[l]=c)})},showFilter:!1,toggleFilter:()=>r(e=>{e.showFilter=!e.showFilter}),searchAll:!1,toggleSearchAll:()=>r(e=>{e.searchAll=!e.searchAll})}),bs=r=>({category:"Adventurer",setCategory:e=>r(t=>{t.category=e}),advAni:{category:"home",setCategory:e=>r(t=>{t.advAni.category=e}),home:{gender:"Male",setGender:e=>r(t=>{t.advAni.home.gender=e})},weapon:{type:"Sword",setType:e=>r(t=>{t.advAni.weapon.type=e}),gunMode:"Long",setGunMode:e=>r(t=>{t.advAni.weapon.gunMode=e})},genericSkill:{type:"Sword",setType:e=>r(t=>{t.advAni.genericSkill.type=e})},groupByWeapon:{setGroupWeaponType:(e,t)=>r(n=>{n.advAni.groupByWeapon[e]=t})},uniqueOther:{type:"Sword",setType:e=>r(t=>{t.advAni.uniqueOther.type=e}),selected:"",setSelected:e=>r(t=>{t.advAni.uniqueOther.selected=e})}},extraAni:{category:"Dance",setCategory:e=>r(t=>{t.extraAni.category=e})},personalAni:{source:"",setSource:e=>r(t=>{t.personalAni.source=e}),sourceName:"",setSourceName:e=>r(t=>{t.personalAni.sourceName=e})}}),mt="fbx",gt="animations",xs="img/textures/matcap",ue="data";let y,T,L;class Ms extends cn{constructor(e){super(e)}load(e,t,n,s){const a=this,o=a.path===""?be.extractUrlBase(e):a.path,u=new ln(this.manager);u.setPath(a.path),u.setResponseType("arraybuffer"),u.setRequestHeader(a.requestHeader),u.setWithCredentials(a.withCredentials),u.load(e,function(i){try{t(a.parse(i,o))}catch(c){s?s(c):console.error(c),a.manager.itemError(e)}},n,s)}parse(e,t){if(Ls(e))y=new Ss().parse(e);else{const s=Mt(e);if(!Is(s))throw new Error("THREE.FBXLoader: Unknown format.");if(wt(s)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+wt(s));y=new Es().parse(s)}const n=new G(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new As(n,this.manager).parse(y)}}class As{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){T=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),s=this.parseDeformers(),a=new Ps().parse(s);return this.parseScene(s,a,n),L}parseConnections(){const e=new Map;return"Connections"in y&&y.Connections.connections.forEach(function(n){const s=n[0],a=n[1],o=n[2];e.has(s)||e.set(s,{parents:[],children:[]});const u={ID:a,relationship:o};e.get(s).parents.push(u),e.has(a)||e.set(a,{parents:[],children:[]});const i={ID:s,relationship:o};e.get(a).children.push(i)}),e}parseImages(){const e={},t={};if("Video"in y.Objects){const n=y.Objects.Video;for(const s in n){const a=n[s],o=parseInt(s);if(e[o]=a.RelativeFilename||a.Filename,"Content"in a){const u=a.Content instanceof ArrayBuffer&&a.Content.byteLength>0,i=typeof a.Content=="string"&&a.Content!=="";if(u||i){const c=this.parseImage(n[s]);t[a.RelativeFilename||a.Filename]=c}}}}for(const n in e){const s=e[n];t[s]!==void 0?e[n]=t[s]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,s=n.slice(n.lastIndexOf(".")+1).toLowerCase();let a;switch(s){case"bmp":a="image/bmp";break;case"jpg":case"jpeg":a="image/jpeg";break;case"png":a="image/png";break;case"tif":a="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",n),a="image/tga";break;default:console.warn('FBXLoader: Image type "'+s+'" is not supported.');return}if(typeof t=="string")return"data:"+a+";base64,"+t;{const o=new Uint8Array(t);return window.URL.createObjectURL(new Blob([o],{type:a}))}}parseTextures(e){const t=new Map;if("Texture"in y.Objects){const n=y.Objects.Texture;for(const s in n){const a=this.parseTexture(n[s],e);t.set(parseInt(s),a)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const s=e.WrapModeU,a=e.WrapModeV,o=s!==void 0?s.value:0,u=a!==void 0?a.value:0;if(n.wrapS=o===0?Xe:He,n.wrapT=u===0?Xe:He,"Scaling"in e){const i=e.Scaling.value;n.repeat.x=i[0],n.repeat.y=i[1]}return n}loadTexture(e,t){let n;const s=this.textureLoader.path,a=T.get(e.id).children;a!==void 0&&a.length>0&&t[a[0].ID]!==void 0&&(n=t[a[0].ID],(n.indexOf("blob:")===0||n.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let o;const u=e.FileName.slice(-3).toLowerCase();if(u==="tga"){const i=this.manager.getHandler(".tga");i===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),o=new qe):(i.setPath(this.textureLoader.path),o=i.load(n))}else u==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),o=new qe):o=this.textureLoader.load(n);return this.textureLoader.setPath(s),o}parseMaterials(e){const t=new Map;if("Material"in y.Objects){const n=y.Objects.Material;for(const s in n){const a=this.parseMaterial(n[s],e);a!==null&&t.set(parseInt(s),a)}}return t}parseMaterial(e,t){const n=e.id,s=e.attrName;let a=e.ShadingModel;if(typeof a=="object"&&(a=a.value),!T.has(n))return null;const o=this.parseParameters(e,t,n);let u;switch(a.toLowerCase()){case"phong":u=new xe;break;case"lambert":u=new un;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',a),u=new xe;break}return u.setValues(o),u.name=s,u}parseParameters(e,t,n){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=new I().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(s.color=new I().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=new I().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(s.emissive=new I().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(s.opacity=parseFloat(e.Opacity.value)),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=new I().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(s.specular=new I().fromArray(e.SpecularColor.value));const a=this;return T.get(n).children.forEach(function(o){const u=o.relationship;switch(u){case"Bump":s.bumpMap=a.getTexture(t,o.ID);break;case"Maya|TEX_ao_map":s.aoMap=a.getTexture(t,o.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=a.getTexture(t,o.ID),s.map!==void 0&&(s.map.encoding=O);break;case"DisplacementColor":s.displacementMap=a.getTexture(t,o.ID);break;case"EmissiveColor":s.emissiveMap=a.getTexture(t,o.ID),s.emissiveMap!==void 0&&(s.emissiveMap.encoding=O);break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=a.getTexture(t,o.ID);break;case"ReflectionColor":s.envMap=a.getTexture(t,o.ID),s.envMap!==void 0&&(s.envMap.mapping=pn,s.envMap.encoding=O);break;case"SpecularColor":s.specularMap=a.getTexture(t,o.ID),s.specularMap!==void 0&&(s.specularMap.encoding=O);break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=a.getTexture(t,o.ID),s.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",u);break}}),s}getTexture(e,t){return"LayeredTexture"in y.Objects&&t in y.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=T.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in y.Objects){const n=y.Objects.Deformer;for(const s in n){const a=n[s],o=T.get(parseInt(s));if(a.attrType==="Skin"){const u=this.parseSkeleton(o,n);u.ID=s,o.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),u.geometryID=o.parents[0].ID,e[s]=u}else if(a.attrType==="BlendShape"){const u={id:s};u.rawTargets=this.parseMorphTargets(o,n),u.id=s,o.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[s]=u}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach(function(s){const a=t[s.ID];if(a.attrType!=="Cluster")return;const o={ID:s.ID,indices:[],weights:[],transformLink:new A().fromArray(a.TransformLink.a)};"Indexes"in a&&(o.indices=a.Indexes.a,o.weights=a.Weights.a),n.push(o)}),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let s=0;s<e.children.length;s++){const a=e.children[s],o=t[a.ID],u={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if(o.attrType!=="BlendShapeChannel")return;u.geoID=T.get(parseInt(a.ID)).children.filter(function(i){return i.relationship===void 0})[0].ID,n.push(u)}return n}parseScene(e,t,n){L=new Ke;const s=this.parseModels(e.skeletons,t,n),a=y.Objects.Model,o=this;s.forEach(function(i){const c=a[i.ID];o.setLookAtProperties(i,c),T.get(i.ID).parents.forEach(function(p){const d=s.get(p.ID);d!==void 0&&d.add(i)}),i.parent===null&&L.add(i)}),this.bindSkeleton(e.skeletons,t,s),this.createAmbientLight(),this.setupMorphMaterials(),L.traverse(function(i){if(i.userData.transformData){i.parent&&(i.userData.transformData.parentMatrix=i.parent.matrix,i.userData.transformData.parentMatrixWorld=i.parent.matrixWorld);const c=bt(i.userData.transformData);i.applyMatrix4(c),i.updateWorldMatrix()}});const u=new Ts().parse();L.children.length===1&&L.children[0].isGroup&&(L.children[0].animations=u,L=L.children[0]),L.animations=u}parseModels(e,t,n){const s=new Map,a=y.Objects.Model;for(const o in a){const u=parseInt(o),i=a[o],c=T.get(u);let l=this.buildSkeleton(c,e,u,i.attrName);if(!l){switch(i.attrType){case"Camera":l=this.createCamera(c);break;case"Light":l=this.createLight(c);break;case"Mesh":l=this.createMesh(c,t,n);break;case"NurbsCurve":l=this.createCurve(c,t);break;case"LimbNode":case"Root":l=new Ye;break;case"Null":default:l=new Ke;break}l.name=i.attrName?re.sanitizeNodeName(i.attrName):"",l.ID=u}this.getTransformData(l,i),s.set(u,l)}return s}buildSkeleton(e,t,n,s){let a=null;return e.parents.forEach(function(o){for(const u in t){const i=t[u];i.rawBones.forEach(function(c,l){if(c.ID===o.ID){const p=a;a=new Ye,a.matrixWorld.copy(c.transformLink),a.name=s?re.sanitizeNodeName(s):"",a.ID=n,i.bones[l]=a,p!==null&&a.add(p)}})}}),a}createCamera(e){let t,n;if(e.children.forEach(function(s){const a=y.Objects.NodeAttribute[s.ID];a!==void 0&&(n=a)}),n===void 0)t=new Me;else{let s=0;n.CameraProjectionType!==void 0&&n.CameraProjectionType.value===1&&(s=1);let a=1;n.NearPlane!==void 0&&(a=n.NearPlane.value/1e3);let o=1e3;n.FarPlane!==void 0&&(o=n.FarPlane.value/1e3);let u=window.innerWidth,i=window.innerHeight;n.AspectWidth!==void 0&&n.AspectHeight!==void 0&&(u=n.AspectWidth.value,i=n.AspectHeight.value);const c=u/i;let l=45;n.FieldOfView!==void 0&&(l=n.FieldOfView.value);const p=n.FocalLength?n.FocalLength.value:null;switch(s){case 0:t=new Ze(l,c,a,o),p!==null&&t.setFocalLength(p);break;case 1:t=new dn(-u/2,u/2,i/2,-i/2,a,o);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+s+"."),t=new Me;break}}return t}createLight(e){let t,n;if(e.children.forEach(function(s){const a=y.Objects.NodeAttribute[s.ID];a!==void 0&&(n=a)}),n===void 0)t=new Me;else{let s;n.LightType===void 0?s=0:s=n.LightType.value;let a=16777215;n.Color!==void 0&&(a=new I().fromArray(n.Color.value));let o=n.Intensity===void 0?1:n.Intensity.value/100;n.CastLightOnObject!==void 0&&n.CastLightOnObject.value===0&&(o=0);let u=0;n.FarAttenuationEnd!==void 0&&(n.EnableFarAttenuation!==void 0&&n.EnableFarAttenuation.value===0?u=0:u=n.FarAttenuationEnd.value);const i=1;switch(s){case 0:t=new Ae(a,o,u,i);break;case 1:t=new Je(a,o);break;case 2:let c=Math.PI/3;n.InnerAngle!==void 0&&(c=F.degToRad(n.InnerAngle.value));let l=0;n.OuterAngle!==void 0&&(l=F.degToRad(n.OuterAngle.value),l=Math.max(l,1)),t=new fn(a,o,u,c,l,i);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new Ae(a,o);break}n.CastShadows!==void 0&&n.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,n){let s,a=null,o=null;const u=[];return e.children.forEach(function(i){t.has(i.ID)&&(a=t.get(i.ID)),n.has(i.ID)&&u.push(n.get(i.ID))}),u.length>1?o=u:u.length>0?o=u[0]:(o=new xe({color:13421772}),u.push(o)),"color"in a.attributes&&u.forEach(function(i){i.vertexColors=!0}),a.FBX_Deformer?(s=new hn(a,o),s.normalizeSkinWeights()):s=new mn(a,o),s}createCurve(e,t){const n=e.children.reduce(function(a,o){return t.has(o.ID)&&(a=t.get(o.ID)),a},null),s=new gn({color:3342591,linewidth:1});return new yn(n,s)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?n.eulerOrder=xt(t.RotationOrder.value):n.eulerOrder="ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){"LookAtProperty"in t&&T.get(e.ID).children.forEach(function(s){if(s.relationship==="LookAtProperty"){const a=y.Objects.Model[s.ID];if("Lcl_Translation"in a){const o=a.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(o),L.add(e.target)):e.lookAt(new K().fromArray(o))}}})}bindSkeleton(e,t,n){const s=this.parsePoseNodes();for(const a in e){const o=e[a];T.get(parseInt(o.ID)).parents.forEach(function(i){if(t.has(i.ID)){const c=i.ID;T.get(c).parents.forEach(function(p){n.has(p.ID)&&n.get(p.ID).bind(new vn(o.bones),s[p.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in y.Objects){const t=y.Objects.Pose;for(const n in t)if(t[n].attrType==="BindPose"){const s=t[n].PoseNode;Array.isArray(s)?s.forEach(function(a){e[a.Node]=new A().fromArray(a.Matrix.a)}):e[s.Node]=new A().fromArray(s.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in y&&"AmbientColor"in y.GlobalSettings){const e=y.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],s=e[2];if(t!==0||n!==0||s!==0){const a=new I(t,n,s);L.add(new Qe(a,1))}}}setupMorphMaterials(){const e=this;L.traverse(function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach(function(n,s){e.setupMorphMaterial(t,n,s)}):e.setupMorphMaterial(t,t.material))})}setupMorphMaterial(e,t,n){const s=e.uuid,a=t.uuid;let o=!1;if(L.traverse(function(u){u.isMesh&&(Array.isArray(u.material)?u.material.forEach(function(i){i.uuid===a&&u.uuid!==s&&(o=!0)}):u.material.uuid===a&&u.uuid!==s&&(o=!0))}),o===!0){const u=t.clone();u.morphTargets=!0,n===void 0?e.material=u:e.material[n]=u}else t.morphTargets=!0}}class Ps{parse(e){const t=new Map;if("Geometry"in y.Objects){const n=y.Objects.Geometry;for(const s in n){const a=T.get(parseInt(s)),o=this.parseGeometry(a,n[s],e);t.set(parseInt(s),o)}}return t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const s=n.skeletons,a=[],o=e.parents.map(function(p){return y.Objects.Model[p.ID]});if(o.length===0)return;const u=e.children.reduce(function(p,d){return s[d.ID]!==void 0&&(p=s[d.ID]),p},null);e.children.forEach(function(p){n.morphTargets[p.ID]!==void 0&&a.push(n.morphTargets[p.ID])});const i=o[0],c={};"RotationOrder"in i&&(c.eulerOrder=xt(i.RotationOrder.value)),"InheritType"in i&&(c.inheritType=parseInt(i.InheritType.value)),"GeometricTranslation"in i&&(c.translation=i.GeometricTranslation.value),"GeometricRotation"in i&&(c.rotation=i.GeometricRotation.value),"GeometricScaling"in i&&(c.scale=i.GeometricScaling.value);const l=bt(c);return this.genGeometry(t,u,a,l)}genGeometry(e,t,n,s){const a=new ae;e.attrName&&(a.name=e.attrName);const o=this.parseGeoNode(e,t),u=this.genBuffers(o),i=new X(u.vertex,3);if(i.applyMatrix4(s),a.setAttribute("position",i),u.colors.length>0&&a.setAttribute("color",new X(u.colors,3)),t&&(a.setAttribute("skinIndex",new wn(u.weightsIndices,4)),a.setAttribute("skinWeight",new X(u.vertexWeights,4)),a.FBX_Deformer=t),u.normal.length>0){const c=new bn().getNormalMatrix(s),l=new X(u.normal,3);l.applyNormalMatrix(c),a.setAttribute("normal",l)}if(u.uvs.forEach(function(c,l){let p="uv"+(l+1).toString();l===0&&(p="uv"),a.setAttribute(p,new X(u.uvs[l],2))}),o.material&&o.material.mappingType!=="AllSame"){let c=u.materialIndex[0],l=0;if(u.materialIndex.forEach(function(p,d){p!==c&&(a.addGroup(l,d-l,c),c=p,l=d)}),a.groups.length>0){const p=a.groups[a.groups.length-1],d=p.start+p.count;d!==u.materialIndex.length&&a.addGroup(d,u.materialIndex.length-d,c)}a.groups.length===0&&a.addGroup(0,u.materialIndex.length,u.materialIndex[0])}return this.addMorphTargets(a,e,n,s),a}parseGeoNode(e,t){const n={};if(n.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],n.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let s=0;for(;e.LayerElementUV[s];)e.LayerElementUV[s].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[s])),s++}return n.weightTable={},t!==null&&(n.skeleton=t,t.rawBones.forEach(function(s,a){s.indices.forEach(function(o,u){n.weightTable[o]===void 0&&(n.weightTable[o]=[]),n.weightTable[o].push({id:a,weight:s.weights[u]})})})),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,s=0,a=!1,o=[],u=[],i=[],c=[],l=[],p=[];const d=this;return e.vertexIndices.forEach(function(f,h){let g,v=!1;f<0&&(f=f^-1,v=!0);let w=[],E=[];if(o.push(f*3,f*3+1,f*3+2),e.color){const m=pe(h,n,f,e.color);i.push(m[0],m[1],m[2])}if(e.skeleton){if(e.weightTable[f]!==void 0&&e.weightTable[f].forEach(function(m){E.push(m.weight),w.push(m.id)}),E.length>4){a||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),a=!0);const m=[0,0,0,0],x=[0,0,0,0];E.forEach(function(M,_){let C=M,V=w[_];x.forEach(function(ne,D,ye){if(C>ne){ye[D]=C,C=ne;const ve=m[D];m[D]=V,V=ve}})}),w=m,E=x}for(;E.length<4;)E.push(0),w.push(0);for(let m=0;m<4;++m)l.push(E[m]),p.push(w[m])}if(e.normal){const m=pe(h,n,f,e.normal);u.push(m[0],m[1],m[2])}e.material&&e.material.mappingType!=="AllSame"&&(g=pe(h,n,f,e.material)[0]),e.uv&&e.uv.forEach(function(m,x){const M=pe(h,n,f,m);c[x]===void 0&&(c[x]=[]),c[x].push(M[0]),c[x].push(M[1])}),s++,v&&(d.genFace(t,e,o,g,u,i,c,l,p,s),n++,s=0,o=[],u=[],i=[],c=[],l=[],p=[])}),t}genFace(e,t,n,s,a,o,u,i,c,l){for(let p=2;p<l;p++)e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[(p-1)*3]]),e.vertex.push(t.vertexPositions[n[(p-1)*3+1]]),e.vertex.push(t.vertexPositions[n[(p-1)*3+2]]),e.vertex.push(t.vertexPositions[n[p*3]]),e.vertex.push(t.vertexPositions[n[p*3+1]]),e.vertex.push(t.vertexPositions[n[p*3+2]]),t.skeleton&&(e.vertexWeights.push(i[0]),e.vertexWeights.push(i[1]),e.vertexWeights.push(i[2]),e.vertexWeights.push(i[3]),e.vertexWeights.push(i[(p-1)*4]),e.vertexWeights.push(i[(p-1)*4+1]),e.vertexWeights.push(i[(p-1)*4+2]),e.vertexWeights.push(i[(p-1)*4+3]),e.vertexWeights.push(i[p*4]),e.vertexWeights.push(i[p*4+1]),e.vertexWeights.push(i[p*4+2]),e.vertexWeights.push(i[p*4+3]),e.weightsIndices.push(c[0]),e.weightsIndices.push(c[1]),e.weightsIndices.push(c[2]),e.weightsIndices.push(c[3]),e.weightsIndices.push(c[(p-1)*4]),e.weightsIndices.push(c[(p-1)*4+1]),e.weightsIndices.push(c[(p-1)*4+2]),e.weightsIndices.push(c[(p-1)*4+3]),e.weightsIndices.push(c[p*4]),e.weightsIndices.push(c[p*4+1]),e.weightsIndices.push(c[p*4+2]),e.weightsIndices.push(c[p*4+3])),t.color&&(e.colors.push(o[0]),e.colors.push(o[1]),e.colors.push(o[2]),e.colors.push(o[(p-1)*3]),e.colors.push(o[(p-1)*3+1]),e.colors.push(o[(p-1)*3+2]),e.colors.push(o[p*3]),e.colors.push(o[p*3+1]),e.colors.push(o[p*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),t.normal&&(e.normal.push(a[0]),e.normal.push(a[1]),e.normal.push(a[2]),e.normal.push(a[(p-1)*3]),e.normal.push(a[(p-1)*3+1]),e.normal.push(a[(p-1)*3+2]),e.normal.push(a[p*3]),e.normal.push(a[p*3+1]),e.normal.push(a[p*3+2])),t.uv&&t.uv.forEach(function(d,f){e.uvs[f]===void 0&&(e.uvs[f]=[]),e.uvs[f].push(u[f][0]),e.uvs[f].push(u[f][1]),e.uvs[f].push(u[f][(p-1)*2]),e.uvs[f].push(u[f][(p-1)*2+1]),e.uvs[f].push(u[f][p*2]),e.uvs[f].push(u[f][p*2+1])})}addMorphTargets(e,t,n,s){if(n.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const a=this;n.forEach(function(o){o.rawTargets.forEach(function(u){const i=y.Objects.Geometry[u.geoID];i!==void 0&&a.genMorphGeometry(e,t,i,s,u.name)})})}genMorphGeometry(e,t,n,s,a){const o=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],u=n.Vertices!==void 0?n.Vertices.a:[],i=n.Indexes!==void 0?n.Indexes.a:[],c=e.attributes.position.count*3,l=new Float32Array(c);for(let h=0;h<i.length;h++){const g=i[h]*3;l[g]=u[h*3],l[g+1]=u[h*3+1],l[g+2]=u[h*3+2]}const p={vertexIndices:o,vertexPositions:l},d=this.genBuffers(p),f=new X(d.vertex,3);f.name=a||n.attrName,f.applyMatrix4(s),e.morphAttributes.position.push(f)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Normals.a;let a=[];return n==="IndexToDirect"&&("NormalIndex"in e?a=e.NormalIndex.a:"NormalsIndex"in e&&(a=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:a,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.UV.a;let a=[];return n==="IndexToDirect"&&(a=e.UVIndex.a),{dataSize:2,buffer:s,indices:a,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Colors.a;let a=[];return n==="IndexToDirect"&&(a=e.ColorIndex.a),{dataSize:4,buffer:s,indices:a,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const s=e.Materials.a,a=[];for(let o=0;o<s.length;++o)a.push(o);return{dataSize:1,buffer:s,indices:a,mappingType:t,referenceType:n}}parseNurbsGeometry(e){if(et===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new ae;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new ae;const n=t-1,s=e.KnotVector.a,a=[],o=e.Points.a;for(let p=0,d=o.length;p<d;p+=4)a.push(new xn().fromArray(o,p));let u,i;if(e.Form==="Closed")a.push(a[0]);else if(e.Form==="Periodic"){u=n,i=s.length-1-u;for(let p=0;p<n;++p)a.push(a[p])}const l=new et(n,s,a,u,i).getPoints(a.length*12);return new ae().setFromPoints(l)}}class Ts{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const n in t){const s=t[n],a=this.addClip(s);e.push(a)}return e}parseClips(){if(y.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=y.Objects.AnimationCurveNode,t=new Map;for(const n in e){const s=e[n];if(s.attrName.match(/S|R|T|DeformPercent/)!==null){const a={id:s.id,attr:s.attrName,curves:{}};t.set(a.id,a)}}return t}parseAnimationCurves(e){const t=y.Objects.AnimationCurve;for(const n in t){const s={id:t[n].id,times:t[n].KeyTime.a.map(Cs),values:t[n].KeyValueFloat.a},a=T.get(s.id);if(a!==void 0){const o=a.parents[0].ID,u=a.parents[0].relationship;u.match(/X/)?e.get(o).curves.x=s:u.match(/Y/)?e.get(o).curves.y=s:u.match(/Z/)?e.get(o).curves.z=s:u.match(/d|DeformPercent/)&&e.has(o)&&(e.get(o).curves.morph=s)}}}parseAnimationLayers(e){const t=y.Objects.AnimationLayer,n=new Map;for(const s in t){const a=[],o=T.get(parseInt(s));o!==void 0&&(o.children.forEach(function(i,c){if(e.has(i.ID)){const l=e.get(i.ID);if(l.curves.x!==void 0||l.curves.y!==void 0||l.curves.z!==void 0){if(a[c]===void 0){const p=T.get(i.ID).parents.filter(function(d){return d.relationship!==void 0})[0].ID;if(p!==void 0){const d=y.Objects.Model[p.toString()];if(d===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",i);return}const f={modelName:d.attrName?re.sanitizeNodeName(d.attrName):"",ID:d.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};L.traverse(function(h){h.ID===d.id&&(f.transform=h.matrix,h.userData.transformData&&(f.eulerOrder=h.userData.transformData.eulerOrder))}),f.transform||(f.transform=new A),"PreRotation"in d&&(f.preRotation=d.PreRotation.value),"PostRotation"in d&&(f.postRotation=d.PostRotation.value),a[c]=f}}a[c]&&(a[c][l.attr]=l)}else if(l.curves.morph!==void 0){if(a[c]===void 0){const p=T.get(i.ID).parents.filter(function(w){return w.relationship!==void 0})[0].ID,d=T.get(p).parents[0].ID,f=T.get(d).parents[0].ID,h=T.get(f).parents[0].ID,g=y.Objects.Model[h],v={modelName:g.attrName?re.sanitizeNodeName(g.attrName):"",morphName:y.Objects.Deformer[p].attrName};a[c]=v}a[c][l.attr]=l}}}),n.set(parseInt(s),a))}return n}parseAnimStacks(e){const t=y.Objects.AnimationStack,n={};for(const s in t){const a=T.get(parseInt(s)).children;a.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const o=e.get(a[0].ID);n[s]={name:t[s].attrName,layer:o}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach(function(s){t=t.concat(n.generateTracks(s))}),new tt(e.name,-1,t)}generateTracks(e){const t=[];let n=new K,s=new ie,a=new K;if(e.transform&&e.transform.decompose(n,s,a),n=n.toArray(),s=new Y().setFromQuaternion(s,e.eulerOrder).toArray(),a=a.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");o!==void 0&&t.push(o)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const o=this.generateRotationTrack(e.modelName,e.R.curves,s,e.preRotation,e.postRotation,e.eulerOrder);o!==void 0&&t.push(o)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.S.curves,a,"scale");o!==void 0&&t.push(o)}if(e.DeformPercent!==void 0){const o=this.generateMorphTrack(e);o!==void 0&&t.push(o)}return t}generateVectorTrack(e,t,n,s){const a=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(a,t,n);return new Mn(e+"."+s,a,o)}generateRotationTrack(e,t,n,s,a,o){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(F.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(F.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(F.degToRad));const u=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(u,t,n);s!==void 0&&(s=s.map(F.degToRad),s.push(o),s=new Y().fromArray(s),s=new ie().setFromEuler(s)),a!==void 0&&(a=a.map(F.degToRad),a.push(o),a=new Y().fromArray(a),a=new ie().setFromEuler(a).invert());const c=new ie,l=new Y,p=[];for(let d=0;d<i.length;d+=3)l.set(i[d],i[d+1],i[d+2],o),c.setFromEuler(l),s!==void 0&&c.premultiply(s),a!==void 0&&c.multiply(a),c.toArray(p,d/3*4);return new An(e+".quaternion",u,p)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map(function(a){return a/100}),s=L.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Pn(e.modelName+".morphTargetInfluences["+s+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(n,s){return n-s}),t.length>1){let n=1,s=t[0];for(let a=1;a<t.length;a++){const o=t[a];o!==s&&(t[n]=o,s=o,n++)}t=t.slice(0,n)}return t}getKeyframeTrackValues(e,t,n){const s=n,a=[];let o=-1,u=-1,i=-1;return e.forEach(function(c){if(t.x&&(o=t.x.times.indexOf(c)),t.y&&(u=t.y.times.indexOf(c)),t.z&&(i=t.z.times.indexOf(c)),o!==-1){const l=t.x.values[o];a.push(l),s[0]=l}else a.push(s[0]);if(u!==-1){const l=t.y.values[u];a.push(l),s[1]=l}else a.push(s[1]);if(i!==-1){const l=t.z.values[i];a.push(l),s[2]=l}else a.push(s[2])}),a}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const n=e.values[t-1],s=e.values[t]-n,a=Math.abs(s);if(a>=180){const o=a/180,u=s/o;let i=n+u;const c=e.times[t-1],p=(e.times[t]-c)/o;let d=c+p;const f=[],h=[];for(;d<e.times[t];)f.push(d),d+=p,h.push(i),i+=u;e.times=At(e.times,t,f),e.values=At(e.values,t,h)}}}}class Es{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new vt,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach(function(s,a){const o=s.match(/^[\s\t]*;/),u=s.match(/^[\s\t]*$/);if(o||u)return;const i=s.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),c=s.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=s.match("^\\t{"+(t.currentIndent-1)+"}}");i?t.parseNodeBegin(s,i):c?t.parseNodeProperty(s,c,n[++a]):l?t.popStack():s.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(s)}),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map(function(i){return i.trim().replace(/^"/,"").replace(/"$/,"")}),a={name:n},o=this.parseNodeAttr(s),u=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(n,a):n in u?(n==="PoseNode"?u.PoseNode.push(a):u[n].id!==void 0&&(u[n]={},u[n][u[n].id]=u[n]),o.id!==""&&(u[n][o.id]=a)):typeof o.id=="number"?(u[n]={},u[n][o.id]=a):n!=="Properties70"&&(n==="PoseNode"?u[n]=[a]:u[n]=a),typeof o.id=="number"&&(a.id=o.id),o.name!==""&&(a.attrName=o.name),o.type!==""&&(a.attrType=o.type),this.pushStack(a)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",s="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:n,type:s}}parseNodeProperty(e,t,n){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),a=t[2].replace(/^"/,"").replace(/"$/,"").trim();s==="Content"&&a===","&&(a=n.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if(o.name==="Properties70"){this.parseNodeSpecialProperty(e,s,a);return}if(s==="C"){const i=a.split(",").slice(1),c=parseInt(i[0]),l=parseInt(i[1]);let p=a.split(",").slice(3);p=p.map(function(d){return d.trim().replace(/^"/,"")}),s="connections",a=[c,l],Os(a,p),o[s]===void 0&&(o[s]=[])}s==="Node"&&(o.id=a),s in o&&Array.isArray(o[s])?o[s].push(a):s!=="a"?o[s]=a:o.a=a,this.setCurrentProp(o,s),s==="a"&&a.slice(-1)!==","&&(o.a=Ie(a))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=Ie(t.a))}parseNodeSpecialProperty(e,t,n){const s=n.split('",').map(function(l){return l.trim().replace(/^\"/,"").replace(/\s/,"_")}),a=s[0],o=s[1],u=s[2],i=s[3];let c=s[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":c=Ie(c);break}this.getPrevNode()[a]={type:o,type2:u,flag:i,value:c},this.setCurrentProp(this.getPrevNode(),a)}}class Ss{parse(e){const t=new yt(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const s=new vt;for(;!this.endOfContent(t);){const a=this.parseNode(t,n);a!==null&&s.add(a.name,a)}return s}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&~15)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},s=t>=7500?e.getUint64():e.getUint32(),a=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),u=e.getString(o);if(s===0)return null;const i=[];for(let d=0;d<a;d++)i.push(this.parseProperty(e));const c=i.length>0?i[0]:"",l=i.length>1?i[1]:"",p=i.length>2?i[2]:"";for(n.singleProperty=a===1&&e.getOffset()===s;s>e.getOffset();){const d=this.parseNode(e,t);d!==null&&this.parseSubNode(u,n,d)}return n.propertyList=i,typeof c=="number"&&(n.id=c),l!==""&&(n.attrName=l),p!==""&&(n.attrType=p),u!==""&&(n.name=u),n}parseSubNode(e,t,n){if(n.singleProperty===!0){const s=n.propertyList[0];Array.isArray(s)?(t[n.name]=n,n.a=s):t[n.name]=s}else if(e==="Connections"&&n.name==="C"){const s=[];n.propertyList.forEach(function(a,o){o!==0&&s.push(a)}),t.connections===void 0&&(t.connections=[]),t.connections.push(s)}else if(n.name==="Properties70")Object.keys(n).forEach(function(a){t[a]=n[a]});else if(e==="Properties70"&&n.name==="P"){let s=n.propertyList[0],a=n.propertyList[1];const o=n.propertyList[2],u=n.propertyList[3];let i;s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),a.indexOf("Lcl ")===0&&(a=a.replace("Lcl ","Lcl_")),a==="Color"||a==="ColorRGB"||a==="Vector"||a==="Vector3D"||a.indexOf("Lcl_")===0?i=[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:i=n.propertyList[4],t[s]={type:a,type2:o,flag:u,value:i}}else t[n.name]===void 0?typeof n.id=="number"?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:n.name==="PoseNode"?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):t[n.name][n.id]===void 0&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),a=e.getUint32(),o=e.getUint32();if(a===0)switch(t){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}typeof Tn=="undefined"&&console.error("THREE.FBXLoader: External library fflate.min.js required.");const u=En(new Uint8Array(e.getArrayBuffer(o))),i=new yt(u.buffer);switch(t){case"b":case"c":return i.getBooleanArray(s);case"d":return i.getFloat64Array(s);case"f":return i.getFloat32Array(s);case"i":return i.getInt32Array(s);case"l":return i.getInt64Array(s)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class yt{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)==1}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let s=0;s<e;s++)t[s]=this.getUint8();const n=t.indexOf(0);return n>=0&&(t=t.slice(0,n)),be.decodeText(new Uint8Array(t))}}class vt{add(e,t){this[e]=t}}function Ls(r){const e="Kaydara FBX Binary  \0";return r.byteLength>=e.length&&e===Mt(r,0,e.length)}function Is(r){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function n(s){const a=r[s-1];return r=r.slice(t+s),t++,a}for(let s=0;s<e.length;++s)if(n(1)===e[s])return!1;return!0}function wt(r){const e=/FBXVersion: (\d+)/,t=r.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function Cs(r){return r/46186158e3}const Ds=[];function pe(r,e,t,n){let s;switch(n.mappingType){case"ByPolygonVertex":s=r;break;case"ByPolygon":s=e;break;case"ByVertice":s=t;break;case"AllSame":s=n.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+n.mappingType)}n.referenceType==="IndexToDirect"&&(s=n.indices[s]);const a=s*n.dataSize,o=a+n.dataSize;return ks(Ds,n.buffer,a,o)}const Le=new Y,H=new K;function bt(r){const e=new A,t=new A,n=new A,s=new A,a=new A,o=new A,u=new A,i=new A,c=new A,l=new A,p=new A,d=new A,f=r.inheritType?r.inheritType:0;if(r.translation&&e.setPosition(H.fromArray(r.translation)),r.preRotation){const D=r.preRotation.map(F.degToRad);D.push(r.eulerOrder),t.makeRotationFromEuler(Le.fromArray(D))}if(r.rotation){const D=r.rotation.map(F.degToRad);D.push(r.eulerOrder),n.makeRotationFromEuler(Le.fromArray(D))}if(r.postRotation){const D=r.postRotation.map(F.degToRad);D.push(r.eulerOrder),s.makeRotationFromEuler(Le.fromArray(D)),s.invert()}r.scale&&a.scale(H.fromArray(r.scale)),r.scalingOffset&&u.setPosition(H.fromArray(r.scalingOffset)),r.scalingPivot&&o.setPosition(H.fromArray(r.scalingPivot)),r.rotationOffset&&i.setPosition(H.fromArray(r.rotationOffset)),r.rotationPivot&&c.setPosition(H.fromArray(r.rotationPivot)),r.parentMatrixWorld&&(p.copy(r.parentMatrix),l.copy(r.parentMatrixWorld));const h=t.clone().multiply(n).multiply(s),g=new A;g.extractRotation(l);const v=new A;v.copyPosition(l);const w=v.clone().invert().multiply(l),E=g.clone().invert().multiply(w),m=a,x=new A;if(f===0)x.copy(g).multiply(h).multiply(E).multiply(m);else if(f===1)x.copy(g).multiply(E).multiply(h).multiply(m);else{const ye=new A().scale(new K().setFromMatrixScale(p)).clone().invert(),ve=E.clone().multiply(ye);x.copy(g).multiply(h).multiply(ve).multiply(m)}const M=c.clone().invert(),_=o.clone().invert();let C=e.clone().multiply(i).multiply(c).multiply(t).multiply(n).multiply(s).multiply(M).multiply(u).multiply(o).multiply(a).multiply(_);const V=new A().copyPosition(C),ne=l.clone().multiply(V);return d.copyPosition(ne),C=d.clone().multiply(x),C.premultiply(l.invert()),C}function xt(r){r=r||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return r===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[r]}function Ie(r){return r.split(",").map(function(t){return parseFloat(t)})}function Mt(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=r.byteLength),be.decodeText(new Uint8Array(r,e,t))}function Os(r,e){for(let t=0,n=r.length,s=e.length;t<s;t++,n++)r[n]=e[t]}function ks(r,e,t,n){for(let s=t,a=0;s<n;s++,a++)r[a]=e[s];return r}function At(r,e,t){return r.slice(0,e).concat(t).concat(r.slice(e))}const Pt=r=>r&&new Promise(e=>{new Ms().load(r,e)}),Tt=r=>r&&new Promise(e=>{new G().load(r,e)}),_s=["px.png","nx.png","py.png","ny.png","pz.png","nz.png"],Rs=r=>r&&new Promise(e=>{new Sn().setPath(`${r}/`).load(_s,e)}),Fs=["c100007_01","c100007_05","c100007_09","c100034_01","c100035_01","c100036_01","c100037_01","c100041_01"],Bs=async r=>await(await fetch(r)).json(),de=async r=>(await Bs(r)).data,js=(...r)=>e=>r.reduce((t,n)=>n(t),e),$s=r=>[...new Set(r)],$=r=>r==="false"?!1:!!r,Et=(r,e,t)=>{if(!e.length)return;const n=e.pop(),s=e.reduce((a,o)=>a==null?void 0:a[o],r);s&&(s[n]=t)};function Ce(r){return!!/[0-9A-Fa-f]{6}/.test(r)}function fe(r){return Ce(r)&&!r.startsWith("#")?new I(`#${r}`):new I(r)}async function Vs(r=100){return await new Promise(e=>setTimeout(e,r))}function St(r,e="="){const[t,...n]=r.split(e),s=n.join(e);return[t,s]}const Us=r=>r.startsWith("w302"),Lt=([r,...e])=>`${r.toUpperCase()}${e.join("")}`;function Ns(r){var t;return r==="smith"?"dragon":r.endsWith("h")?"story":Fs.includes(r)?"spAdventurer":(t={c:"adventurer",b:"boss",d:"dragon",e:"enemy",h:"high boss",o:"object",r:"raid boss",w:"weapon"}[r[0]])!=null?t:"other"}function zs(r=cr){const e=new Ln(r);return e.outputEncoding=O,e}function Ws(r={}){const{fov:e,aspect:t,near:n,far:s}=b(b({},ur),r);return new Ze(e,t,n,s)}async function Gs(r){if(r.startsWith("img:")){const e=r.replace("img:",""),t=await Tt(e);return t.encoding=O,t.center.set(.5,0),t}if(r.startsWith("sky:")){const e=r.replace("sky:",""),t=await Rs(e);return t.encoding=O,t}if(r==="transparent")return null;if(Ce(r)){const e=r.startsWith("#")?r:`#${r}`;return new I(e)}}function Xs(r){var e,t,n,s;(t=(e=r.map)==null?void 0:e.dispose)==null||t.call(e),(s=(n=r.userData.backupMap)==null?void 0:n.dispose)==null||s.call(n),r.dispose()}const It=r=>{const e=new G().load(r);return e.encoding=O,e};function Hs(r){const e=[],t=[];return r.traverse(n=>{n.isMesh&&e.push(n),n.isBone&&t.push(n)}),[e,t]}function qs(r){var t,n;if(!r)return;[r.material].flat().forEach(s=>{var a,o,u,i,c,l;(o=(a=s.map)==null?void 0:a.dispose)==null||o.call(a),(c=(i=(u=s.userData)==null?void 0:u.backupMap)==null?void 0:i.dispose)==null||c.call(i),(l=s.dispose)==null||l.call(s)}),(n=(t=r.geometry)==null?void 0:t.dispose)==null||n.call(t)}const Ks=()=>{const r=new Date,e=r.toDateString().replace(/ /g,"_"),t=r.toLocaleTimeString().replace(/:/g,"-").replace(/ /g,"");return`${e}_${t}`},Ct=r=>r?r.split("/").reduce((t,n)=>{const[s,a]=n.split("=");return s&&a&&(t[s]=a),t},{}):{};class Dt extends Pe{constructor(e){super();this._matcapCombine=nt,this.emissiveIntensity=1,this.normalMapType=In,this.combine=st,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.lights=!0,this.vertexShader=oe.vertexShader,this.fragmentShader=oe.fragmentShader,this.defines=Object.assign({},oe.defines),Object.defineProperty(this,"matcapCombine",{get:function(){return this._matcapCombine},set:function(n){switch(this._matcapCombine=n,n){case st:this.defines.MATCAP_BLENDING_MULTIPLY=!0,delete this.defines.MATCAP_BLENDING_ADD;break;default:case nt:this.defines.MATCAP_BLENDING_ADD=!0,delete this.defines.MATCAP_BLENDING_MULTIPLY;break}}}),this.uniforms=Cn.clone(oe.uniforms);const t=["specular","shininess","opacity","diffuse","map","matcap","gradientMap","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveMap","bumpMap","bumpScale","normalMap","normalScale","displacemantBias","displacemantMap","displacemantScale","specularMap","alphaMap","envMap","reflectivity","refractionRatio"];for(const n of t)Object.defineProperty(this,n,{get:function(){return this.uniforms[n].value},set:function(s){this.uniforms[n].value=s}});Object.defineProperty(this,"color",Object.getOwnPropertyDescriptor(this,"diffuse")),this.setValues(e)}copy(e){return super.copy(e),this.matcapCombine=e.matcapCombine,this.emissiveIntensity=e.emissiveIntensity,this.normalMapType=e.normalMapType,this.combine=e.combine,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}Dt.prototype.isMMDToonMaterial=!0;const Ys=["color","emissive","specular"],Zs=["wireframe","metalness","opacity","roughness","shininess","transparent","emissiveIntensity"],Ot=["type","flatShading","showTexture","gradientMap","matcap"],Js=[...Ys,...Zs,...Ot],Qs=["transparent","opacity","wireframe","showTexture","color"],er={Basic:[],Toon:["emissive","emissiveIntensity","gradientMap"],Lambert:["emissive","emissiveIntensity"],Phong:["emissive","emissiveIntensity","specular","shininess","flatShading"],Standard:["emissive","emissiveIntensity","metalness","roughness","flatShading"],Matcap:["flatShading","matcap"],MMDToon:["emissive","emissiveIntensity","specular","shininess","matcap","gradientMap","flatShading"]},j=r=>`${r}`,De=r=>Ce(r)?`${r.startsWith("#")?"":"#"}${r}`:r,tr=r=>Array.isArray(r)?r.join(","):r,Oe={wireframe:{name:"Wireframe",type:"boolean",default:!1,valueMap:$,toString:j},showTexture:{name:"Texture",type:"boolean",default:!0,valueMap:$,toString:j},transparent:{name:"Transparent",type:"boolean",default:!1,valueMap:$,toString:j},flatShading:{name:"Flat Shading",type:"boolean",default:!1,valueMap:$,toString:j},color:{name:"Color",type:"color",default:"#ffffff",valueMap:fe,toString:De},emissive:{name:"Emissive",type:"color",default:"#000000",valueMap:fe,toString:De},opacity:{name:"Opacity",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:j},emissiveIntensity:{name:"Emissive Intensity",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:j},specular:{name:"Specular",type:"color",default:"#111111",valueMap:fe,toString:De},metalness:{name:"Metalness",type:"percentage",default:0,min:0,max:1,valueMap:parseFloat,toString:j},roughness:{name:"Roughness",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:j},shininess:{name:"Shininess",type:"number",default:30,min:1,max:100,valueMap:parseFloat,toString:j},gradientMap:{name:"Gradient Map",type:"select",default:"none",valueMap:_t,toString:tr},matcap:{name:"Matcap",type:"select",default:"matcap_fresnel.jpg",valueMap:Rt,toString:j}},nr=Object.fromEntries(Object.entries(Oe).map(([r,{default:e}])=>[r,e])),N=U(b({},nr),{type:"Basic"}),sr=Object.fromEntries(Object.entries(Oe).map(([r,{valueMap:e}])=>[r,e])),rr=Object.fromEntries(Object.entries(Oe).map(([r,{toString:e}])=>[r,e])),ke=r=>[...Qs,...er[r]],ar=(r,e={})=>{if(r==="MMDToon")return new Dt(e);const t=`Mesh${r}Material`;return new _n[t](e)},kt=(r,{matType:e="Basic",texturePath:t="",force:n=!1}={})=>{r.forEach(s=>{const a=[s.material].flat(),o=Array.isArray(s.material);if(!n&&!t){const u=`isMesh${e}Material`;if(!a.some(c=>!c[u]))return}a.forEach((u,i)=>{var p,d,f,h;const c=t?new G().load(t):a[i].map;t&&(c.encoding=O);const l=ar(e);if(l.name=u.name,l.map=c,l.userData.backupMap=u.userData.backupMap,t&&((d=(p=u.map)==null?void 0:p.dispose)==null||d.call(p),(h=(f=u.userData.backupMap)==null?void 0:f.dispose)==null||h.call(f)),u.dispose(),o){s.material[i]=l;return}s.material=l})})},ir=r=>Array.isArray(r)?r:r.split(",").map(e=>parseInt(e));function _t(r){const e=ir(r),t=e.length;if(t<2)return null;const n=Uint8Array.from(e),s=new Dn(n,t,1,On);return s.minFilter=s.magFilter=kn,s.generateMipmaps=!1,s}const or=r=>r.includes("/")||r.includes(":")?r:`${xs}/${r}`;function Rt(r){const e=or(r);return e?It(e):null}const cr={alpha:!0,antialias:!0},lr="#cccccc",ur={type:"Perspective",fov:45,aspect:1,far:300,near:.01},pr="c100001_01",q={enabled:!0,size:5,color:"#000000",opacity:1},dr={noBackground:!0,fileName:"screenshot",frameRate:30},Ft=1,_e=30,fr={directional:{color:"#ffffff",intensity:.8,position:[1,0,2]},ambient:{color:"#444444",intensity:1},point:{color:"#ffffff",intensity:1}},Re={"No Mapping":Rn,Linear:Fn,Reinhard:Bn,Cineon:jn,"ACES Filmic":$n},Q={addEventListener(r,e){var s,a;if(!e)return;this._listeners=(s=this._listeners)!=null?s:{};const t=this._listeners,n=r.toLowerCase();return t[n]=(a=t[n])!=null?a:[],!t[n].includes(e)&&t[n].push(e),e},hasEventListener(r,e){var n;return this._listeners===void 0?!1:!!((n=this._listeners[r.toLowerCase()])==null?void 0:n.includes(e))},removeEventListener(r,e){if(this._listeners===void 0)return;const t=r.toLowerCase(),s=this._listeners[t];if(s!==void 0){const a=s.indexOf(e);a!==-1&&s.splice(a,1)}},dispatchEvent(r){if(this._listeners===void 0)return;const e=this._listeners,t=r.type.toLowerCase(),n=e[t];if(n){r.target=this;const s=n.slice(0);for(let a=0,o=s.length;a<o;a++)s[a].call(this,r)}},addCountedEventListener(r,e,t=1){const n=this;let s=t;function a(o){e.call(n,o),s--,s===0&&n.removeEventListener(r,a)}this.addEventListener(r,a)}},hr={face1:[2,1],face2:[0,0],face3:[1,0],face4:[2,0],face5:[3,0],face6:[0,-1],face7:[1,-1],face8:[2,-1],face9:[3,-1]},Bt={},mr=async()=>{const r=await de(`${ue}/face-offset.json`);Object.assign(Bt,r)},jt=r=>Bt[r]||[0,0],Fe={},gr=async()=>{const r=await de(`${ue}/camera-position.json`);Object.assign(Fe,r)},yr=r=>{var e;return(e=Fe[r])!=null?e:Fe[r[0]]},Be={},vr=async()=>{const r=await de(`${ue}/control-position.json`);Object.assign(Be,r)},wr=r=>{var e;return(e=Be[r])!=null?e:Be[r[0]]},$t=r=>hr[`face${r}`],br=(r,e)=>{const t={x:0,y:0};if(r!==e){const[n,s]=$t(e),[a,o]=$t(r);t.x=a-n,t.y=o-s}return[t.x,t.y]},xr=(r,e)=>{const t={x:0,y:0};if(r!==e){const[n,s]=jt(e),[a,o]=jt(r);t.x=a-n,t.y=o-s}return[t.x,t.y]},he=r=>new Proxy(Object.assign(r,Q),{get(e,t){return e[t]},set(e,t,n){return e[t]=n,e.dispatchEvent({type:"change",propName:t,value:n}),!0}}),Vt=/mEye_[0-9]/m,Ut=/mMouth_[0-9]/m,Mr=/[0-9]{2}/,Nt=["eye","mouth"];function Ar(r){const{type:e,meshes:t}=r;return e==="adventurer"?Pr(r):t.some(({name:s})=>s.match(/mEye|mMouth/))?Tr(r):r}function Pr(r){const{meshes:e,id:t}=r,n=c=>`${mt}/${c}/${c}.png`,s=e.find(({name:c})=>c==="mBodyAll"),a={eyeIdx:2,eyeBaseIdx:2,mouthIdx:2,mouthBaseIdx:2,eyeTexture:t,mouthTexture:t},o={type:"uv"},u=c=>([l,p])=>{var E;if(!s)return;const d=`mt${Lt(c)}CH`,f=(E=s.geometry.groups)==null?void 0:E.find(m=>{var x;return((x=s.material[m.materialIndex])==null?void 0:x.name)===d});if(!f)return;const{start:h,count:g}=f,v=h+g,w=s.geometry.attributes.uv;for(let m=h;m<v;m++){const x=w.getX(m)+.25*l,M=w.getY(m)+.25*p;w.setXY(m,x,M)}w.needsUpdate=!0},i=c=>l=>{var h,g;if(!s)return;const p=`mt${Lt(c)}CH`,d=(g=(h=s.material).find)==null?void 0:g.call(h,({name:v})=>v===p);if(!d)return;const f=n(l);d.map.dispose(),d.map=It(f),d.needsUpdate=!0};return Nt.forEach(c=>{Object.defineProperties(o,{[`${c}Idx`]:{get(){return a[`${c}Idx`]},set(l){const p=parseInt(l),d=this[`${c}Idx`];a[`${c}Idx`]=p;const f=br(p,d);u(c)(f)}},[`${c}BaseIdx`]:{get(){return a[`${c}BaseIdx`]},set(l){a[`${c}BaseIdx`]=l,this[`${c}Idx`]=l}},[`${c}Texture`]:{get(){return a[`${c}Texture`]},set(l){const p=this[`${c}Texture`];a[`${c}Texture`]=l,i(c)(l);const d=xr(l,p);u(c)(d)}}})}),r.face=he(o),r}function Tr(r){const{meshes:e}=r,[t,n]=Er(e);[...t,...n].forEach(i=>i.frustumCulled=!1);const s={eye:t,mouth:n},a={eyeIdx:"",eyeBaseIdx:"",mouthIdx:"",mouthBaseIdx:""},o={eyeList:t,mouthList:n,type:"meshes"},u=i=>c=>{s[i].forEach(l=>{const{name:p}=l,d=Mr.exec(p)[0];l.visible=parseInt(d)===c})};return Nt.forEach(i=>Object.defineProperties(o,{[`${i}Idx`]:{get(){return a[`${i}Idx`]},set(c){const l=parseInt(c);u(i)(l),a[`${i}Idx`]=`${l}`}},[`${i}BaseIdx`]:{get(){return a[`${i}BaseIdx`]},set(c){a[`${i}BaseIdx`]=c,this[`${i}Idx`]=c}}})),o.eyeBaseIdx=Ft,o.mouthBaseIdx=Ft,r.face=he(o),r}function Er(r){const e=r.filter(({name:n})=>n.match(Vt)),t=r.filter(({name:n})=>n.match(Ut));return[e,t]}function Sr(r){const{model:e,uniqueId:t}=r,[n,s]=Hs(e);return Object.defineProperty(s,"list",{value:$s(s.map(({name:a})=>a))}),Object.defineProperty(n,"visible",{get(){return this.filter(({visible:a})=>a)}}),s.forEach(a=>{a.name=`${t}|${a.name}`}),Object.defineProperties(r,{meshes:{get(){return n}},bones:{get(){return s}}})}const zt={},Lr=async()=>{const r=await de(`${ue}/model-parts.json`);Object.assign(zt,r)},Ir=r=>zt[r],Cr=/mParts([A-Za-z]+)/,Wt=/mParts[A-Za-z]+_([A-Za-z]*)/;function Dr(r){const{meshes:e,id:t}=r,n=Ir(t),s=[],a=[];if(e.forEach(c=>{var p;let{name:l}=c;if(!!(l==null?void 0:l.match)){if((l.includes("Effect")||l.includes("Extension"))&&(c.visible=!1),((p=n.custom)==null?void 0:p[l])&&(l=c.name=n.custom[l]),l.match(/mParts/)){s.push(c);return}!l.match(Vt)&&!l.match(Ut)&&a.push(c)}}),!s.length&&a.length<2)return r;const o=Object.defineProperties({},{list:{get(){return Object.keys(this)},enumerable:!1},reset:{value:function(){this.list.forEach(c=>this[c].reset())},enumerable:!1},others:{get(){return a},enumerable:!1}});if(r.parts=o,!s.length)return r;const u=new Set(s.map(({name:c})=>{var l;return(l=Cr.exec(c))==null?void 0:l[1]})),i=c=>s.filter(({name:l})=>l.includes(`mParts${c}`)).sort((l,p)=>l.name>p.name?1:-1);return u.forEach(c=>{var v,w,E;const l=n==null?void 0:n[c],p=(w=(v=l==null?void 0:l.name)==null?void 0:v.replace(/ /g,"_"))!=null?w:c,d=l==null?void 0:l.options,f=i(c);f.forEach(m=>m.frustumCulled=!1);const h=f.map(({name:m})=>{var M,_,C;const x=(_=(M=Wt.exec(m))==null?void 0:M[1])!=null?_:"default";return(C=d==null?void 0:d[x])!=null?C:x}),g=(E=l==null?void 0:l.default)!=null?E:h[0];o[p]={_meshes:f,list:h,default:g},Object.defineProperties(o[p],{current:{get(){var C;const m=f.filter(({visible:V})=>V).length;if(m===0)return"None";if(m!==1)return"custom";const M=(C=f.find(({visible:V})=>V).name.match(Wt))==null?void 0:C[1];return(d==null?void 0:d[M!=null?M:"default"])||"default"},set(m){if(m.toLowerCase()==="none"){this._meshes.forEach((M,_)=>{M.visible=!1});return}if(!this.list.includes(m))return;const x=this.list.indexOf(m);this._meshes.forEach((M,_)=>{M.visible=_===x})}},index:{get(){return this.current==="custom"?NaN:this.list.indexOf(this.current)},set(m){this._meshes.forEach((x,M)=>{x.visible=M===Number(m)})}},reset:{value:function(){this.current=this.default}}})}),o.reset(),r.parts=o,r}const Or=r=>e=>{const t=e.meshes,n=b(b({},N),r),{type:s}=n;kt(t,{force:!0,matType:s});let a={type:s,showTexture:!0},o=ke(s);const u={get code(){const{type:i,propList:c}=this,l=[];return i!==N.type&&l.push(`type=${i}`),c.forEach(d=>{const f=rr[d],h=f(this[d]),g=f(N[d]);h!==g&&l.push(`${d}=${h}`)}),l.join("/").replace(/#/g,"")},set code(i){const c=Object.keys(N),l=b(b({},N),Ct(i));c.forEach(p=>{this[p]=l[p]})},toString(){const{code:i}=this;return i?`mat=(${i})`:""},get list(){return t.flatMap(({material:i})=>i)},get propList(){return o},set type(i){if(this.type===i)return;o=ke(i),kt(t,{matType:i}),a.type=i;const c=b({},a);a={showTexture:c.showTexture},o.forEach(l=>this[l]=c[l]),a=c},set flatShading(i){const c=$(i);c!==this.flatShading&&(a.flatShading=c,!!this.propList.includes("flatShading")&&this.list.forEach(l=>{l.flatShading=c,l.needsUpdate=!0}))},set gradientMap(i){var p,d;if(i===this.gradientMap||(a.gradientMap=i,!this.propList.includes("gradientMap")))return;const c=(p=this.list[0])==null?void 0:p.gradientMap;(d=c==null?void 0:c.dispose)==null||d.call(c);const l=i==="none"?null:_t(i);this.list.forEach(f=>{f.gradientMap=l,f.needsUpdate=!0})},set showTexture(i){const c=$(i);if(this.showTexture===c)return;a.showTexture=c;const l=c?p=>{p.map=p.userData.backupMap,p.userData.backupMap=null,p.needsUpdate=!0}:p=>{p.userData.backupMap=p.map,p.map=null,p.needsUpdate=!0};this.list.forEach(l)},set matcap(i){var p,d;if(a.matcap===i||(a.matcap=i,!this.propList.includes("matcap")))return;const c=(p=this.list[0])==null?void 0:p.matcap;(d=c==null?void 0:c.dispose)==null||d.call(c);const l=Rt(i);this.list.forEach(f=>{f.matcap=l,f.needsUpdate=!0})}};return Js.forEach(i=>Object.defineProperty(u,i,b({get(){return a[i]}},!Ot.includes(i)&&{set(c){c!==this[i]&&(a[i]=c,!!this.propList.includes(i)&&this.list.forEach(l=>l[i]=sr[i](c)))}}))),ke(s).forEach(i=>u[i]=n[i]),a=b(b({},N),a),e.material=he(u),e};var kr=`uniform float opacity;\r
uniform vec3 color;\r
\r
void main() {\r
	gl_FragColor = vec4( color, opacity );\r
}\r
`,_r=`uniform float size;\r
\r
#include <skinning_pars_vertex>\r
\r
void main() {\r
	#include <skinbase_vertex>\r
	\r
    vec3 transformed = position + normal * 0.0005 * size;\r
        \r
	#include <skinning_vertex>\r
	#include <project_vertex>\r
}`;const Rr=r=>new Pe({side:Vn,transparent:!0,depthFunc:Un,vertexShader:_r,fragmentShader:kr,uniforms:r});function Fr(r,e){const{material:t}=r,n=Array.isArray(r.material);[t].flat().forEach(Xs),r.material=n?new Array(r.material.length).fill(e):e}function Br(r,e){const t=Rr(e),n=[],s=["Eff","Extension"];return r.forEach(a=>{const{name:o}=a;if(s.some(i=>o.includes(i)))return;const u=a.clone();u.name=`outline-${a.name}`,Fr(u,t),a.isSkinnedMesh&&u.bind(a.skeleton,a.bindMatrix),a.add(u),n.push(u)}),n}const jr={size:parseFloat,opacity:parseFloat,color:fe},$r=r=>e=>{const t=b(b({},q),r),n=e.meshes,s={size:{value:t.size},opacity:{value:t.opacity},color:{value:new I(t.color)}},a=Br(n,s),o=U(b({},t),{enabled:!0}),u={get propList(){return["enabled","color","size","opacity"]},get enabled(){return o.enabled},set enabled(i){const c=$(i);a.forEach(l=>l.visible=c),o.enabled=c},get code(){if(!this.enabled)return"none";const i=[];return Object.keys(q).forEach(c=>{const l=this[c];l!==q[c]&&i.push(`${c}=${l}`)}),i.join("/").replace(/#/g,"")},set code(i){if(i==="none"){this.enabled=!1;return}const c=Object.keys(q),l=b(b({},q),Ct(i));c.forEach(p=>{this[p]=l[p]})},toString(){const{code:i}=this;return i?`ol=(${i})`:""}};return["size","opacity","color"].forEach(i=>Object.defineProperty(u,i,{get(){return o[i]},set(c){c!==this[i]&&(o[i]=c,s[i].value=jr[i](c))}})),u.enabled=t.enabled,e.outline=he(u),e};function Gt(r){return r.split(">").map(Vr)}function Vr(r){const[e,...t]=r.split("&"),n=Ur(t);return b({aniName:e},n)}function Ur(r){const e={},t=[],n={r:{name:"reps",map:parseInt},ts:{name:"timeScale",map:parseFloat},dur:{name:"duration",map:Nr}};return r.forEach(s=>{const[a,o]=St(s);if(a.startsWith("@")){const c=zr(o.replace(/[()]/g,""));c.time=parseFloat(a.slice(1)),t.push(c);return}if(!n[a])return;const{name:u,map:i}=n[a];e[u]=i(o)}),e.aniAction=t.filter(({time:s})=>s<=100&&s>=0).sort((s,a)=>s.time-a.time),e}function Nr(r){if(!r)return[0,100];const e=r.split("-").slice(0,2).map(parseFloat),t=e.length===2?e:[0,e[0]];return t.some(n=>n>100||n<0)||t[0]>t[1]?[0,100]:t}function zr(r){return r.split("/").reduce((t,n)=>{const[s,a]=St(n);return b(b({},t),Wr(s,a))},{})}const Xt={ei:{name:"face.eyeIdx",valueMap:parseInt},mi:{name:"face.mouthIdx",valueMap:parseInt},et:{name:"face.eyeTexture"},mt:{name:"face.mouthTexture"}};function Wr(r,e){var s;if(r in Xt){const{name:a,valueMap:o}=Xt[r];return{[a]:(s=o==null?void 0:o(e))!=null?s:e}}let t=r,n=e;return r.startsWith("att")&&t.replace("att","attachment"),r.startsWith("parts")&&(t+="index",n=parseInt(e)),{[t]:n}}const Gr=r=>`${gt}/${r}.json`;function Xr(r){if(r.startsWith("fbx:"))return Hr(r);const e=Gr(r);return new Promise(t=>fetch(e).then(n=>n.json()).then(n=>tt.parse(n)).then(t))}async function Hr(r){const e=r.replace("fbx:",""),[t,n]=e.split("+");console.log(t);const{animations:s}=await Pt(t);return n?s.find(({name:a})=>a===n):s[0]}function qr(r){return Promise.all(r.map(Xr))}function Kr(r,e=[]){return r.map((t,n)=>{const s=e[n];if(!s||s[0]===0&&s[1]===100)return t;const a=t.duration*_e,[o,u]=s.map(i=>Math.round(i*a/100));return Nn.subclip(t,t.name,o,u,_e)})}async function Yr(r){const e=Gt(r),t=e.map(({aniName:i})=>i),n=e.map(({duration:i})=>i),s=e.map(p=>{var d=p,{aniName:i,duration:c}=d,l=W(d,["aniName","duration"]);return b({},l)}),a=await qr(t),o=Kr(a,n);return{code:r,clips:o,mod:s,get duration(){return s.some(({timeScale:c})=>c===0)?1/0:o.map((c,l)=>{var p,d;return c.duration/Math.abs((p=s[l].timeScale)!=null?p:1)*((d=s[l].reps)!=null?d:1)}).reduce((c,l)=>c+l,0)}}}function Zr(r){var i;const{model:e,uniqueId:t,bones:n}=r,s=new zn(e),a=(i=n==null?void 0:n.list)!=null?i:[],o=U(b({},Q),{mixer:s,chain:{},current:{chainName:"",chainCode:"",chainLength:0,aniIdx:0,clipDuration:0,clipTimeScale:1,action:null,aniAction:[],aniActionPointer:0},toString(){var l;const c=(l=this.chain.default)==null?void 0:l.code;return c?`ani=${c}`:""},async addChain(c,{name:l="default",autoplay:p=!0}={}){var f;if(!c||((f=this.chain[l])==null?void 0:f.code)===c)return;s.stopAllAction();const d=await Yr(c);d.clips.forEach(h=>{h.tracks=h.tracks.reduce((g,v)=>{const w=v.name.split(".")[0];return a.includes(w)&&(v.name=`${t}|${v.name}`,g.push(v)),g},[])}),this.chain[l]=d,s.addEventListener("finished",u),p&&this.play(l)},play(c=this.current.chainName||"default"){const l=this.chain[c];!l||(this.current.chainName=c,this.current.chainCode=l.code,this.current.chainLength=l.clips.length,this.aniIdx=0)},pause(){this.current.action&&(this.current.action.paused=!0)},resume(){this.current.action&&(this.current.action.paused=!1)},stop(){s.stopAllAction()},update(c){var h;s.update(c);const{current:l}=this,{action:p,aniAction:d,clipDuration:f}=l;if(!(!d[l.aniActionPointer]||!p))for(;(p==null?void 0:p.time)>((h=d[l.aniActionPointer])==null?void 0:h.time)*f/100;)this.applyAniAction(d[l.aniActionPointer]),this.current.aniActionPointer++},applyAniAction(c){r.dispatchEvent({type:"aniAction",id:t,aniAction:c});const d=c,{time:l}=d,p=W(d,["time"]);Object.entries(p).forEach(([f,h])=>{const g=f.split(".");Et(r,g,h)})},nextFrame(c=1,l=_e){if(!this.isPaused)return;const{clipTimeScale:p,clipDuration:d,action:f}=this.current,h=c*p/l;if(f.time+=h,f.time>=d){const g=f.time-d;u(),this.pause(),this.current.action.time+=g*this.current.clipTimeScale}},setTime(c){const{clipDuration:l,action:p}=this.current;!l||c>l||(p.time=c)},get isPaused(){var c;return(c=this.current.action)==null?void 0:c.paused},get aniIdx(){return this.current.aniIdx},set aniIdx(c){if(c>=this.current.chainLength)return;this.current.aniIdx=c,this.current.aniActionPointer=0;const l={type:c===0?"chainStart":"chainMove",index:c,uniqueId:t,chainName:this.current.chainName};this.dispatchEvent(l),s.stopAllAction();const p=this.chain[this.current.chainName],d=p.mod[c],{timeScale:f,reps:h,aniAction:g}=d,v=p.clips[c],w=s.clipAction(v);w.timeScale=f!=null?f:1,w.setLoop(Wn,h!=null?h:1),this.current.clipDuration=v.duration,this.current.action=w,this.current.aniAction=g,this.current.aniActionPointer=0,this.current.clipTimeScale=f!=null?f:1,w.play()}});function u(){const{aniIdx:c,chainLength:l}=o.current,p=(c+1)%l;if(p===0){o.dispatchEvent({type:"ChainFinished",chainName:o.current.chainName});const{face:d}=r;d&&(d.eyeIdx=d.eyeBaseIdx,d.mouthIdx=d.mouthBaseIdx)}o.aniIdx=p}return r.animation=o,r.addEventListener("TimeUpdated",({dt:c})=>o.update(c)),r}const Jr=["push","pop","shift","unshift","splice","reverse","sort"];class z extends Array{constructor(...e){super(...e);Object.assign(this,Q),Jr.forEach(t=>{Object.defineProperty(this,t,{value:(...n)=>{Array.prototype[t].call(this,...n),this.dispatchEvent({type:"change",method:t,args:n})},enumerable:!1})})}remove(e){const t=this.indexOf(e);t!==-1&&this.splice(t,1)}}function Qr(r){const{model:e,bones:t,uniqueId:n}=r,s={};return Object.defineProperty(s,"list",{get(){return Object.values(this).flat()}}),Object.defineProperty(s,"traverse",{value:function(l){this.list.forEach(p=>{var d,f;l(p),(f=(d=p.attachment)==null?void 0:d.traverse)==null||f.call(d,l)})}}),Object.assign(r,{attachment:s,parent:null,parentBone:"",attach:(l,p="root")=>{var f;s[p]=(f=s[p])!=null?f:new z;const d=p==="root"?e:t.find(({name:h})=>h===`${n}|${p}`);!(d==null?void 0:d.add)||(l.detach(),d.add(l.model),s[p].push(l),l.parent=r,l.parentBone=p,r.dispatchEvent({type:"AttachmentChanged"}))},remove:(l,p="")=>{var f,h,g;const d=p||Object.keys(s).find(v=>s[v].indexOf(l)!==-1);!d||((h=(f=s[d]).remove)==null||h.call(f,l),(g=l.model.parent)==null||g.remove(l.model),r.dispatchEvent({type:"AttachmentChanged"}))},detach:()=>{var d;(d=e.parent)==null||d.remove(e);const{parent:l,parentBone:p}=r;!l||(l.remove(r,p),r.parent=r.parentBone=null)},attachTo:(l,p="root")=>{var d;r.detach(),(d=l==null?void 0:l.attach)==null||d.call(l,r,p)}})}function ea(r){const{material:e,id:t}=r,n=ge.source.fbx,s=Ht(t);Us(t)&&async function(){const i=u(s),c=new G().load(i);c.encoding=O,c.name=s,e.list.forEach(l=>{var p;return l.map=(p=l.map)!=null?p:c})}();let a=s;Object.defineProperty(r,"texture",{get(){return a},set(i){if(!i){this.texture=s;return}if(i===a)return;const c=u(i),[,l]=o(i),[,p]=o(this.texture),d=e.list.filter(f=>{var h,g,v,w;return((g=(h=f.map)==null?void 0:h.name)==null?void 0:g.includes(p))||((w=(v=f.userData.backupMap)==null?void 0:v.name)==null?void 0:w.includes(p))});!d.length||(async function(){const f=await Tt(c);f.name=l,d.forEach(h=>{var g,v,w,E;h.map&&((v=(g=h.map).dispose)==null||v.call(g),h.map=f),h.userData.backupMap&&((E=(w=h.userData.backupMap).dispose)==null||E.call(w),h.userData.backupMap=f)})}(),a=i)}});function o(i){const[c,l]=i.split(">"),p=c||t,d=l||Ht(p);return[p,d]}function u(i){const[c,l]=o(i);return`${n}/${c}/${l}.png`}return r}const Ht=r=>r.match(/_[0-9]{2}/)?r:`${r}_01`;var ta=`uniform float uTime;\r
uniform float uSpread;\r
uniform float uThreshold;\r
uniform float uSpeed;\r
uniform float uParticleSize;\r
uniform float uAuraSize;\r
\r
attribute float aRandom;\r
\r
varying float vIsParticle;\r
varying float vRandom;\r
\r
#include <skinning_pars_vertex>\r
void main() {\r
    #include <skinbase_vertex>\r
\r
    vec3 transformed = position + normal * 0.005 * uSpread;\r
\r
    #include <skinning_vertex>\r
\r
    vec3 objectNormal = normal;\r
\r
	#include <skinnormal_vertex>\r
    \r
    vec4 viewPosition = viewMatrix * modelMatrix * vec4(transformed, 1.0);\r
    float yDisplacement = fract( uTime * uSpeed + aRandom ) * 0.1;\r
    viewPosition.y += yDisplacement;\r
    viewPosition.x += sin( uTime * aRandom * uSpeed + aRandom ) * 0.02;\r
    \r
    gl_Position = projectionMatrix * viewPosition;\r
    \r
    objectNormal.z *= objectNormal.z > 0.7 ? -1.0 : 1.0;\r
    vIsParticle = objectNormal.z - uThreshold;\r
\r
    gl_PointSize = vIsParticle > 0.0 ? uParticleSize : uAuraSize;\r
    gl_PointSize /= -viewPosition.z;\r
\r
    vRandom = aRandom;\r
}\r
`,na=`uniform sampler2D uTexture;\r
\r
uniform float uTime;\r
uniform float uParticleOpacity;\r
uniform float uAuraOpacity;\r
uniform vec3 uColor;\r
uniform vec3 uColor2;\r
\r
varying float vRandom;\r
varying float vIsParticle;\r
\r
void main(){\r
    vec4 textureColor = texture2D( uTexture, gl_PointCoord );\r
    textureColor.a = length( textureColor.rgb ) ;\r
    textureColor.a *= abs( 1.0 - fract( uTime + vRandom ) ) * 0.5;\r
    textureColor.rgb = mix( uColor, uColor2,  textureColor.a * 2.0 );\r
    textureColor.a *= vIsParticle > 0.0 ? uParticleOpacity * 4.0 : uAuraOpacity;\r
\r
    gl_FragColor = textureColor;\r
    gl_FragColor /= vIsParticle > 0.0 ? 2.0 : 4.0;\r
}\r
`;const me=[{name:"time",uName:"uTime",defaultValue:0,valueMap:Number},{name:"speed",uName:"uSpeed",defaultValue:1,valueMap:Number},{name:"particleOpacity",uName:"uParticleOpacity",defaultValue:.3,valueMap:Number},{name:"auraOpacity",uName:"uAuraOpacity",defaultValue:.3,valueMap:Number},{name:"particleSize",uName:"uParticleSize",defaultValue:10,valueMap:Number},{name:"auraSize",uName:"uAuraSize",defaultValue:100,valueMap:Number},{name:"spread",uName:"uSpread",defaultValue:5,valueMap:Number},{name:"threshold",uName:"uThreshold",defaultValue:.3,valueMap:Number},{name:"texture",uName:"uTexture",defaultValue:"img/textures/particle/cloud.png",valueMap:r=>new G().load(r)},{name:"color",uName:"uColor",defaultValue:"#ffffff",valueMap:r=>new I(r)},{name:"color2",uName:"uColor2",defaultValue:"#33ffff",valueMap:r=>new I(r)}],sa={aura:["visible",...me.slice(1).map(({name:r})=>r)]},ra=(r="aura")=>(e,t={})=>{if(!!(e==null?void 0:e.length)&&r==="aura")return ia(e,t)};function aa(r){return new Pe({vertexShader:ta,fragmentShader:na,uniforms:r,transparent:!0,blending:Hn,depthWrite:!1,side:qn})}function ia(r,e){const t=me.map(i=>{var f;const{uName:c,defaultValue:l,valueMap:p}=i,d=(f=p==null?void 0:p(l))!=null?f:l;return[c,{value:d}]}),n=Object.fromEntries(t),s=aa(n),a=[];r.forEach(i=>{const{name:c}=i.geometry;if(c.startsWith("mEye")||c.startsWith("mMouth"))return;const l=i.geometry.clone(),p=l.attributes.position.count,d=new Float32Array(p).fill(0).map(()=>Math.random()-.5);l.setAttribute("aRandom",new Gn(d,1)),l.deleteAttribute("color"),l.deleteAttribute("uv");const f=new Xn(l,s);f.name="aura",i.isSkinnedMesh&&(f.type="SkinnedMesh",f.isSkinnedMesh=!0,f.skeleton=i.skeleton,f.bindMatrix=i.bindMatrix,f.bindMatrixInverse=i.bindMatrixInverse,f.bindMode=i.bindMode,f.bind=i.bind,f.clone=i.clone,f.initBones=i.initBones,f.normalizeSkinWeights=i.normalizeSkinWeights,f.pose=i.pose,f.updateMatrixWorld=i.updateMatrixWorld),i.add(f),a.push(f)});const o={visible:!0},u={name:"aura",onDispose:()=>{},get list(){return a},get propList(){return sa.aura},get visible(){return o.visible},set visible(i){const c=$(i);this.list.forEach(l=>l.visible=c),o.visible=c},dispose(){this.onDispose(),this.list.forEach(i=>{var c,l,p,d,f;(c=i.parent)==null||c.remove(i),(p=(l=i.material).dispose)==null||p.call(l),(f=(d=i.geometry).dispose)==null||f.call(d)})},set code(i){i.split("/").forEach(l=>{const[p,d]=l.split("=");!me.map(({name:f})=>f).includes(p)||(this[p]=d)})}};return me.forEach(i=>{const{name:c,uName:l,defaultValue:p,valueMap:d}=i;o[c]=p,Object.defineProperty(u,c,{get(){return o[c]},set(f){var h;o[c]=f,n[l].value=(h=d==null?void 0:d(f))!=null?h:f}})}),u.onTimeUpdate=({time:i})=>u.time=i,Object.entries(e).forEach(([i,c])=>u[i]=c),u}function oa(r){const{meshes:e}=r,t={list:new z,dispose(){this.list.forEach(n=>{var s;return(s=n.dispose)==null?void 0:s.call(n)})},add(n="aura",s={}){const a=ra(n)(e,s);return a.onDispose=()=>this.list.remove(a),this.list.push(a),r.addEventListener("TimeUpdated",a.onTimeUpdate),a}};return r.particle=t,r}const ca=r=>{var u,i;if(r.dispatchEvent({type:"dispose"}),!r)return;const{model:e,meshes:t,outline:n,particle:s,viewer:a}=r;s==null||s.list.forEach(c=>c.dispose()),((u=e.parent)==null?void 0:u.isScene)&&(e.parent.remove(e),a.loadedModel.remove(r)),(i=r.detach)==null||i.call(r),[t.reverse(),n==null?void 0:n.all].flat().forEach(qs)};function la(r){const{x:e,y:t,z:n}=r;return[e,t,n].map(s=>s||"").join()}const ua={position:",,",rotation:",,",scale:"1,1,1"},pa={position:"pos",rotation:"rot",scale:"scl"};function da(r){return Object.assign(r,U(b({},r.isDLModel&&{toString(){const{id:e,animation:t,outline:n,material:s}=this,a=Object.entries(ua).map(([o,u])=>{const i=la(this[o]);return i===u?"":`${pa[o]}=${i}`});return[`id=${e}`,...a,t,n,s].filter(o=>`${o}`).join("/")}}),{dispose(){const{attachment:e,parent:t,parentBone:n}=this;e.list.forEach(s=>s.dispose()),t==null||t.remove(this,n),ca(this)}}))}function fa(r,e){const{id:t,material:n,outline:s,viewer:a}=e,o=[Sr,Dr,Qr,$r(s),Or(n),ea,Ar,Zr,oa,da],u=U(b({},Q),{isDLModel:!0,model:r,id:t,uniqueId:Te(),type:Ns(t),viewer:a,userData:{},_time:0,update(i){var c;this._time+=i,(c=this.attachment)==null||c.list.forEach(l=>{var p;return(p=l.update)==null?void 0:p.call(l,i)}),this.dispatchEvent({type:"TimeUpdated",dt:i,time:this._time})},set scale(i){var l;if((l=i.includes)==null?void 0:l.call(i,",")){const[p,d,f]=i.split(",").map(h=>h?parseFloat(h):1);this.model.scale.set(p,d,f);return}const c=Number(i)||1;this.model.scale.set(c,c,c)},get scale(){const{scale:i}=this.model,{x:c,y:l,z:p}=i;return c===l&&c===p?c:[c,l,p].join(",")},set visible(i){this.model.visible=$(i)}});return["position","rotation","visible"].forEach(i=>Object.defineProperty(u,i,{get(){return this.model[i]},enumerable:!0})),r.userData.container=u,js(...o)(u)}function qt({antialias:r="SMAA",renderer:e,scene:t,camera:n}){const s=ha(r),a=new Yn(e,s),o=new Zn(t,n);return a.addPass(o),a}function ha(r="SMAA"){const e=r==="SMAA"?Jn:Qn;return new e(800,600,{minFilter:rt,magFilter:rt,format:Kn,encoding:O})}const je={bloom:ga,pixel:va,afterimage:Aa,sobel:wa,halftone:ba,dotscreen:xa,bokeh:Ma,smaa:ya};async function ma(r,e){var n;const t=await((n=je[r.toLowerCase()])==null?void 0:n.call(je,e));return t.type=r,t.name=$e[r].name,t}function ee(r,e){Object.defineProperty(r,"propList",{value:e}),e.forEach(t=>{Object.defineProperty(r,t,{get(){return this.uniforms[t].value},set(n){this.uniforms[t].value=n}})})}async function ga({resolution:r=new Z(800,600),strength:e=.3,radius:t=.5,threshold:n=.8}={}){const{UnrealBloomPass:s}=await P(()=>import("./UnrealBloomPass.c04d47ea.js"),["assets/UnrealBloomPass.c04d47ea.js","assets/vendor.ad1e55a4.js"]),a=new s(r,e,t,n);return Object.defineProperty(a,"propList",{value:["radius","strength","threshold"],writable:!1}),a}async function ya({renderer:r}){const{SMAAPass:e}=await P(()=>import("./SMAAPass.09cf5e10.js"),["assets/SMAAPass.09cf5e10.js","assets/vendor.ad1e55a4.js"]),t=new Z;r.getSize(t);const n=new e(t.x,t.y);return Object.defineProperty(n,"propList",{value:[],writable:!1}),n}async function va({renderer:r}){const{ShaderPass:e}=await P(()=>import("./vendor.ad1e55a4.js").then(function(a){return a.b8}),[]),{PixelShader:t}=await P(()=>import("./PixelShader.ee1b9117.js"),[]),n=new e(t),s=new Z;return r.getSize(s),s.multiplyScalar(window.devicePixelRatio),n.uniforms.resolution.value=s,ee(n,["pixelSize"]),n.pixelSize=10,n}async function wa({renderer:r}){const{ShaderPass:e}=await P(()=>import("./vendor.ad1e55a4.js").then(function(a){return a.b8}),[]),{SobelOperatorShader:t}=await P(()=>import("./SobelOperatorShader.fe628b46.js"),["assets/SobelOperatorShader.fe628b46.js","assets/vendor.ad1e55a4.js"]),n=new Z;r.getSize(n),n.multiplyScalar(window.devicePixelRatio);const s=new e(t);return s.uniforms.resolution.value.x=n.x,s.uniforms.resolution.value.y=n.y,Object.defineProperty(s,"propList",{value:[],writable:!1}),s}async function ba({renderer:r}){const{HalftonePass:e}=await P(()=>import("./HalftonePass.e12dae40.js"),["assets/HalftonePass.e12dae40.js","assets/vendor.ad1e55a4.js"]),t=new Z;r.getSize(t);const n=new e(t.x,t.y,{radius:4});return ee(n,["greyscale","radius","scatter","shape"]),n}async function xa(){const{DotScreenPass:r}=await P(()=>import("./DotScreenPass.bc13efba.js"),["assets/DotScreenPass.bc13efba.js","assets/vendor.ad1e55a4.js"]),e=new r;return ee(e,["scale","center"]),e}async function Ma({scene:r,camera:e}){const{BokehPass:t}=await P(()=>import("./BokehPass.9167b8ec.js"),["assets/BokehPass.9167b8ec.js","assets/vendor.ad1e55a4.js"]),n=new t(r,e,{});return ee(n,["focus","aperture","aspect"]),n}async function Aa(){const{AfterimagePass:r}=await P(()=>import("./AfterimagePass.f410d149.js"),["assets/AfterimagePass.f410d149.js","assets/vendor.ad1e55a4.js"]),e=new r(.7);return ee(e,["damp"]),e}function Pa(r){var o;const{name:e,type:t}=r,n=(o=$e[t].propList)!=null?o:[],s={};return n.forEach(u=>{Object.defineProperty(s,u,{get(){return r[u]},set(i){r[u]=i},enumerable:!0})}),{target:r,name:e,type:t,params:s,id:Te()}}const $e={bloom:{name:"Bloom",propList:["enabled","radius","strength","threshold"]},pixel:{name:"Pixelate",propList:["enabled","pixelSize"]},afterimage:{name:"Afterimage",propList:["enabled","damp"]},sobel:{name:"Sobel",propList:["enabled"]},halftone:{name:"Halftone",propList:["enabled","greyscale","radius","scatter","shape"]},dotscreen:{name:"Dot Screen",propList:["enabled","scale"]},bokeh:{name:"Bokeh",propList:["enabled","focus","aperture","aspect"]},smaa:{name:"SMAA",propList:["enabled"]}};Object.entries($e).map(([r,{name:e}])=>({value:r,label:e}));const Ta=["video/mp4;codecs=h264","video/webm;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"],Ve=Ta.filter(MediaRecorder.isTypeSupported);function Ea(r){if(!Ve.length)return;const e=[],t=Ve[0],n={settings:{frameRate:30,fileName:"ani",mimeType:t,appendDate:!0},get supportedMimeTypes(){return Ve},get mimeType(){return this.settings.mimeType},set mimeType(s){this.supportedMimeTypes.includes(s)&&(this.settings.mimeType=s)},start(){if(this.recorder)return;const{fileName:s,frameRate:a,mimeType:o}=this.settings,u=r.captureStream(a||30),i=u.getTracks()[0],c=new MediaRecorder(u,{mimeType:o});c.onstart=()=>e.length=0,c.ondataavailable=({data:l})=>e.push(l),c.onstop=()=>{i.stop(),this.recorder=void 0;const l=this.settings.mimeType.includes("webm")?"webm":"mp4",p=new Blob(e,{type:`video/${l}`}),d=this.settings.appendDate?`_${Ks()}`:"",f=`${s||"ani"}${d}.${l}`;at.exports.saveAs(p,f)},c.start(),this.recorder=c},get state(){var s,a;return(a=(s=this.recorder)==null?void 0:s.state)!=null?a:"idle"}};return["pause","resume","stop"].forEach(s=>{Object.defineProperty(n,s,{value:()=>{var a;return(a=n.recorder)==null?void 0:a[s]()}})}),n}function Sa(r){let e=1,t=!1,n=!1;const s=()=>{r.stats.begin(),r.controls.update();const c=t?-e:e,l=r.clock.getDelta()*c;n||r.update(l),r.render(),r.stats.end()};let a=!1;const o=()=>{a||(r.render(),a=!0,setTimeout(()=>a=!1,50))};let u="";return{start(){u!=="active"&&(r.renderer.setAnimationLoop(s),r.controls.removeEventListener("change",o),u="active")},stop(){u!=="inactive"&&(r.renderer.setAnimationLoop(null),r.controls.addEventListener("change",o),u="inactive")},pause(){n=!0},resume(){n=!1},get state(){return u},get timeScale(){return e},set timeScale(c){const l=parseFloat(c);e=isNaN(l)?1:Math.abs(l)},get reverse(){return t},set reverse(c){t=!!c},get paused(){return n},set paused(c){n=!!c}}}function La(r,e){const t=document.createElement("a");t.style.display="none",t.href=r,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}async function Ia(r,e){const t=r.length.toString().length,s=(await P(()=>import("./jszip.min.e05e2f05.js").then(function(a){return a.j}),["assets/jszip.min.e05e2f05.js","assets/vendor.ad1e55a4.js"]).then(a=>a.default))();return r.forEach((a,o)=>{const u=o.toString().padStart(t,"0"),i=`${e||"ss"}_${u}.png`,c="data:image/png;base64,".length;s.file(i,a.slice(c,1/0),{base64:!0})}),s.generateAsync({type:"blob"})}async function Kt(r,e){const t=await Ia(r,e);at.exports.saveAs(t,`${e}.zip`)}function Ca(r){const{canvas:e,scene:t}=r;return{settings:dr,get(s=1){const{noBackground:a,fileName:o}=this.settings,u=a&&!r.postProcessing.enabled;let i;if(r.loop.state==="inactive"||s===1){u&&([t.background,i]=[null,t.background]),r.render();const d=e.toDataURL();u&&(t.background=i),La(d,`${o}.png`),r.render();return}let c=0;const l=[];u&&r.addCountedEventListener("beforeRender",()=>[i,t.background]=[t.background,null]);function p(){const d=e.toDataURL("image/png");l.push(d),++c===s&&(u&&r.addCountedEventListener("beforeRender",()=>[i,t.background]=[null,i]),Kt(l,o))}r.addCountedEventListener("afterRender",p,s)},getAllFrames(s=0){const a=r.loadedModel[s],o=a==null?void 0:a.animation.current.chainName;if(!o||a.animation.chain[o].duration===1/0)return;console.log("main thread locked");const i=r.loop.state;r.loop.stop(),a.animation.stop();const c=[],{frameRate:l,noBackground:p}=this.settings,d=1/(l||30);let f=null,h=!0;for(p&&([t.background,f]=[f,t.background]),a.animation.addCountedEventListener("chainFinished",()=>h=!1),a.animation.play();h;){r.update(d);const g=e.toDataURL();c.push(g)}return console.log("main thread unlocked"),p&&([t.background,f]=[f,t.background]),i==="active"&&r.loop.start(),c},downloadAllFrames(s=0){const{fileName:a}=this.settings,o=this.getAllFrames(s);Kt(o,a)}}}const Da=()=>Promise.all([mr(),gr(),vr(),Lr()]),Yt={directional:Je,ambient:Qe,point:Ae},Zt={directional:es,point:ts},Oa=r=>{var u,i;if(!Yt[r])return null;const o=fr[r],{color:t,intensity:n}=o,s=W(o,["color","intensity"]),a=new Yt[r](t,n);return a.name=(i=(u=a.type)==null?void 0:u.replace)==null?void 0:i.call(u,"Light",""),Zt[r]&&(a.helper=new Zt[r](a),Object.defineProperty(a,"showHelper",{get(){return a.helper.visible},set(c){a.helper.visible=!!c,a.helper.update()}}),a.showHelper=!1),Object.defineProperty(a,"colorCode",{get(){return"#"+this.color.getHexString()},set(c){var l,p;this.color=new I(c),(p=(l=this.helper)==null?void 0:l.update)==null||p.call(l)}}),Object.entries(s).forEach(([c,l])=>{a[c].isVector3?a[c].set(...l):a[c]=l}),a};function ka(r){const e={list:new z,add:t=>{const n=Oa(t);if(!!n)return r.scene.add(n),n.helper&&(r.scene.add(n.helper),n.helper.update()),e.list.push(n),n.remove=()=>{var s,a,o,u,i;e.list.remove(n),n.helper&&((s=n.parent)==null||s.remove(n.helper),(o=(a=n.helper).dispose)==null||o.call(a)),(u=n.parent)==null||u.remove(n),(i=n.dispose)==null||i.call(n)},n}};return e}const _a={mat:{keys:["material","code"],valueMap:r=>r.slice(1,-1)},ol:{keys:["outline","code"],valueMap:r=>r.slice(1,-1)},ei:{keys:["face","eyeBaseIdx"]},et:{keys:["face","eyeTexture"]},mi:{keys:["face","mouthBaseIdx"]},mt:{keys:["face","mouthTexture"]},tx:{keys:["texture"]},scl:{keys:["scale"]}};async function Ra(r){const e=ft(r),t=Object.fromEntries(e),{id:n}=t,s=await this.loadDLModel(n);return await Fa(s,t),s}async function Fa(r,e){const s=e,{ani:t}=s,n=W(s,["ani"]);Object.entries(n).forEach(([a,o])=>{var p;const u=_a[a];if(!u)return;const{keys:i,valueMap:c}=u,l=(p=c==null?void 0:c(o))!=null?p:o;Et(r,i,l)}),t&&await r.animation.addChain(t)}const ze=class{constructor(){R(this,"dataLoaded",!1);R(this,"initData",async()=>{await Da(),this.dataLoaded=!0});R(this,"_background","");R(this,"model",new z);R(this,"loadedModel",new z);R(this,"loadModelFromCode",Ra);R(this,"settings",{outline:q,material:N});R(this,"viewport",{width:0,height:0,set(e,t){this.width=e,this.height=t}});Object.assign(this,Q);const e=new ns;this.scene=e,this.background=lr,this.clock=new ss;const t=Ws();this.camera=t;const n=ka(this);this.light=n,n.add("directional"),n.add("ambient");const s=zs();this.renderer=s,this.canvas=s.domElement,this.screenshot=Ca(this),this.record=Ea(this.canvas),this.controls=new rs(this.camera,this.canvas);const a=this.renderer.capabilities.isWebGL2?"MSAA":"SMAA";this.postProcessing={enabled:!1,passes:new z,composer:qt({antialias:a,renderer:s,scene:e,camera:t}),async addPass(o,u={}){const i=await ma(o,U(b({},u),{renderer:s,scene:e,camera:t}));this.composer.addPass(i);const c=Pa(i),{passes:l}=this,p=this;return c.remove=()=>{l.remove(c),p.refresh()},l.push(c),i},async refresh(){this.composer=qt({antialias:a,renderer:s,scene:e,camera:t});const o=this.passes.map(({type:i,params:c})=>({type:i,params:Object.entries(c)}));this.passes.length=0;const{length:u}=o;for(let i=0;i<u;i++){const{type:c,params:l}=o[i],p=await this.addPass(c);l.forEach(([d,f])=>void(p[d]=f))}},updatePasses(o){this.passes.length=0,this.passes.splice(0,0,...o),this.refresh()}},this.stats=new as,this.loop=Sa(this),this.loop.start(),console.log("%cDragalia Lost Model Viewer","color:yellow;background-color:black;font-size:1.5rem;text-shadow: 0 0 0.5rem white")}get background(){return this._background}set background(e){var n,s;if(this._background===e)return;this._background="loading",(s=(n=this.scene.background)==null?void 0:n.dispose)==null||s.call(n);const t=this;(async function(){t.scene.background=await Gs(e),t._background=e,e.startsWith("img:")&&t.updateBgAspectRatio()})()}get toneMapping(){var t,n;const{toneMapping:e}=this.renderer;return(n=(t=Object.entries(Re).find(([,s])=>s===e))==null?void 0:t[0])!=null?n:"Unknown"}set toneMapping(e){const t=Re[e]?e:"No Mapping";this.renderer.toneMapping=Re[t]}get pixelRatio(){return this.renderer.getPixelRatio()}set pixelRatio(e){this.renderer.setPixelRatio(e),this.postProcessing.composer.setPixelRatio(e)}get unusedModel(){return this.loadedModel.filter(e=>!this.model.includes(e))}async loadDLModel(e=pr){this.dataLoaded||await this.initData();const t=ze.getModelPath(e),n=await Pt(t);n.name=e;const s={id:e,outline:this.settings.outline,material:this.settings.material,viewer:this},a=fa(n,s);return this.loadedModel.push(a),a.addEventListener("dispose",()=>this.loadedModel.remove(a)),a}add(e){e.detach(),this.model.push(e),this.scene.add(e.model),e.parent=this}remove(e){this.model.remove(e),this.scene.remove(e.model)}disposeAllModels(){this.loadedModel.forEach(e=>{var t;return(t=e.dispose)==null?void 0:t.call(e)}),this.model.length=0}static getModelPath(e){return`${this.source.fbx}/${e}/${e}.fbx`}async setViewport(e,t){var o;await Vs(200);const n=e!=null?e:window.innerWidth,s=t!=null?t:window.innerHeight;this.viewport.set(n,s),this.renderer.setSize(n,s);const a=n/s;return this.camera.aspect=a,this.camera.updateProjectionMatrix(),(o=this.postProcessing.composer)==null||o.setSize(n,s),this.background.startsWith("img:")&&this.updateBgAspectRatio(),this}updateBgAspectRatio(){if(!this.background.startsWith("img:"))return;const{width:e,height:t}=this.viewport,n=e/t,{background:s}=this.scene,{naturalWidth:a,naturalHeight:o}=s.image,u=a/o,i=n/u,c=n>u?[1,1/i]:[i,1];s.repeat.set(...c)}update(e){var t;(t=this.animation)==null||t.update(e),this.model.forEach(n=>{var s;return(s=n.update)==null?void 0:s.call(n,e)}),this.loop.state==="inactive"&&this.render()}stopAll(){this.model.forEach(e=>{var t,n;return(n=(t=e.animation)==null?void 0:t.stop)==null?void 0:n.call(t)})}playAll(){this.model.forEach(e=>{var t,n;return(n=(t=e.animation)==null?void 0:t.play)==null?void 0:n.call(t)})}render(){this.dispatchEvent({type:"beforeRender"}),this.postProcessing.enabled?this.postProcessing.composer.render():this.renderer.render(this.scene,this.camera),this.dispatchEvent({type:"afterRender"})}toString(){return"Dragalia Lost Model Viewer"}dispose(){var e,t,n;this.model.forEach(s=>s.dispose()),(t=(e=this.scene.background)==null?void 0:e.dispose)==null||t.call(e),(n=this.renderer.renderLists)==null||n.dispose(),this.renderer.dispose()}};let ge=ze;R(ge,"source",{fbx:mt,ani:gt});const S=new ge;S.initData();S.setViewport();window.addEventListener("resize",()=>S.setViewport());S.canvas.addEventListener("dblclick",Ba);window.viewer=S;window.model=S.model;function Ba(){if(!!ce.fullscreenEnabled){if(!ce.fullscreenElement){ce.requestFullscreen(S.canvas);return}ce.exitFullscreen()}}function ja(){try{return window.self!==window.top}catch(r){return!0}}let Jt="";const Qt=ja(),$a=Qt?!1:!window.location.hash.includes("showSettings=false"),Va=Qt?!1:!window.location.hash.includes("showAC=false"),Ua=r=>({showSettings:$a,toggleSettings:()=>r(e=>void(e.showSettings=!e.showSettings)),loadingMsg:"",setLoadingMsg:e=>r(t=>void(t.loadingMsg=e)),showTimeControl:Va,toggleTimeControl:()=>r(e=>void(e.showTimeControl=!e.showTimeControl)),showFrameRate:!1,toggleFrameRate:()=>r(e=>void(e.showFrameRate=!e.showFrameRate)),sidebar:{open:!0,toggle:()=>r(({sidebar:e})=>void(e.open=!e.open)),chainMaker:!1,toggleChainMaker:()=>r(({sidebar:e})=>void(e.chainMaker=!e.chainMaker)),settings:{tab:"Model",setTab:e=>r(({sidebar:t})=>void(t.settings.tab=e))},modal:{mode:"",handleSelect:void 0,open:(e,t)=>{Jt=S.loop.state,S.loop.stop(),r(({sidebar:n})=>{const{modal:s}=n;s.mode=e,s.handleSelect=t})},close:()=>{Jt==="active"&&S.loop.start(),r(({sidebar:e})=>{const{modal:t}=e;t.mode="",t.handleSelect=void 0})}}},dock:{mode:"",handleSelect:void 0,open:(e="",t)=>r(({dock:n})=>{n.mode=e,n.handleSelect=t}),close:()=>r(({dock:e})=>{e.mode="",e.handleSelect=void 0})}}),Na=B(()=>P(()=>import("./index.3ce1551c.js"),["assets/index.3ce1551c.js","assets/vendor.ad1e55a4.js","assets/TabBar.4e16654d.js","assets/ButtonBase.3daa2b57.js","assets/Popover.98338255.js","assets/ColorPicker.ce03c04c.js","assets/ColorPicker.108f083b.css","assets/ColorButton.584e0d43.js","assets/Button.ef579d6c.js","assets/useAppData.4b40d8a4.js","assets/Gallery.3c6c2396.js","assets/Box.3f20a555.js","assets/DialogContext.fe2532f4.js","assets/DialogTitle.0c03aa8c.js"])),za=B(()=>P(()=>import("./index.8e6bb3cf.js"),["assets/index.8e6bb3cf.js","assets/vendor.ad1e55a4.js","assets/lists.146068f1.js","assets/ButtonBase.3daa2b57.js","assets/Popover.98338255.js","assets/useAppData.4b40d8a4.js","assets/Close.7c73f26e.js","assets/filterConfig.090b15f5.js","assets/filterConfig.b279bade.css","assets/MenuItem.de2d2857.js","assets/DialogTitle.0c03aa8c.js","assets/DialogContext.fe2532f4.js","assets/Box.3f20a555.js","assets/ToggleGroup.f843ecbd.js","assets/ToggleGroup.92c4548b.css","assets/GlowToggle.4c7bcf1f.js","assets/GlowToggle.ada43627.css","assets/Gallery.3c6c2396.js","assets/styles.3a863f45.js","assets/styles.a7d845f9.css","assets/LoadSpinner.289af2f7.js","assets/LoadSpinner.7cf5bf1b.css","assets/index.2f8464d2.js","assets/categories.aa5162d2.js"])),Wa=B(()=>P(()=>import("./index.66838c3c.js"),["assets/index.66838c3c.js","assets/index.48b9abd7.css","assets/vendor.ad1e55a4.js","assets/lists.146068f1.js","assets/ButtonBase.3daa2b57.js","assets/Popover.98338255.js","assets/useAppData.4b40d8a4.js","assets/Close.7c73f26e.js","assets/TabBar.4e16654d.js","assets/Button.ef579d6c.js","assets/LoadSpinner.289af2f7.js","assets/LoadSpinner.7cf5bf1b.css","assets/ModelIcon.6370c8f6.js","assets/Gallery.3c6c2396.js","assets/Box.3f20a555.js","assets/DialogContext.fe2532f4.js","assets/aniFunction.71538382.js","assets/Selector.6a378373.js","assets/Selector.4835a2b1.css","assets/GlowToggle.4c7bcf1f.js","assets/GlowToggle.ada43627.css","assets/DialogTitle.0c03aa8c.js"])),Ga=B(()=>P(()=>import("./index.18770cb5.js"),["assets/index.18770cb5.js","assets/index.3a29f120.css","assets/vendor.ad1e55a4.js","assets/lists.146068f1.js","assets/ButtonBase.3daa2b57.js","assets/Popover.98338255.js","assets/useAppData.4b40d8a4.js","assets/Close.7c73f26e.js","assets/filterConfig.090b15f5.js","assets/filterConfig.b279bade.css","assets/MenuItem.de2d2857.js","assets/DialogTitle.0c03aa8c.js","assets/DialogContext.fe2532f4.js","assets/Box.3f20a555.js","assets/ToggleGroup.f843ecbd.js","assets/ToggleGroup.92c4548b.css","assets/GlowToggle.4c7bcf1f.js","assets/GlowToggle.ada43627.css","assets/index.2f8464d2.js","assets/Gallery.3c6c2396.js","assets/useToggleState.264949a5.js","assets/LoadSpinner.289af2f7.js","assets/LoadSpinner.7cf5bf1b.css","assets/ModelIcon.6370c8f6.js"])),Xa=B(()=>P(()=>import("./ColorSelect.60fd9f05.js"),["assets/ColorSelect.60fd9f05.js","assets/vendor.ad1e55a4.js","assets/ColorPicker.ce03c04c.js","assets/ColorPicker.108f083b.css","assets/ColorButton.584e0d43.js","assets/Button.ef579d6c.js","assets/ButtonBase.3daa2b57.js","assets/DialogTitle.0c03aa8c.js","assets/DialogContext.fe2532f4.js"])),Ha=B(()=>P(()=>import("./index.b60b1be4.js"),["assets/index.b60b1be4.js","assets/index.be44ea3e.css","assets/vendor.ad1e55a4.js","assets/useKey.2e9644fd.js","assets/FacePartSelector.1c244aa8.js","assets/Selector.6a378373.js","assets/Selector.4835a2b1.css","assets/GlowToggle.4c7bcf1f.js","assets/GlowToggle.ada43627.css","assets/getTexturePath.9855e123.js","assets/MeshMouthSelect.b2d1a172.js","assets/MeshMouthSelect.cfd3c0f0.css","assets/Box.3f20a555.js","assets/ButtonBase.3daa2b57.js","assets/DialogContext.fe2532f4.js","assets/Button.ef579d6c.js","assets/DialogTitle.0c03aa8c.js"])),qa=B(()=>P(()=>import("./index.6b6aea10.js"),["assets/index.6b6aea10.js","assets/vendor.ad1e55a4.js","assets/useToggleState.264949a5.js","assets/lists.146068f1.js","assets/ButtonBase.3daa2b57.js","assets/Popover.98338255.js","assets/useAppData.4b40d8a4.js","assets/Close.7c73f26e.js","assets/FacePartSelector.1c244aa8.js","assets/Selector.6a378373.js","assets/Selector.4835a2b1.css","assets/GlowToggle.4c7bcf1f.js","assets/GlowToggle.ada43627.css","assets/filterConfig.090b15f5.js","assets/filterConfig.b279bade.css","assets/MenuItem.de2d2857.js","assets/DialogTitle.0c03aa8c.js","assets/DialogContext.fe2532f4.js","assets/Box.3f20a555.js","assets/ToggleGroup.f843ecbd.js","assets/ToggleGroup.92c4548b.css","assets/Gallery.3c6c2396.js","assets/styles.3a863f45.js","assets/styles.a7d845f9.css","assets/LoadSpinner.289af2f7.js","assets/LoadSpinner.7cf5bf1b.css","assets/categories.aa5162d2.js"])),en=B(()=>P(()=>import("./index.b32d711f.js"),["assets/index.b32d711f.js","assets/index.0a4d2222.css","assets/vendor.ad1e55a4.js","assets/getTexturePath.9855e123.js","assets/MeshMouthSelect.b2d1a172.js","assets/MeshMouthSelect.cfd3c0f0.css","assets/Box.3f20a555.js","assets/ButtonBase.3daa2b57.js","assets/DialogContext.fe2532f4.js","assets/Button.ef579d6c.js","assets/DialogTitle.0c03aa8c.js"])),tn={background:Na,model:za,animation:Wa,weapon:Ga,color:Xa,face:Ha,faceTexture:qa,eye:({onSelect:r})=>k(en,{part:"eye",onSelect:r}),mouth:({onSelect:r})=>k(en,{part:"mouth",onSelect:r})},Ka=(r,e)=>({Component:void 0,props:void 0,openModal:(t,n)=>r(s=>{s.props=n,s.Component=t}),close:()=>r(t=>t.Component=void 0),onClose:void 0,reset:()=>r(t=>{t.Component=t.props=t.onClose=void 0}),getInput:async t=>{if(!tn[t])return null;const{close:n,reset:s}=e(),a=new Promise((o,u)=>{const i=(...c)=>o(c);r(c=>{c.onClose=()=>{u(),n()},c.props={onSelect:i,onAfterSelect:n},c.Component=tn[t]})});try{return await a}catch{return null}finally{s()}},inputModel:()=>e().getInput("model"),inputAni:()=>e().getInput("animation"),inputColor:async()=>{const t=await e().getInput("color");return t==null?void 0:t[0]},inputEye:()=>e().getInput("eye"),inputMouth:()=>e().getInput("mouth")}),Ya=r=>({activeModel:void 0,setActiveModel:e=>r({activeModel:e})}),Za=r=>(e,t,n)=>r(s=>e(is(s)),t,n),te=r=>it(Za(r)),Ue=te(Ua),bi=it(Ya),xi=te(ht),Mi=te(ht),Ja=te(bs),Ai=te(Ka),Qa="cccccc",ei="c100001_01",nn=(r,e="Unknown")=>{const t=Gt(r),{length:n}=t,s=t.map((a,o)=>{const{aniName:u,reps:i=1,timeScale:c=1,duration:l=[0,100],aniAction:p}=a,d=n>1?e+` #${o+1}`:e;return{id:Te(),name:d,aniName:u,reps:i,timeScale:c,duration:l,aniAction:p}});return z.from(s)},sn={ts:{key:"timeScale",defaultValue:1},r:{key:"reps",defaultValue:1}},ti={"face.eyeIdx":"ei","face.mouthIdx":"mi"},Pi=r=>r.map(ni).join(">"),ni=r=>{const{aniName:e}=r,t=si(r),n=ri(r),s=ai(r);return`${e}${t}${n}${s}`},si=r=>{const e=[];return Object.keys(sn).forEach(t=>{const{key:n,defaultValue:s}=sn[t];r[n]&&r[n]!==s&&e.push(`&${t}=${r[n]}`)}),e.join("")},ri=r=>{const{duration:e=[0,100]}=r,[t,n]=e;return t!==0?`&dur=${t}-${n}`:n===100?"":`&dur=${n}`},ai=r=>{const{aniAction:e}=r;if(!e.length)return"";const t=e.map(n=>{const u=n,{time:s}=u,a=W(u,["time"]),o=Object.entries(a).map(([i,c])=>{var l;return`${(l=ti[i])!=null?l:i}=${c}`});return`@${s}=(${o.join("/")})`});return"&"+t.join("&")};function Ne(){const{hash:r}=window.location,e=ft(r),t=Object.fromEntries(e);ii(t),oi(r)}function ii(r){const{bg:e=Qa,showAC:t="true",showSettings:n="true"}=r;S.background=e,Ue.setState({showTimeControl:pt(t)}),Ue.setState({showSettings:pt(n)})}async function oi(r){S.disposeAllModels();const e=decodeURI(r);setTimeout(async()=>{var o;const t=e.includes("id=")?e:e+`/id=${ei}`,n=await S.loadModelFromCode(t);S.add(n),Ja.getState().setCategory(n.type==="adventurer"?"Adventurer":"Personal");const{id:s}=n;if(!e.includes("camPos=")){const u=yr(s);S.camera.position.set(...u)}const a=wr(s);if(S.controls.target.set(...a),e.includes("ani=")){const u=(o=n.animation.current.chainCode)!=null?o:"";u&&(n.userData.chain=nn(u,"init"))}else{const u=vs(s);if(u){const{code:i,name:c}=u;n.animation.addChain(i),n.userData.chain=nn(i,c)}}})}const ci=()=>{const r=Ee(!0);return Se(()=>{r.current=!1},[]),r.current},li=B(()=>P(()=>import("./index.3dd1e9a0.js"),["assets/index.3dd1e9a0.js","assets/index.12481a16.css","assets/vendor.ad1e55a4.js","assets/ButtonBase.3daa2b57.js","assets/Popover.98338255.js","assets/Close.7c73f26e.js","assets/Box.3f20a555.js","assets/DialogContext.fe2532f4.js","assets/LoadSpinner.289af2f7.js","assets/LoadSpinner.7cf5bf1b.css","assets/categories.aa5162d2.js","assets/useKey.2e9644fd.js","assets/ModelIcon.6370c8f6.js","assets/useToggleState.264949a5.js","assets/MenuItem.de2d2857.js","assets/useAppData.4b40d8a4.js","assets/ColorButton.584e0d43.js","assets/Button.ef579d6c.js","assets/ToggleGroup.f843ecbd.js","assets/ToggleGroup.92c4548b.css","assets/GlowToggle.4c7bcf1f.js","assets/GlowToggle.ada43627.css","assets/TabBar.4e16654d.js","assets/PlayArrow.be77f98c.js","assets/getTexturePath.9855e123.js","assets/aniFunction.71538382.js"])),ui=B(()=>P(()=>import("./index.5672d1b9.js"),["assets/index.5672d1b9.js","assets/index.691abef7.css","assets/vendor.ad1e55a4.js","assets/useToggleState.264949a5.js","assets/GlowToggle.4c7bcf1f.js","assets/GlowToggle.ada43627.css","assets/Popover.98338255.js","assets/ButtonBase.3daa2b57.js","assets/MenuItem.de2d2857.js","assets/Button.ef579d6c.js","assets/PlayArrow.be77f98c.js","assets/Close.7c73f26e.js"]));function pi(){const r=ci(),e=Ee(),t=Ee(),{loadingMsg:n,showTimeControl:s,showSettings:a,showFrameRate:o}=Ue();return Se(()=>(r&&ys().then(Ne),window.addEventListener("hashchange",Ne),()=>window.removeEventListener("hashchange",Ne))),Se(()=>{var u,i;(u=e.current)==null||u.appendChild(S.canvas),S.stats.dom.style.position="",(i=t.current)==null||i.appendChild(S.stats.dom)},[]),k(os,null,a&&k(ot,{fallback:null},k(li,null)),k("div",{className:"mount",ref:u=>e.current=u}),k("div",{className:"stats",style:{display:o?"unset":"none"},ref:u=>t.current=u}),n&&k("div",{className:"loading-msg"},n),s&&k(ot,{fallback:null},k(ui,null)))}cs(k(pi,null),document.getElementById("app"));export{z as A,vi as B,Mi as C,yi as D,mt as F,ur as P,P as _,Ai as a,bi as b,nn as c,tn as d,yr as e,wr as f,vs as g,Ja as h,xi as i,Ia as j,Pi as k,fs as l,ys as m,hi as n,wi as o,$e as p,ci as q,ut as r,le as s,Re as t,Ue as u,S as v,jt as w,gi as x,ms as y,mi as z};
